<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>ECU FORGE X ‚Äî Generar BIN.MOD</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4;color:#111}
  header{background:#0b1220;color:#fff;padding:14px 18px;font-size:22px;font-weight:bold}
  .container{display:grid;grid-template-columns:340px 1fr;gap:20px;padding:20px}
  .panel,.panel-large{background:#fff;padding:18px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .panel h3,.panel-large h3{margin:0 0 12px}
  input,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin:0 0 10px}
  button{background:#0066ff;color:#fff;border:none;cursor:pointer}
  button:hover{background:#004bcc}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .log{background:#000;color:#00ff72;font-family:monospace;height:180px;border-radius:8px;padding:12px;overflow:auto}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .muted{color:#666;font-size:13px}
  .badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef;color:#225}
</style>
</head>
<body>

<header>ECU FORGE X</header>

<div class="container">
  <!-- IZQUIERDA -->
  <div class="panel">
    <h3>Informaci√≥n del Veh√≠culo</h3>
    <input id="marca" placeholder="Marca (ej: BMW)" />
    <input id="modelo" placeholder="Modelo (ej: 320i)" />
    <div class="row">
      <input id="anio" placeholder="A√±o (ej: 2018)" />
      <input id="motor" placeholder="Motor (ej: B48 2.0T)" />
    </div>
    <input id="ecu_type" placeholder="Tipo ECU (ej: Bosch MG1)" />

    <h3 style="margin-top:16px">Archivo BIN</h3>
    <input id="binfile" type="file" />
    <button id="btnAnalizar">Analizar BIN</button>
    <div class="muted">Formatos: .bin, .mpc, .org, .e2p, .101</div>
  </div>

  <!-- DERECHA -->
  <div class="panel-large">
    <div class="grid2">
      <div>
        <h3>Parches Disponibles <span id="ecuInfo" class="badge" style="display:none"></span></h3>
        <select id="patchSelect" disabled>
          <option value="">‚Äî Sube tu BIN para ver opciones ‚Äî</option>
        </select>
        <button id="btnAplicar" disabled>Aplicar / Comprar</button>
        <div id="noPatchMsg" class="muted" style="display:none;margin-top:8px">
          No hay parches disponibles para esta ECU. <br/>
          Dentro de m√°ximo <b>36 horas</b> podemos generar una soluci√≥n personalizada.
          <button id="btn36h" style="margin-top:8px">Solicitar soluci√≥n (36h)</button>
        </div>
      </div>
      <div>
        <h3>Resultado</h3>
        <div id="resultado" class="muted">A√∫n no se ha generado ning√∫n archivo.</div>
      </div>
    </div>

    <h3 style="margin-top:16px">Log</h3>
    <div id="log" class="log">Esperando acciones‚Ä¶</div>
  </div>
</div>

<!-- MODAL LOGIN sencillo -->
<div id="modalLogin" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center">
  <div style="background:#fff;padding:18px;border-radius:10px;width:340px;box-shadow:0 8px 30px rgba(0,0,0,.25)">
    <h3>Iniciar sesi√≥n</h3>
    <input id="login_email" placeholder="Email" />
    <input id="login_pass" type="password" placeholder="Contrase√±a" />
    <button id="btnLogin">Ingresar</button>
    <button id="btnCloseLogin" style="background:#666;margin-top:8px">Cerrar</button>
  </div>
</div>

<script>
let TOKEN=null, lastAnalysis=null;

const $ = (q,el=document)=>el.querySelector(q);
const log = (m)=>{ const box=$("#log"); box.textContent += "\\n"+m; box.scrollTop=box.scrollHeight; };

$("#btnAnalizar").onclick = async ()=>{
  const file = $("#binfile").files[0];
  if(!file){ alert("Selecciona un BIN"); return; }
  const fd = new FormData(); fd.append("bin_file", file);
  log("Subiendo y analizando BIN‚Ä¶");
  const r = await fetch("/analyze_bin",{ method:"POST", body:fd });
  if(!r.ok){ log("Error analizando BIN"); return; }
  const data = await r.json();
  lastAnalysis = data;
  log("An√°lisis OK. ECU: "+data.ecu_type+" PN: "+data.ecu_part_number);

  // UI ecu info
  const ecuInfo=$("#ecuInfo");
  ecuInfo.style.display="inline-block";
  ecuInfo.textContent = data.ecu_type || "ECU";

  // Llenar dropdown
  const sel=$("#patchSelect");
  sel.innerHTML="";
  if((data.available_patches||[]).length){
    sel.disabled=false; $("#btnAplicar").disabled=false;
    $("#noPatchMsg").style.display="none";
    sel.append(new Option("‚Äî Selecciona un parche ‚Äî",""));
    data.available_patches.forEach(p=>sel.append(new Option(p.label, p.id)));
  }else{
    sel.disabled=true; $("#btnAplicar").disabled=true;
    $("#noPatchMsg").style.display="block";
    sel.append(new Option("Sin parches disponibles",""));
  }
};

$("#btnAplicar").onclick = async ()=>{
  const patch = $("#patchSelect").value;
  if(!patch){ alert("Selecciona un parche"); return; }
  if(!TOKEN){ openLogin(); return; }

  // Crear orden
  const r = await fetch("/orders",{
    method:"POST",
    headers:{ "Authorization":"Bearer "+TOKEN, "Content-Type":"application/json" },
    body: JSON.stringify({ analysis_id: lastAnalysis.analysis_id, patch_option_id: patch })
  });
  if(!r.ok){ log("Error creando orden"); return; }
  const d = await r.json();
  log("Orden creada #"+d.id+". Redirigiendo a checkout‚Ä¶");
  location.href = "/static/checkout.html?order_id="+d.id;
};

$("#btn36h").onclick = async ()=>{
  if(!lastAnalysis){ alert("Primero analiza un BIN"); return; }
  if(!TOKEN){ openLogin(); return; }

  await fetch("/patch_requests",{
    method:"POST",
    headers:{ "Authorization":"Bearer "+TOKEN, "Content-Type":"application/json" },
    body: JSON.stringify({
      marca: $("#marca").value, modelo: $("#modelo").value, anio: $("#anio").value, motor: $("#motor").value,
      ecu_type: $("#ecu_type").value,
      analysis_id: lastAnalysis?.analysis_id, original_filename: lastAnalysis?.filename
    })
  });
  log("Solicitud 36h enviada. Te contactaremos üëå");
  alert("Solicitud enviada. M√°ximo 36h üëç");
};

function openLogin(){ $("#modalLogin").style.display="flex"; }
function closeLogin(){ $("#modalLogin").style.display="none"; }
$("#btnCloseLogin").onclick=closeLogin;

$("#btnLogin").onclick = async ()=>{
  const fd = new FormData();
  fd.append("username", $("#login_email").value);
  fd.append("password", $("#login_pass").value);
  const r = await fetch("/auth/login",{ method:"POST", body:fd });
  if(!r.ok){ alert("Email o contrase√±a inv√°lidos"); return; }
  const d = await r.json(); TOKEN=d.access_token; closeLogin(); log("Sesi√≥n iniciada.");
};
</script>
</body>
</html>
