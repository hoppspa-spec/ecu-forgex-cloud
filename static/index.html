<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ECU Forge X ‚Äî Diagn√≥stico y Parches</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#ffffff;
  --ink:#2b2b2b;
  --muted:#555;
  --border:#d0d0d0;
  --accent:#004aad;
  --accent-soft:#e7f0ff;
  --radius:10px;
  font-family:'Inter',system-ui,Arial;
}
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:'Inter',sans-serif;
}
main{
  display:grid;
  grid-template-columns:1.2fr 1.5fr 1.2fr;
  gap:12px;
  padding:12px;
}
section{
  border:2px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  background:white;
  box-shadow:0 1px 4px rgba(0,0,0,0.04);
}
h2{margin-top:0;color:var(--accent);font-weight:600;font-size:1.1rem;}
label{display:block;margin-top:8px;font-weight:500;font-size:.9rem;}
input,select,button{
  width:100%;padding:8px 10px;margin-top:4px;
  border:1px solid var(--border);border-radius:var(--radius);
  font-family:inherit;font-size:.9rem;
}
button{
  background:var(--accent);color:white;cursor:pointer;
  border:none;font-weight:600;margin-top:10px;
}
button:hover{background:#0056c2;}
ul.patch-list{list-style:none;padding:0;margin:0;}
ul.patch-list li{
  padding:10px;border:1px solid var(--border);
  border-radius:var(--radius);margin-bottom:8px;
  transition:background .2s;
}
ul.patch-list li.active{background:var(--accent-soft);border-color:var(--accent);}
.ecu-info p{margin:6px 0;font-size:.9rem;color:var(--muted);}
</style>
</head>
<body>

<main>
  <section id="upload">
    <h2>üìÇ An√°lisis de BIN</h2>
    <label>Marca</label>
    <select id="selBrand"></select>
    <label>Modelo</label>
    <select id="selModel"></select>
    <label>A√±o</label>
    <select id="selYear"></select>
    <label>Archivo BIN</label>
    <input type="file" id="binFile" accept=".bin">
    <button id="analyzeBtn">Analizar BIN</button>
    <div id="analysisStatus" style="margin-top:10px;font-size:.9rem;color:var(--muted);"></div>
  </section>

  <section id="ecuInfo">
    <h2>‚öôÔ∏è ECU Info</h2>
    <div class="ecu-info" id="ecuInfoBox">
      <p>Esperando an√°lisis...</p>
    </div>
  </section>

  <section id="patches">
    <h2>üß© Parches Disponibles</h2>
    <ul class="patch-list" id="patchList"><li>Sin datos</li></ul>
  </section>
</main>

<script>
async function loadVehiclesDb(){
  const r = await fetch("/static/data/vehicles.json").catch(()=>null);
  if(!r?.ok) return {brands:{}};
  return await r.json();
}

function fillBrandSelect(db){
  const sel=document.getElementById("selBrand");
  sel.innerHTML='<option value="">‚Äî Selecciona ‚Äî</option>';
  for(const [k,v] of Object.entries(db.brands||{})){
    const opt=document.createElement("option");
    opt.value=k;opt.textContent=v.label;
    sel.appendChild(opt);
  }
}

function fillModelSelect(db){
  const b=document.getElementById("selBrand").value;
  const m=document.getElementById("selModel");
  m.innerHTML='<option value="">‚Äî Selecciona ‚Äî</option>';
  if(!b) return;
  const brand=db.brands[b];
  for(const [k,v] of Object.entries(brand.models||{})){
    const o=document.createElement("option");
    o.value=k;o.textContent=v.label;m.appendChild(o);
  }
}

function fillYearSelect(db){
  const b=document.getElementById("selBrand").value;
  const model=document.getElementById("selModel").value;
  const y=document.getElementById("selYear");
  y.innerHTML='<option value="">‚Äî Selecciona ‚Äî</option>';
  if(!b||!model)return;
  const years=db.brands[b].models[model].years;
  for(const k of Object.keys(years)){
    const o=document.createElement("option");
    o.value=k;o.textContent=k;y.appendChild(o);
  }
}

async function analyzeBIN(){
  const brand=document.getElementById("selBrand").value;
  const model=document.getElementById("selModel").value;
  const year=document.getElementById("selYear").value;
  const ecuMeta=window.VEH_DB.brands?.[brand]?.models?.[model]?.years?.[year];
  document.getElementById("analysisStatus").textContent="Analizando archivo...";
  await new Promise(r=>setTimeout(r,1500));
  const ecu=ecuMeta?.ecu_families?.[0]||"Desconocida";
  document.getElementById("ecuInfoBox").innerHTML=`
    <p><strong>ECU Type:</strong> ${ecu}</p>
    <p><strong>Motor:</strong> ${ecuMeta?.engine||"‚Äî"}</p>
  `;
  loadPatches(ecu, ecuMeta?.engine);
}

async function loadPatches(ecuFamily, engine){
  const r = await fetch("/static/patches/global.json").catch(()=>null);
  const list=document.getElementById("patchList");
  list.innerHTML="";
  if(!r?.ok){list.innerHTML="<li>Error cargando cat√°logo</li>";return;}
  const db=await r.json();
  const patches=db.patches.filter(p=>{
    const ecuOk=!ecuFamily||p.compatible_ecu?.includes(ecuFamily);
    const engOk=!engine||p.engines?.includes(engine);
    return ecuOk && engOk;
  });
  if(!patches.length){list.innerHTML="<li>No hay parches disponibles</li>";return;}
  for(const p of patches){
    const li=document.createElement("li");
    li.textContent=`${p.label} ‚Äî $${p.price?.USD||0} USD`;
    li.classList.add("active");
    list.appendChild(li);
  }
}

document.addEventListener("DOMContentLoaded", async ()=>{
  const db=await loadVehiclesDb();
  window.VEH_DB=db;
  fillBrandSelect(db);
  selBrand.onchange=()=>fillModelSelect(db);
  selModel.onchange=()=>fillYearSelect(db);
  document.getElementById("analyzeBtn").onclick=analyzeBIN;
});
</script>
</body>
</html>
