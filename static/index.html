<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ECU FORGE X — Generar BIN.M0D</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            color: #111;
        }

        header {
            background: #0b1220;
            color: white;
            padding: 16px;
            font-size: 28px;
            font-weight: bold;
        }

        .container {
            display: flex;
            gap: 25px;
            padding: 25px;
        }

        /* Sidebar izquierda */
        .sidebar {
            width: 320px;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 8px rgba(0,0,0,0.15);
        }

        .sidebar h3 {
            margin-top: 0;
        }

        .sidebar label {
            font-weight: bold;
            display: block;
            margin-top: 15px;
        }

        .sidebar input, .sidebar select {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        /* Sección principal */
        .main-panel {
            flex: 1;
        }

        .card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 0 8px rgba(0,0,0,0.15);
            margin-bottom: 20px;
        }

        /* Log */
        #frontend-log {
            background: #000;
            color: #0f0;
            height: 180px;
            overflow-y: auto;
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }

        .patch-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 12px;
        }

        .patch-item {
            padding: 12px;
            border-radius: 8px;
            background: #f0f0f0;
            border: 1px solid #bbb;
            cursor: pointer;
        }

        button {
            background: #2563eb;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            margin-top: 15px;
        }

        button:hover {
            background: #1d4ed8;
        }
    </style>
</head>

<body>
<header>ECU FORGE X</header>

<div class="container">

    <!-- =========================
         SIDEBAR IZQUIERDA
    ========================== -->
    <div class="sidebar">
        <h3>Información del Vehículo</h3>

        <label>Marca</label>
        <input id="marca" placeholder="Ej: BMW">

        <label>Modelo</label>
        <input id="modelo" placeholder="Ej: 320i">

        <label>Año</label>
        <input id="anio" placeholder="Ej: 2018">

        <label>Motor</label>
        <input id="motor" placeholder="Ej: B48 2.0T">

        <label>ECU Type</label>
        <input id="ecu_type" placeholder="Ej: Bosch MG1">

        <hr style="margin-top:20px;">

        <label>Archivo BIN</label>
        <input type="file" id="binFile" accept=".bin">

        <button id="analyzeBtn">Analizar BIN</button>
    </div>


    <!-- =========================
         PANEL PRINCIPAL
    ========================== -->
    <div class="main-panel">

        <!-- PATCHES DISPONIBLES -->
        <div class="card">
            <h2>Parches Disponibles</h2>
            <p>Sube tu BIN y selecciona el parche.</p>

            <div id="patchList" class="patch-grid">
                <!-- JS Insertará acá las opciones -->
            </div>

            <div id="noPatchMsg" style="display:none; margin-top:20px; padding:12px; background:#fee; border-left:4px solid #d00;">
                <b>No hay parche disponible para esta ECU.</b><br>
                ¿Quieres que te generemos uno dentro de 36 horas?<br><br>
                <button id="solicitarParcheBtn" style="background:#d00;">Solicitar parche 36h</button>
            </div>
        </div>

        <!-- RESULTADO -->
        <div class="card">
            <h2>Resultado</h2>
            <p id="resultText">Aún no se ha generado ningún archivo.</p>
        </div>

        <!-- LOG FRONTEND -->
        <div class="card">
            <h2>Log</h2>
            <div id="frontend-log">Esperando acciones…</div>
        </div>

    </div>

</div>

<!-- =========================
     JAVASCRIPT
========================= -->
<script type="module">
    import { apiAnalyzeBin } from "./js/api.js";
    import { $, log, setBusy } from "./js/ui.js";

    const analyzeBtn = $("#analyzeBtn");
    const patchList = $("#patchList");
    const logBox = $("#frontend-log");
    const noPatchMsg = $("#noPatchMsg");

    analyzeBtn.addEventListener("click", async () => {

        const file = $("#binFile").files[0];
        if (!file) {
            log(logBox, "No seleccionaste archivo BIN.");
            return;
        }

        log(logBox, "Analizando BIN…");

        const backendResult = await apiAnalyzeBin(file);

        if (!backendResult) {
            log(logBox, "Error al contactar backend.");
            return;
        }

        patchList.innerHTML = "";
        noPatchMsg.style.display = "none";

        if (backendResult.available_patches.length === 0) {
            noPatchMsg.style.display = "block";
            log(logBox, "No hay parches disponibles.");
            return;
        }

        backendResult.available_patches.forEach(p => {
            const div = document.createElement("div");
            div.className = "patch-item";
            div.textContent = p.label;
            div.onclick = () => log(logBox, `Seleccionaste parche: ${p.id}`);
            patchList.appendChild(div);
        });

        log(logBox, "Parches cargados.");
    });
</script>

</body>
</html>
