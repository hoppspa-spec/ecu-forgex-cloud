<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ECU FORGE X â€” Generar BIN.MOD</title>
<style>
  :root{
    --bg:#0b0f19; --card:#0f1629; --ink:#e5e7eb; --muted:#94a3b8;
    --brand:#0b1220; --btn:#2563eb; --btnh:#1d4ed8; --stroke:#1f2a44;
  }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial}
  header{background:var(--brand);color:#fff;display:flex;align-items:center;gap:12px;padding:14px 18px}
  header a{color:#cbd5e1;text-decoration:none}
  header .grow{flex:1}
  .toolbar{display:flex;gap:8px;align-items:center}
  .btn{background:var(--btn);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn:hover{background:var(--btnh)}
  .btn.sm{padding:6px 10px;font-size:13px;border-radius:8px}
  .btn.alt{background:#0ea5e9}
  .container{display:grid;grid-template-columns:340px 1fr 340px;gap:18px;padding:18px}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:16px}
  h3{margin:0 0 10px}
  input,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid var(--stroke);margin-bottom:10px;background:#0e1526;color:var(--ink)}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .muted{color:var(--muted);font-size:13px}
  .log{background:#000;color:#00ff72;font-family:ui-monospace,Menlo,Consolas;height:200px;border-radius:8px;padding:12px;overflow:auto}
  .badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#182038;color:#dbe2ff;font-size:12px}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;font-size:14px}
  .divider{height:1px;background:var(--stroke);margin:10px 0}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:50}
  .modal>.box{background:#101a33;border:1px solid var(--stroke);padding:18px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.35);width:340px}
  .err{display:none;color:#f87171;margin:6px 0 0;font-size:13px}
  /* ===== YAML box (alto contraste) ===== */
.yaml-box {
  background:#0a0f1d;
  color:#e9f0ff;
  border:1px solid #2b3a63;
  border-radius:10px;
  padding:12px;
  font-family: ui-monospace, Menlo, Consolas, monospace;
  font-size: 13px;
  line-height: 1.35;
  overflow:auto;
  max-height: 320px;
}
.yaml-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px }
.btn.copy { background:#16a34a; color:#021407; font-weight:700 }
.btn.copy:hover{ filter:brightness(1.12) }

</style>
</head>
<body>

<header>
  <div style="font-weight:700;font-size:20px">ECU FORGE X</div>
  <a href="/static/catalogo.html" style="margin-left:8px">CatÃ¡logo</a>
  <div class="grow"></div>
  <div class="toolbar">
    <button class="btn sm" id="btnTheme">Tema</button>
    <button class="btn sm" id="btnOpenLogin">Iniciar sesiÃ³n</button>
    <button class="btn sm alt" id="btnOpenRegister">Crear cuenta</button>
    <button class="btn sm" id="btnLogout" style="display:none">Cerrar sesiÃ³n</button>
  </div>
</header>

<div class="container">
  <!-- IZQUIERDA -->
  <div class="card">
    <h3>InformaciÃ³n del VehÃ­culo</h3>

    <label class="muted">Marca</label>
    <select id="selBrand">
      <option value="">â€” Selecciona â€”</option>
      <option value="custom">Personalizadoâ€¦</option>
    </select>

    <label class="muted">Modelo</label>
    <select id="selModel" disabled>
      <option value="">â€” Selecciona â€”</option>
    </select>

    <div class="row2">
      <div>
        <label class="muted">AÃ±o</label>
        <select id="selYear" disabled>
          <option value="">â€” Selecciona â€”</option>
        </select>
      </div>
      <div>
        <label class="muted">MotorizaciÃ³n</label>
        <select id="selEngine" disabled>
          <option value="">â€” Selecciona â€”</option>
        </select>
      </div>
    </div>

    <!-- Campos libres opcionales -->
    <input id="modelo" placeholder="Modelo libre (opcional)"/>
    <input id="motor"  placeholder="Motor libre (opcional, ej: TSI/HDI/N55)"/>

    <div class="divider"></div>

    <h3>Archivo BIN</h3>
    <input id="binfile" type="file"/>
    <button id="btnAnalizar" class="btn">Analizar BIN</button>
    <div class="muted">Formatos: .bin, .mpc, .org, .e2p, .101</div>
  </div>

  <!-- CENTRO -->
  <div class="card">
    <div class="row2" style="align-items:end">
      <div>
        <h3>Parches Disponibles <span id="ecuBadge" class="badge" style="display:none"></span></h3>
      </div>
      <div>
        <label class="muted">Tipo de Motor</label>
        <select id="engineSelect">
          <option value="auto">Auto (detectado)</option>
          <option value="petrol">Petrol</option>
          <option value="diesel">Diesel</option>
        </select>
      </div>
    </div>

    <select id="patchSelect" disabled>
      <option value="">â€” Sube tu BIN para ver opciones â€”</option>
    </select>
    <button id="btnAplicar" class="btn" disabled>Aplicar / Comprar</button>

    <div id="noPatchMsg" class="muted" style="display:none;margin-top:8px">
      Por ahora no contamos con un parche para tu ECU.<br/>
      Sube el BIN y te responderemos a la brevedad (mÃ¡x. <b>24&nbsp;h</b>).
      <button id="btn24h" class="btn sm" style="margin-top:8px;width:auto">Solicitar soluciÃ³n (24&nbsp;h)</button>
    </div>

    <h3 style="margin-top:16px">Resultado</h3>
    <div id="resultado" class="muted">AÃºn no se ha generado ningÃºn archivo.</div>

    <h3 style="margin-top:16px">Log</h3>
    <div id="log" class="log">Esperando accionesâ€¦</div>
  </div>

  <!-- DERECHA -->
  <div class="card">
    <h3>Ficha ECU</h3>
    <div class="kv">
      <div class="muted">ECU Type</div><div id="kv_ecu">â€”</div>
      <div class="muted">ECU Part Number</div><div id="kv_pn">â€”</div>
      <div class="muted">Software Number</div><div id="kv_sw">â€”</div>
      <div class="muted">File size</div><div id="kv_size">â€”</div>
      <div class="muted">CVN</div><div id="kv_cvn">â€”</div>
      <div class="muted">Parche</div><div id="kv_patch">â€”</div>
      <div class="muted">Precio</div><div id="kv_price">â€”</div>
      <div class="divider"></div>
    <h3>Resumen YAML</h3>
      <pre id="ecuYaml" class="yaml-box"># AÃºn sin datosâ€¦</pre>
      <div class="yaml-actions">
      <button id="btnCopyYaml" class="btn copy">Copiar YAML</button>
</div>

    </div>
  </div>
</div>

<!-- MODAL LOGIN -->
<div id="modalLogin" class="modal">
  <div class="box">
    <h3>Iniciar sesiÃ³n</h3>
    <input id="login_email" placeholder="Email" />
    <input id="login_pass" type="password" placeholder="ContraseÃ±a" />
    <p id="login_err" class="err"></p>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <button id="btnLogin" class="btn sm">Ingresar</button>
      <button class="btn sm" data-close="#modalLogin" style="background:transparent;border:1px solid var(--stroke);">Cerrar</button>
    </div>
  </div>
</div>

<!-- MODAL REGISTRO -->
<div id="modalRegister" class="modal">
  <div class="box">
    <h3>Crear cuenta</h3>
    <input id="reg_name" placeholder="Nombre (opcional)" />
    <input id="reg_email" placeholder="Email" />
    <input id="reg_pass" type="password" placeholder="ContraseÃ±a (min 6)" />
    <p id="reg_err" class="err"></p>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <button id="btnRegister" class="btn sm">Registrarme</button>
      <button class="btn sm" data-close="#modalRegister" style="background:transparent;border:1px solid var(--stroke);">Cerrar</button>
    </div>
  </div>
</div>

<script>
/* ===== THEME ===== */
(function(){
  const KEY='EFX_THEME';
  const saved = localStorage.getItem(KEY) || 'dark';
  document.body.classList.toggle('dark', saved === 'dark');
  document.getElementById('btnTheme').onclick=()=>{
    const isDark = !document.body.classList.contains('dark');
    document.body.classList.toggle('dark', isDark);
    localStorage.setItem(KEY, isDark ? 'dark' : 'light');
  };
})();
</script>

<script>
/* ===== Estado/UI + helpers ===== */
let TOKEN = localStorage.getItem("EFX_TOKEN") || null;
let lastAnalysis=null, lastFile=null, lastCvn=null, engineDetected="auto";

const $=(q,el=document)=>el.querySelector(q);
const log=(m)=>{const b=$("#log"); if(!b) return; b.textContent+="\n"+m; b.scrollTop=b.scrollHeight;};
const setBadge=(t)=>{const b=$("#ecuBadge"); if(!b) return; if(!t){b.style.display="none";b.textContent="";} else {b.style.display="inline-block"; b.textContent=t;}};

function setAuthUi(on){
  $("#btnOpenLogin").style.display = on? "none":"inline-block";
  $("#btnOpenRegister").style.display = on? "none":"inline-block";
  $("#btnLogout").style.display = on? "inline-block":"none";
}
setAuthUi(!!TOKEN);

$("#btnOpenLogin").onclick = ()=>$("#modalLogin").style.display="flex";
$("#btnOpenRegister").onclick = ()=>$("#modalRegister").style.display="flex";
$("#btnLogout").onclick = ()=>{ TOKEN=null; localStorage.removeItem("EFX_TOKEN"); setAuthUi(false); log("SesiÃ³n cerrada."); };
document.querySelectorAll("[data-close]").forEach(btn=>{
  btn.addEventListener("click",()=>{ const id=btn.getAttribute("data-close"); const m=$(id); if(m) m.style.display="none"; });
});
["modalLogin","modalRegister"].forEach(id=>{
  const m=document.getElementById(id); m.addEventListener("click",(e)=>{ if(e.target===m) m.style.display="none"; });
});
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape"){ ["#modalLogin","#modalRegister"].forEach(id=>{const m=$(id); if(m) m.style.display="none";}); }});

function showErr(id,msg){const el=$(id); if(!el) return; el.textContent=msg||""; el.style.display=msg?"block":"none";}
</script>

<script>
/* ===== Login/Registro ===== */
$("#btnLogin").onclick = async ()=>{
  showErr("#login_err","");
  const email = $("#login_email").value.trim();
  const pass  = $("#login_pass").value;
  if(!email || !pass){ showErr("#login_err","Completa email y contraseÃ±a."); return; }
  const fd = new FormData(); fd.append("username", email); fd.append("password", pass);
  try{
    const r = await fetch("/auth/login",{method:"POST",body:fd});
    if(!r.ok){ showErr("#login_err","Credenciales invÃ¡lidas."); return; }
    const d = await r.json();
    TOKEN = d.access_token; localStorage.setItem("EFX_TOKEN", TOKEN);
    $("#modalLogin").style.display="none"; setAuthUi(true); log("SesiÃ³n iniciada.");
  }catch{ showErr("#login_err","Error de red."); }
};

$("#btnRegister").onclick = async ()=>{
  showErr("#reg_err","");
  const payload = { email: $("#reg_email").value.trim(), password: $("#reg_pass").value, full_name: $("#reg_name").value || null };
  if(!payload.email || !payload.password){ showErr("#reg_err","Completa email y contraseÃ±a."); return; }
  try{
    const r = await fetch("/auth/register",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok){ const t=await r.text(); showErr("#reg_err","No se pudo crear la cuenta: "+t); return; }
    const fd = new FormData(); fd.append("username", payload.email); fd.append("password", payload.password);
    const lr = await fetch("/auth/login",{method:"POST",body:fd});
    if(lr.ok){ const d=await lr.json(); TOKEN=d.access_token; localStorage.setItem("EFX_TOKEN", TOKEN); setAuthUi(true); $("#modalRegister").style.display="none"; log("Cuenta creada e iniciada."); }
    else { $("#modalRegister").style.display="none"; alert("Cuenta creada. Inicia sesiÃ³n por favor."); }
  }catch{ showErr("#reg_err","Error de red."); }
};
</script>

<script>
/* ===== CRC32 (CVN) ===== */
(function(){
  const table = new Uint32Array(256).map((_,n)=>{let c=n; for(let k=0;k<8;k++) c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1); return c>>>0;});
  window.crc32 = (buf)=>{ let c=0^(-1); for(let i=0;i<buf.length;i++) c=(c>>>8)^table[(c^buf[i])&0xFF]; return (c^(-1))>>>0; };
})();
</script>

<script>
/* ===== JSON helper con fallback ===== */
const _jsonCache={};
async function jget(url){
  if(_jsonCache[url]) return _jsonCache[url];
  try{
    const r = await fetch(url,{cache:"no-store"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    const d = await r.json(); _jsonCache[url]=d; return d;
  }catch{
    // Fallback mÃ­nimo embebido si no existe /static/data/vehicles.json
    if(url.endsWith("/static/data/vehicles.json")){
      const d = {
        "brands":[
          {"key":"bmw","label":"BMW","models":[
            {"key":"320i","label":"320i","years":[2016,2017,2018,2019],"engines":["B48 2.0T","N20 2.0T"]},
            {"key":"320d","label":"320d","years":[2013,2014,2015,2016,2017],"engines":["2.0D (N47/B47)"]}
          ]},
          {"key":"vw","label":"Volkswagen","models":[
            {"key":"golf_gti","label":"Golf GTI","years":[2014,2015,2016,2017,2018,2019],"engines":["2.0 TSI"]},
            {"key":"golf_tdi","label":"Golf TDI","years":[2010,2011,2012,2013,2014],"engines":["2.0 TDI"]}
          ]}
        ]
      };
      _jsonCache[url]=d; return d;
    }
    throw new Error("No se pudo cargar "+url);
  }
}
</script>

<script>
/* ===== Precio & Ficha helpers ===== */
function toUSD(p){ if(p==null) return null; if(typeof p==="number") return p; if(typeof p==="object" && p.USD!=null) return Number(p.USD); return null; }
function labelWithPrice(label, priceLike){ const usd=toUSD(priceLike); return usd!=null ? `${label} â€” $${usd}` : label; }
function reflectSelectionInFicha(txt){
  const m = (txt||"").match(/\$([\d.,]+)/);
  const label = (txt||"").replace(/\s+â€”\s+\$[\d.,]+/,"");
  const price = m ? `$${m[1]}` : "â€”";
  $("#kv_patch").textContent = label || "â€”";
  $("#kv_price").textContent = price;
}
</script>

<script>
/* ===== Formulario: marcas â†’ modelos â†’ aÃ±os â†’ engine ===== */
let VEH_DB = null;
let picked = { brand:null, model:null, year:null, engine:null };

async function loadVehicleData(){
  try{
    VEH_DB = await jget("/static/data/vehicles.json");
    const selBrand = $("#selBrand");
    selBrand.innerHTML = `<option value="">â€” Selecciona â€”</option><option value="custom">Personalizadoâ€¦</option>`;
    (VEH_DB.brands||[]).forEach(b=> selBrand.append(new Option(b.label, b.key)));
  }catch(e){
    console.warn("No se pudieron cargar marcas:", e.message);
  }
}
document.addEventListener("DOMContentLoaded", loadVehicleData);

$("#selBrand").addEventListener("change", ()=>{
  picked.brand = $("#selBrand").value || null;
  const selModel = $("#selModel"), selYear=$("#selYear"), selEngine=$("#selEngine");
  selModel.innerHTML = `<option value="">â€” Selecciona â€”</option>`;
  selYear.innerHTML  = `<option value="">â€” Selecciona â€”</option>`;
  selEngine.innerHTML= `<option value="">â€” Selecciona â€”</option>`;
  selModel.disabled = selYear.disabled = selEngine.disabled = true;

  if(!picked.brand || picked.brand==="custom") return;
  const B = (VEH_DB?.brands||[]).find(x=>x.key===picked.brand);
  if(!B) return;

  (B.models||[]).forEach(m => selModel.append(new Option(m.label, m.key)));
  selModel.disabled = true;  // se habilita al elegir modelo (abajo)
});

$("#selModel").addEventListener("change", ()=>{
  picked.model = $("#selModel").value || null;
  const selYear=$("#selYear"), selEngine=$("#selEngine");
  selYear.innerHTML  = `<option value="">â€” Selecciona â€”</option>`;
  selEngine.innerHTML= `<option value="">â€” Selecciona â€”</option>`;
  selYear.disabled = selEngine.disabled = true;

  if(!picked.brand || !picked.model) return;
  const B = (VEH_DB?.brands||[]).find(x=>x.key===picked.brand);
  const M = B?.models?.find(m=>m.key===picked.model);
  if(!M) return;

  (M.years||[]).forEach(y => selYear.append(new Option(String(y), String(y))));
  (M.engines||[]).forEach(e => selEngine.append(new Option(e, e)));

  $("#selModel").disabled = false;
  selYear.disabled = false;
  selEngine.disabled = false;
});

$("#selYear").addEventListener("change", ()=>{ picked.year = $("#selYear").value || null; });

$("#selEngine").addEventListener("change", ()=>{
  picked.engine = $("#selEngine").value || null;
  const lower = (picked.engine||"").toLowerCase();
  if(/tdi|hdi|dci|cd i|cdi|mjet|mjtd|diesel|d4d|d-4d|bluehdi|md1|edc/i.test(lower)) {
    $("#engineSelect").value = "diesel";
  } else if(/tsi|tfsi|gdi|mpi|petrol|nafta|n\d{2}|b\d{2}|mg1|med|mevd|me7/i.test(lower)) {
    $("#engineSelect").value = "petrol";
  } else {
    $("#engineSelect").value = "auto";
  }
  if (typeof fillPatches === "function") fillPatches();
});

function brandKeyFromDropdown(){
  const v = $("#selBrand")?.value || "";
  if (!v || v==="custom") return null;
  return v; // coincide con patches/brand/<key>.json si usas overrides
}
</script>

<script>
/* ===== CatÃ¡logo / detecciones ===== */
function detectEcuFamily(ecuType, filename){
  const src = ((ecuType||"") + " " + (filename||"")).toUpperCase();
  const tests = [/MG1CS\d*/, /\bMG1\b/, /MED17\.5(\.\d+)?/, /\bMED17\b/, /\bMEVD\b/, /\bME7(\.\d+)?\b/, /EDC17CP\d*/, /EDC17C\d*/, /\bEDC17\b/, /\bEDC16\b/, /\bMD1\b/, /\bDCM\d*\b/, /\bSID\d{3}\b/];
  for(const re of tests){ const m = src.match(re); if(m) return m[0]; }
  if(/BOSCH/.test(src) && /MG1/.test(src)) return "MG1";
  if(/BOSCH/.test(src) && /MED17/.test(src)) return "MED17";
  if(/BOSCH/.test(src) && /EDC17/.test(src)) return "EDC17";
  return null;
}
function currentEngineMode(){
  const sel = $("#engineSelect"); if(!sel) return "auto";
  if(sel.value!=="auto") return sel.value;
  return engineDetected || "auto";
}

async function loadPatchesCombined(engineMode, ecuFamily, brandKey){
  let list=[];
  try{
    const g = await jget("/static/patches/global.json");
    list = (g.patches||[]).map(p=>({...p, engines:(p.engines||[]).map(e=>String(e).toLowerCase()) }));
  }catch{}

  if(engineMode && engineMode!=="auto"){
    const want = String(engineMode).toLowerCase();
    list = list.filter(p => (p.engines||[]).includes(want));
  }
  if(ecuFamily){
    const up = ecuFamily.toUpperCase();
    list = list.filter(p => (p.compatible_ecu||[]).some(f => up.includes(String(f).toUpperCase())));
  }
  if(brandKey){
    try{
      const ov = await jget(`/static/patches/brand/${brandKey}.json`);
      if(ov?.ecus){
        const famKey = Object.keys(ov.ecus).find(k => ecuFamily && ecuFamily.toUpperCase().includes(k.toUpperCase()));
        if(famKey){
          const rules = ov.ecus[famKey];
          if(rules.exclude) list = list.filter(p => !rules.exclude.includes(p.id));
          if(rules.include) list = list.filter(p =>  rules.include.includes(p.id));
          if(rules.rename)  list = list.map(p => ({...p, label: rules.rename[p.id] || p.label}));
          if(rules.price)   list = list.map(p => (rules.price[p.id]!=null? {...p, price: rules.price[p.id]} : p));
        }
      }
    }catch{}
  }
  let packs=[];
  try{
    const pk = await jget("/static/patches/packs.json");
    packs = (pk.packs||[]).filter(x => !engineMode || engineMode==="auto" || !x.engine || x.engine===engineMode);
  }catch{}
  return {patches:list, packs};
}

async function fillPatches(){
  const sel = $("#patchSelect"), btn=$("#btnAplicar"), msg=$("#noPatchMsg");
  if(!sel||!btn) return;
  sel.innerHTML=""; sel.disabled=true; btn.disabled=true; if(msg) msg.style.display="none";

  if(!lastAnalysis){ sel.append(new Option("â€” Sube tu BIN para ver opciones â€”","")); return; }
  const mode=currentEngineMode();
  const ecuFam=detectEcuFamily(lastAnalysis?.ecu_type, lastAnalysis?.filename);
  const brandKey=brandKeyFromDropdown();

  try{
    const {patches,packs} = await loadPatchesCombined(mode, ecuFam, brandKey);
    const has = (patches&&patches.length) || (packs&&packs.length);
    if(!has){ sel.append(new Option("Sin parches disponibles","")); if(msg) msg.style.display="block"; return; }

    sel.disabled=false; btn.disabled=false;
    sel.append(new Option("â€” Selecciona una opciÃ³n â€”",""));
    (patches||[]).forEach(p => sel.append(new Option(labelWithPrice(p.label, p.price), p.id)));
    if(packs && packs.length){
      sel.append(new Option("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PACKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",""));
      packs.forEach(pk => sel.append(new Option(`ðŸ§© ${labelWithPrice(pk.label, pk.price)}`, `pack:${pk.id}`)));
    }
  }catch(e){
    log("Error cargando parches: "+e.message);
    sel.append(new Option("Error cargando parches",""));
  }
}

$("#patchSelect").addEventListener("change", ()=>{
  const sel=$("#patchSelect"); const txt=sel.options[sel.selectedIndex]?.text||""; 
  if(/â”€{5,}/.test(txt)){ reflectSelectionInFicha(""); sel.value=""; return; }
  reflectSelectionInFicha(txt);
});

$("#engineSelect")?.addEventListener("change", fillPatches);
</script>

<script>
/* ===== BIN: change + analizar + auto-detecciÃ³n motor ===== */
$("#binfile").addEventListener("change", async (e)=>{
  lastFile = e.target.files?.[0] || null;
  if(lastFile){
    const buf = new Uint8Array(await lastFile.arrayBuffer());
    lastCvn = crc32(buf).toString(16).toUpperCase().padStart(8,'0');
    $("#kv_cvn").textContent = lastCvn;
    $("#kv_size").textContent = new Intl.NumberFormat('es-CL').format(lastFile.size) + " bytes";
  }
});

$("#btnAnalizar").onclick = async ()=>{
  const f = $("#binfile").files[0];
  if(!f){ alert("Selecciona un BIN"); return; }
  if(!/\.(bin|mpc|org|e2p|101)$/i.test(f.name||"")){ alert("Formato no soportado. Usa .bin, .mpc, .org, .e2p, .101"); return; }

  const fd = new FormData(); fd.append("bin_file", f);
  log("Subiendo y analizando BINâ€¦");
  const r = await fetch("/analyze_bin",{method:"POST",body:fd});
  log(`Respuesta /analyze_bin: ${r.status}`);
  if(!r.ok){ const t=await r.text().catch(()=>"(sin detalle)"); log("Error analizando BIN â†’ "+t); alert("No se pudo analizar el BIN.\nHTTP "+r.status); return; }
  const data = await r.json(); lastAnalysis = data;

  $("#kv_ecu").textContent = data.ecu_type || "â€”";
  $("#kv_pn").textContent  = data.ecu_part_number || "â€”";
  $("#kv_sw").textContent  = "â€”";
  $("#kv_size").textContent = new Intl.NumberFormat('es-CL').format(data.bin_size||0) + " bytes";
  setBadge(data.ecu_type || null);

  // Auto: si ECU sugiere diesel/petrol, ajusta engineDetected
  if(/EDC|MD1|MJD|DCM|SID/i.test(data.ecu_type||"")) engineDetected="diesel";
  else if(/MED|MG1|MEVD|ME7/i.test(data.ecu_type||"")) engineDetected="petrol";
  else engineDetected="auto";

  // Si cliente eligiÃ³ una motorizaciÃ³n en dropdown, gana prioridad
  const userEngine = ($("#selEngine")?.value || "") + " " + ($("#motor")?.value || "");
  const lower = userEngine.toLowerCase();
  if(/tdi|hdi|dci|cd i|cdi|mjet|mjtd|diesel|d4d|d-4d|bluehdi/i.test(lower)) engineDetected="diesel";
  if(/tsi|tfsi|gdi|mpi|petrol|nafta|n\d{2}|b\d{2}|mg1|med|mevd|me7/i.test(lower)) engineDetected="petrol";

  $("#engineSelect").value="auto";
  await fillPatches();
  log("AnÃ¡lisis OK. ECU: "+(data.ecu_type||"â€”")+"  PN: "+(data.ecu_part_number||"â€”"));
};
</script>

<script>
/* ===== Ã“rdenes + 24h ===== */
$("#btnAplicar").onclick = async ()=>{
  const sel = $("#patchSelect");
  const value = sel.value;
  if(!lastAnalysis){ alert("Primero analiza un BIN"); return; }
  if(!value){ alert("Selecciona una opciÃ³n"); return; }
  if(!TOKEN){ $("#modalLogin").style.display="flex"; return; }

  const patchId = value.startsWith("pack:") ? value.slice(5) : value;
  const r = await fetch("/orders",{
    method:"POST",
    headers:{ "Authorization":"Bearer "+TOKEN, "Content-Type":"application/json" },
    body: JSON.stringify({ analysis_id: lastAnalysis.analysis_id, patch_option_id: patchId })
  });
  if(!r.ok){ const t=await r.text(); alert("Error creando orden:\n"+t); return; }
  const d = await r.json();
  location.href = d.checkout_url || `/static/checkout.html?order_id=${d.id}`;
};

$("#btn24h").onclick = async ()=>{
  if(!TOKEN){ $("#modalLogin").style.display="flex"; return; }

  const brandLabel = (()=>{ 
    const b = $("#selBrand"); 
    if(!b || !b.value || b.value==="custom") return null;
    const opt = b.options[b.selectedIndex]; 
    return opt ? opt.text : b.value; 
  })();
  const modelLabel = (()=>{ 
    const m = $("#selModel"); 
    if(m && m.value){ const opt=m.options[m.selectedIndex]; return opt?opt.text:m.value; }
    const free = $("#modelo")?.value || null; return free; 
  })();
  const yearVal = $("#selYear")?.value || null;
  const engineLbl = (()=>{ 
    const e = $("#selEngine"); 
    if(e && e.value){ const opt=e.options[e.selectedIndex]; return opt?opt.text:e.value; }
    const free = $("#motor")?.value || null; return free; 
  })();

  const payload = {
    marca: brandLabel,
    modelo: modelLabel,
    anio: yearVal,
    motor: engineLbl,
    ecu_type: $("#kv_ecu").textContent||null,
    ecu_part_number: $("#kv_pn").textContent||null,
    manufacturer_number: null,
    analysis_id: lastAnalysis?.analysis_id || null,
    original_filename: lastAnalysis?.filename || null
  };

  const r = await fetch("/patch_requests",{
    method:"POST",
    headers:{'Authorization':'Bearer '+TOKEN,'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if(!r.ok){ alert("No se pudo crear la solicitud 24h"); return; }
  const d = await r.json(); alert("Solicitud creada: "+d.request_id+" (SLA: "+d.sla_hours+"h)");
};
</script>

<script>
async function assertAuth() {
  if (!TOKEN) { $("#modalLogin").style.display = "flex"; return false; }
  try {
    const r = await fetch("/users/me", { headers: { "Authorization": "Bearer " + TOKEN } });
    if (r.ok) return true;
  } catch (_) {}
  localStorage.removeItem("EFX_TOKEN");
  TOKEN = null;
  setAuthUi(false);
  alert("Tu sesiÃ³n expirÃ³. Inicia sesiÃ³n nuevamente.");
  $("#modalLogin").style.display = "flex";
  return false;
}
</script>

</body>
</html>
