<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ECU FORGE X â€” Generar BIN.MOD</title>
<style>
  :root{
    --bg:#0b0f19; --card:#0f1629; --ink:#e5e7eb; --muted:#94a3b8;
    --brand:#0b1220; --btn:#2563eb; --btnh:#1d4ed8; --stroke:#1f2a44; --ok:#22c55e;
  }
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial}
  header{background:var(--brand);color:#fff;display:flex;align-items:center;gap:12px;padding:14px 18px}
  header a{color:#cbd5e1;text-decoration:none}
  header .grow{flex:1}
  .toolbar{display:flex;gap:8px;align-items:center}
  .btn{background:var(--btn);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn:hover{background:var(--btnh)}
  .btn.sm{padding:6px 10px;font-size:13px;border-radius:8px}
  .btn.alt{background:#0ea5e9}
  .container{display:grid;grid-template-columns:340px 1fr 340px;gap:18px;padding:18px}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:16px}
  h3{margin:0 0 10px}
  input,select,button{width:100%;padding:10px;border-radius:8px;border:1px solid var(--stroke);margin-bottom:10px;background:#0e1526;color:var(--ink)}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .muted{color:var(--muted);font-size:13px}
  .log{background:#000;color:#00ff72;font-family:ui-monospace,Menlo,Consolas;height:200px;border-radius:8px;padding:12px;overflow:auto}
  .badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#182038;color:#dbe2ff;font-size:12px}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;font-size:14px}
  .divider{height:1px;background:var(--stroke);margin:10px 0}
  .hint{font-size:12px;color:var(--muted)}
  /* modal */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:50}
  .modal>.box{background:#101a33;border:1px solid var(--stroke);padding:18px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.35);width:340px}
</style>
</head>
<body>

<header>
  <div style="font-weight:700;font-size:20px">ECU FORGE X</div>
  <a href="/static/catalogo.html" style="margin-left:8px">CatÃ¡logo</a>
  <div class="grow"></div>
  <div class="toolbar">
    <button class="btn sm" id="btnTheme">Tema</button>
    <button class="btn sm" id="btnOpenLogin">Iniciar sesiÃ³n</button>
    <button class="btn sm alt" id="btnOpenRegister">Crear cuenta</button>
    <button class="btn sm" id="btnLogout" style="display:none">Cerrar sesiÃ³n</button>
  </div>
</header>

<div class="container">
  <!-- IZQUIERDA -->
  <div class="card">
    <h3>InformaciÃ³n del VehÃ­culo</h3>
    <input id="marca" placeholder="Marca (ej: BMW)"/>
    <input id="modelo" placeholder="Modelo (ej: 320i)"/>
    <div class="row2">
      <input id="anio" placeholder="AÃ±o (ej: 2018)"/>
      <input id="motor" placeholder="Motor (ej: B48 2.0T)"/>
    </div>
    <input id="ecu_type" placeholder="Tipo ECU (ej: Bosch MG1)"/>

    <div class="divider"></div>

    <h3>Archivo BIN</h3>
    <input id="binfile" type="file"/>
    <button id="btnAnalizar" class="btn">Analizar BIN</button>
    <div class="muted">Formatos: .bin, .mpc, .org, .e2p, .101</div>
  </div>

  <!-- CENTRO -->
  <div class="card">
    <div class="row2" style="align-items:end">
      <div>
        <h3>Parches Disponibles <span id="ecuBadge" class="badge" style="display:none"></span></h3>
      </div>
      <div>
        <label class="muted">Tipo de Motor</label>
        <select id="engineSelect">
          <option value="auto">Auto (detectado)</option>
          <option value="petrol">Petrol</option>
          <option value="diesel">Diesel</option>
        </select>
      </div>
    </div>

    <select id="patchSelect" disabled>
      <option value="">â€” Sube tu BIN para ver opciones â€”</option>
    </select>
    <button id="btnAplicar" class="btn" disabled>Aplicar / Comprar</button>

    <div id="noPatchMsg" class="muted" style="display:none;margin-top:8px">
      No hay parches disponibles para esta ECU.<br/>
      Dentro de mÃ¡ximo <b>36 horas</b> podemos generar una soluciÃ³n personalizada.
      <button id="btn36h" class="btn sm" style="margin-top:8px;width:auto">Solicitar soluciÃ³n (36h)</button>
    </div>

    <h3 style="margin-top:16px">Resultado</h3>
    <div id="resultado" class="muted">AÃºn no se ha generado ningÃºn archivo.</div>

    <h3 style="margin-top:16px">Log</h3>
    <div id="log" class="log">Esperando accionesâ€¦</div>
  </div>

  <!-- DERECHA -->
  <div class="card">
    <h3>Ficha ECU</h3>
    <div class="kv">
      <div class="muted">ECU Type</div><div id="kv_ecu">â€”</div>
      <div class="muted">ECU Part Number</div><div id="kv_pn">â€”</div>
      <div class="muted">Software Number</div><div id="kv_sw">â€”</div>
      <div class="muted">File size</div><div id="kv_size">â€”</div>
      <div class="muted">CVN</div><div id="kv_cvn">â€”</div>
      <div class="muted">Parche</div><div id="kv_patch">â€”</div>
      <div class="muted">Precio</div><div id="kv_price">â€”</div>
    </div>
  </div>
</div>

<!-- MODAL LOGIN -->
<div id="modalLogin" class="modal">
  <div class="box" role="dialog" aria-modal="true">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <h3 style="margin:0">Iniciar sesiÃ³n</h3>
      <button id="closeLogin" class="btn sm" style="background:#1f2a44">âœ•</button>
    </div>
    <input id="login_email" placeholder="Email" autocomplete="username"/>
    <input id="login_pass" type="password" placeholder="ContraseÃ±a" autocomplete="current-password"/>
    <button id="btnLogin" class="btn" style="width:100%">Ingresar</button>
    <div id="login_err" class="hint" style="margin-top:8px;display:none;color:#ff7676">Credenciales invÃ¡lidas.</div>
  </div>
</div>

<!-- MODAL REGISTRO -->
<div id="modalRegister" class="modal">
  <div class="box" role="dialog" aria-modal="true">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <h3 style="margin:0">Crear cuenta</h3>
      <button id="closeRegister" class="btn sm" style="background:#1f2a44">âœ•</button>
    </div>
    <input id="reg_name" placeholder="Nombre (opcional)" autocomplete="name"/>
    <input id="reg_email" placeholder="Email" autocomplete="email"/>
    <input id="reg_pass" type="password" placeholder="ContraseÃ±a (min 6)" autocomplete="new-password"/>
    <button id="btnRegister" class="btn" style="width:100%">Registrarme</button>
    <div id="reg_err" class="hint" style="margin-top:8px;display:none;color:#ff7676">No se pudo crear la cuenta.</div>
  </div>
</div>

<script>
/* ================== THEME (oscuro por defecto) ================== */
(function(){
  const KEY='EFX_THEME';
  const saved = localStorage.getItem(KEY) || 'dark';
  document.body.classList.toggle('dark', saved === 'dark');
  document.getElementById('btnTheme').onclick=()=>{
    const isDark = !document.body.classList.contains('dark') ? true : false;
    document.body.classList.toggle('dark', isDark);
    localStorage.setItem(KEY, isDark ? 'dark' : 'light');
  };
})();

/* ================== Estado/UI helpers ================== */
let TOKEN = localStorage.getItem("EFX_TOKEN") || null;
let lastAnalysis=null, lastFile=null, lastCvn=null, engineDetected="auto";

const $=(q,el=document)=>el.querySelector(q);
const log=(m)=>{const b=$("#log");b.textContent+="\n"+m;b.scrollTop=b.scrollHeight;};
const setBadge=(t)=>{const b=$("#ecuBadge"); if(!t){b.style.display="none";b.textContent="";} else {b.style.display="inline-block"; b.textContent=t;}};

function setAuthUi(on){
  $("#btnOpenLogin").style.display = on? "none":"inline-block";
  $("#btnOpenRegister").style.display = on? "none":"inline-block";
  $("#btnLogout").style.display = on? "inline-block":"none";
}
setAuthUi(!!TOKEN);

$("#btnOpenLogin").onclick = ()=>$("#modalLogin").style.display="flex";
$("#btnOpenRegister").onclick = ()=>$("#modalRegister").style.display="flex";
$("#btnLogout").onclick = ()=>{ TOKEN=null; localStorage.removeItem("EFX_TOKEN"); setAuthUi(false); log("SesiÃ³n cerrada."); };

/* ================== Login/Registro ================== */
$("#btnLogin").onclick = async ()=>{
  const fd = new FormData();
  fd.append("username", $("#login_email").value);
  fd.append("password", $("#login_pass").value);
  const r = await fetch("/auth/login",{method:"POST",body:fd});
  if(!r.ok){ alert("Credenciales invÃ¡lidas"); return; }
  const d = await r.json(); TOKEN=d.access_token; localStorage.setItem("EFX_TOKEN", TOKEN);
  $("#modalLogin").style.display="none"; setAuthUi(true); log("SesiÃ³n iniciada.");
};

$("#btnRegister").onclick = async ()=>{
  const payload = { email: $("#reg_email").value, password: $("#reg_pass").value, full_name: $("#reg_name").value || null };
  const r = await fetch("/auth/register",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  if(!r.ok){ const e=await r.text(); alert("No se pudo crear la cuenta\n"+e); return; }
  // auto login
  const fd = new FormData(); fd.append("username", payload.email); fd.append("password", payload.password);
  const lr = await fetch("/auth/login",{method:"POST",body:fd});
  if(lr.ok){ const d=await lr.json(); TOKEN=d.access_token; localStorage.setItem("EFX_TOKEN", TOKEN); setAuthUi(true); $("#modalRegister").style.display="none"; log("Cuenta creada e iniciada."); }
  else { $("#modalRegister").style.display="none"; alert("Cuenta creada. Inicia sesiÃ³n por favor."); }
};

/* ================== CRC32 (CVN demo) ================== */
(function(){
  const table = new Uint32Array(256).map((_,n)=>{let c=n; for(let k=0;k<8;k++) c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1); return c>>>0;});
  window.crc32 = (buf)=>{ let c=0^(-1); for(let i=0;i<buf.length;i++) c=(c>>>8)^table[(c^buf[i])&0xFF]; return (c^(-1))>>>0; };
})();

/* ================== Precios (demo) ================== */
const PRICE_MAP = {
  speed_limiter: 10,
  rpm_limit: 12,
  dtc_off: 8,
  dpf_off: 25,
  egr_off: 18,
  "pack:stage1_base": 49,
  "pack:popbangs_light": 29
};

function setSelectedInFicha(value, label){
  const patchEl = $("#kv_patch");
  const priceEl = $("#kv_price");
  if(!value){ patchEl.textContent="â€”"; priceEl.textContent="â€”"; return; }
  patchEl.textContent = label || value;
  const amount = PRICE_MAP[value] ?? 10;
  priceEl.textContent = `$${amount.toFixed(2)} USD`;
}

function updateApplyButtonLabel(){
  const sel = $("#patchSelect");
  const btn = $("#btnAplicar");
  const value = sel.value;
  if(!value){ btn.textContent = "Aplicar / Comprar"; return; }
  const amount = PRICE_MAP[value] ?? 10;
  btn.textContent = `Aplicar / Comprar â€” $${amount.toFixed(2)}`;
}

/* ================== DetecciÃ³n familia ECU ================== */
function detectEcuFamily(ecuType, filename){
  const src = ((ecuType||"") + " " + (filename||"")).toUpperCase();
  const rules = [
    {key:"MG1CS",   re:/(MG1CS\d{0,3})/},
    {key:"MG1",     re:/\bMG1\b/},
    {key:"MED17.5", re:/MED17\.5(\.\d+)?/},
    {key:"MED17",   re:/\bMED17\b/},
    {key:"MEVD",    re:/\bMEVD\b/},
    {key:"ME7",     re:/\bME7(\.\d+)?\b/},
    {key:"EDC17CP", re:/EDC17CP\d*/},
    {key:"EDC17C",  re:/EDC17C\d*/},
    {key:"EDC17",   re:/\bEDC17\b/},
    {key:"EDC16",   re:/\bEDC16\b/},
    {key:"MD1",     re:/\bMD1\b/},
    {key:"DCM",     re:/\bDCM\d*\b/},
    {key:"SID",     re:/\bSID\d{3}\b/},
    {key:"DENSO",   re:/\bDENSO\b/},
    {key:"DELPHI",  re:/\bDELPHI\b/},
    {key:"KEFICO",  re:/\bKEFICO\b/}
  ];
  for(const r of rules){ const m = src.match(r.re); if(m) return (m[1]||r.key); }
  if (/BOSCH/.test(src) && /MG1/.test(src)) return "MG1";
  if (/BOSCH/.test(src) && /MED17/.test(src)) return "MED17";
  if (/BOSCH/.test(src) && /EDC17/.test(src)) return "EDC17";
  return null;
}

/* ================== Parches (global + packs + marca opcional) ================== */
const _jsonCache={};
async function loadJsonCached(url){
  if(_jsonCache[url]) return _jsonCache[url];
  const r = await fetch(url); if(!r.ok) throw new Error("404 "+url);
  const d = await r.json(); _jsonCache[url]=d; return d;
}
function currentEngineMode(){
  const sel = $("#engineSelect").value;
  if(sel!=="auto") return sel;
  return engineDetected;
}

async function loadPatchesCombined(engineMode, ecuFamily, brand){
  let list=[];
  try{
    const global = await loadJsonCached("/static/patches/global.json");
    list = global.patches || [];
  }catch{ list=[]; }

  if(engineMode && engineMode!=="auto"){
    list = list.filter(p => (p.engines||[]).includes(engineMode));
  }
  if(ecuFamily){
    const up = ecuFamily.toUpperCase();
    list = list.filter(p => (p.compatible_ecu||[]).some(f => up.includes(f.toUpperCase())));
  }

  // overrides por marca (opcional)
  if(brand){
    const brandKey = brand.toLowerCase().replace(/\s+/g,'_');
    try{
      const ov = await loadJsonCached(`/static/patches/brands/${brandKey}.json`);
      if (ov?.ecus) {
        const famKey = Object.keys(ov.ecus).find(k => ecuFamily && ecuFamily.toUpperCase().includes(k.toUpperCase()));
        if (famKey) {
          const rules = ov.ecus[famKey];
          if (rules.exclude) list = list.filter(p => !rules.exclude.includes(p.id));
          if (rules.include) list = list.filter(p => rules.include.includes(p.id));
          if (rules.rename)  list = list.map(p => ({...p, label: rules.rename[p.id] || p.label}));
        }
      }
    }catch{}
  }

  let packs=[];
  try{
    const pk = await loadJsonCached("/static/patches/packs.json");
    packs = (pk.packs||[]).filter(x => !engineMode || engineMode==="auto" || x.engine===engineMode);
  }catch{}

  return {patches:list, packs};
}

async function fillPatches(){
  const sel = $("#patchSelect");
  sel.innerHTML="";
  const mode = currentEngineMode();
  const ecuFam = detectEcuFamily(lastAnalysis?.ecu_type, lastAnalysis?.filename);
  const brand = ($("#marca").value||"").trim();

  const {patches,packs} = await loadPatchesCombined(mode, ecuFam, brand);

  if (patches.length) {
    sel.disabled=false; $("#btnAplicar").disabled=false; $("#noPatchMsg").style.display="none";
    sel.append(new Option("â€” Selecciona un parche â€”",""));
    patches.forEach(p=> sel.append(new Option(p.label, p.id)));
    if(packs.length){
      sel.append(new Option("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PACKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",""));
      packs.forEach(pk=> sel.append(new Option(`ðŸ§© ${pk.label}`, `pack:${pk.id}`)));
    }
  } else if (packs.length) {
    sel.disabled=false; $("#btnAplicar").disabled=false; $("#noPatchMsg").style.display="none";
    sel.append(new Option("â€” Selecciona un pack â€”",""));
    packs.forEach(pk=> sel.append(new Option(`ðŸ§© ${pk.label}`, `pack:${pk.id}`)));
  } else {
    sel.disabled=true; $("#btnAplicar").disabled=true; $("#noPatchMsg").style.display="block";
    sel.append(new Option("Sin parches disponibles",""));
  }
  setSelectedInFicha("", ""); updateApplyButtonLabel();
}

$("#patchSelect").addEventListener("change", ()=>{
  const sel=$("#patchSelect");
  const value=sel.value;
  const label=sel.options[sel.selectedIndex]?.text || "";
  if(label && label.includes("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")){ setSelectedInFicha("",""); sel.value=""; updateApplyButtonLabel(); return; }
  setSelectedInFicha(value, label && label.startsWith("ðŸ§© ")? label.replace("ðŸ§© ",""):label);
  updateApplyButtonLabel();
});

/* ================== BIN: change + analizar ================== */
$("#binfile").addEventListener("change", async (e)=>{
  lastFile = e.target.files?.[0] || null;
  if(lastFile){
    const buf = new Uint8Array(await lastFile.arrayBuffer());
    lastCvn = crc32(buf).toString(16).toUpperCase().padStart(8,'0');
    $("#kv_cvn").textContent = lastCvn;
    $("#kv_size").textContent = new Intl.NumberFormat('es-CL').format(lastFile.size) + " bytes";
  }
});

$("#btnAnalizar").onclick = async ()=>{
  const f = $("#binfile").files[0];
  if(!f){ alert("Selecciona un BIN"); return; }
  const fd = new FormData(); fd.append("bin_file", f); // nombre esperado por el backend
  log("Subiendo y analizando BINâ€¦");
  const r = await fetch("/analyze_bin",{method:"POST",body:fd});
  if(!r.ok){ log("Error analizando BIN"); return; }
  const data = await r.json(); lastAnalysis = data;

  $("#kv_ecu").textContent = data.ecu_type || "â€”";
  $("#kv_pn").textContent  = data.ecu_part_number || "â€”";
  $("#kv_sw").textContent  = "â€”";
  $("#kv_size").textContent = new Intl.NumberFormat('es-CL').format(data.bin_size||0) + " bytes";
  setBadge(data.ecu_type || null);

  if(/EDC|MD1|MJD|DCM/i.test(data.ecu_type||"")) engineDetected="diesel";
  else if(/MED|MG1|ME/i.test(data.ecu_type||"")) engineDetected="petrol";
  else engineDetected="auto";
  $("#engineSelect").value="auto";

  await fillPatches();
  log("AnÃ¡lisis OK. ECU: "+(data.ecu_type||"â€”")+" PN: "+(data.ecu_part_number||"â€”"));
});

/* ================== Aplicar / Comprar ================== */
$("#btnAplicar").onclick = async ()=>{
  const sel = $("#patchSelect");
  const value = sel.value;
  if(!value){ alert("Selecciona una opciÃ³n"); return; }
  if(!TOKEN){ $("#modalLogin").style.display="flex"; return; }

  const body = { analysis_id: lastAnalysis?.analysis_id || null, patch_option_id: value };
  const r = await fetch("/orders",{
    method:"POST",
    headers:{ "Authorization":"Bearer "+TOKEN, "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  if(!r.ok){ const t=await r.text(); alert("Error creando orden\n"+t); return; }
  const d = await r.json();
  location.href = "/static/checkout.html?order_id="+d.id;
};
  // ====== cerrar modales (botÃ³n, fondo, ESC)
const closeModal = (id)=>{ const m=$(id); if(m) m.style.display="none"; };
$("#closeLogin").onclick = ()=> closeModal("#modalLogin");
$("#closeRegister").onclick = ()=> closeModal("#modalRegister");

// click en fondo
["modalLogin","modalRegister"].forEach(mid=>{
  const m = document.getElementById(mid);
  m.addEventListener("click",(e)=>{ if(e.target===m) m.style.display="none"; });
});

// ESC
document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){
    closeModal("#modalLogin");
    closeModal("#modalRegister");
  }
});


/* ================== Solicitud 36h ================== */
$("#btn36h").onclick = async ()=>{
  if(!TOKEN){ $("#modalLogin").style.display="flex"; return; }
  const payload = {
    marca: $("#marca").value||null, modelo: $("#modelo").value||null, anio: $("#anio").value||null,
    motor: $("#motor").value||null, ecu_type: $("#kv_ecu").textContent||null,
    ecu_part_number: $("#kv_pn").textContent||null, manufacturer_number: null,
    analysis_id: lastAnalysis?.analysis_id || null, original_filename: lastAnalysis?.filename || null
  };
  const r = await fetch("/patch_requests",{method:"POST",headers:{'Authorization':'Bearer '+TOKEN,'Content-Type':'application/json'},body:JSON.stringify(payload)});
  if(!r.ok){ alert("No se pudo crear la solicitud 36h"); return; }
  const d = await r.json(); alert("Solicitud creada: "+d.request_id+" (SLA: "+d.sla_hours+"h)");
};
</script>
</body>
</html>
