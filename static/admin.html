<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ECU FORGE X — Admin de Recetas</title>
<style>
  :root{
    --bg:#0b0f19; --card:#0f1629; --ink:#e5e7eb; --muted:#94a3b8; --stroke:#1f2a44;
    --brand:#0b1220; --btn:#2563eb; --btnh:#1d4ed8; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial}
  header{background:var(--brand);color:#fff;display:flex;align-items:center;gap:12px;padding:14px 18px}
  header .grow{flex:1}
  a{color:#93c5fd;text-decoration:none}
  .wrap{padding:18px;display:grid;gap:18px;grid-template-columns:1fr}
  .tabs{display:flex;gap:8px}
  .tab{padding:10px 12px;border:1px solid var(--stroke);border-bottom:none;border-radius:10px 10px 0 0;background:#0e1526;cursor:pointer}
  .tab.active{background:var(--card)}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:16px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  label{font-size:13px;color:var(--muted)}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--stroke);background:#0e1526;color:var(--ink)}
  textarea{min-height:260px;font-family:ui-monospace,Consolas,Menlo}
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .row3{display:grid;gap:12px;grid-template-columns:1fr 1fr 1fr}
  .btn{background:var(--btn);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn:hover{background:var(--btnh)}
  .btn.ghost{background:transparent;border:1px solid var(--stroke)}
  .btn.ok{background:var(--ok);color:#01240c}
  .btn.warn{background:var(--warn);color:#231600}
  .btn.err{background:var(--err)}
  .muted{color:var(--muted);font-size:13px}
  .log{background:#000;color:#00ff72;font-family:ui-monospace,Consolas,Menlo;min-height:140px;border-radius:8px;padding:12px;overflow:auto}
  .hint{font-size:12px;color:var(--muted)}
  .divider{height:1px;background:var(--stroke);margin:10px 0}
  .badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#182038;color:#dbe2ff;font-size:12px}
  .hide{display:none}
  .right{display:flex;gap:10px;justify-content:flex-end}
  /* ===============================
   BOTONES — HIGH CONTRAST MODE
   =============================== */

.btn {
  font-weight: 700;
  letter-spacing: .3px;
  border-radius: 10px;
  padding: 12px 18px;
  font-size: 15px;
  border: none;
  cursor: pointer;
  transition: transform .05s ease, box-shadow .1s ease, filter .1s ease;
}

.btn:active {
  transform: translateY(1px);
}

/* Azul principal (acción normal) */
.btn.primary {
  background: #2563eb; /* azul vivo */
  color: #ffffff;
  box-shadow: 0 0 0 1px #1e40af, 0 4px 12px rgba(37,99,235,.45);
}

.btn.primary:hover {
  filter: brightness(1.15);
}

/* Verde éxito (guardar receta + catálogo) */
.btn.success {
  background: #16a34a;
  color: #ffffff;
  box-shadow: 0 0 0 1px #166534, 0 4px 12px rgba(22,163,74,.45);
}

.btn.success:hover {
  filter: brightness(1.15);
}

/* Amarillo advertencia (validar) */
.btn.warning {
  background: #f59e0b;
  color: #111827;
  box-shadow: 0 0 0 1px #b45309, 0 4px 12px rgba(245,158,11,.45);
}

.btn.warning:hover {
  filter: brightness(1.1);
}

/* Gris técnico (secundario) */
.btn.secondary {
  background: #334155;
  color: #e5e7eb;
  box-shadow: 0 0 0 1px #475569, 0 4px 10px rgba(0,0,0,.5);
}

.btn.secondary:hover {
  filter: brightness(1.2);
}

</style>
</head>
<body>
<header>
  <strong>ECU FORGE X — Admin</strong>
  <span class="badge">Recetas YAML</span>
  <div class="grow"></div>
  <a href="/static/index.html">← Volver</a>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tab active" data-tab="recetas">Editor de recetas</button>
    <button class="tab" data-tab="diff">Diff → YAML</button>
  </div>

  <!-- ======= Editor de Recetas ======= -->
  <section id="tab-recetas" class="card">
    <div class="grid g2">
      <div>
        <label>ECU Family (carpeta)</label>
        <input id="ecu_family" placeholder="Ej: MED17, MG1, EDC17"/>
      </div>
      <div>
        <label>Patch ID (nombre archivo)</label>
        <input id="patch_id" placeholder="Ej: speed_limiter, dpf_off"/>
      </div>
    </div>

    <div class="grid g2">
      <div>
        <label>Label (catálogo)</label>
        <input id="label" placeholder="Ej: Speed Limiter OFF"/>
      </div>
      <div>
        <label>Precio USD (opcional)</label>
        <input id="price" type="number" min="0" step="1" placeholder="Ej: 49"/>
      </div>
    </div>

    <div class="grid g2">
      <div>
        <label>Engines (coma)</label>
        <input id="engines" placeholder="petrol,diesel"/>
      </div>
      <div>
        <label>Compatible ECU (coma)</label>
        <input id="compat" placeholder="MED17,MG1,EDC17,MD1"/>
      </div>
    </div>

    <div>
      <label class="muted"><input type="checkbox" id="save_catalog" checked/> Actualizar catálogo (static/patches/global.json)</label>
    </div>

    <div>
      <label>YAML de la receta</label>
      <textarea id="yaml_text" spellcheck="false" placeholder="Pega/edita tu YAML aquí…"></textarea>
      <div class="hint">Ruta destino: <code>storage/recipes/&lt;ECU Family&gt;/&lt;Patch ID&gt;.yml</code></div>
    </div>

    <div class="right">
      <button class="btn">Cargar plantilla</button>
<button class="btn secondary">Cargar plantilla</button>
<button class="btn warning">Validar YAML</button>
<button class="btn primary">Guardar sin catálogo</button>
<button class="btn success">Guardar receta + catálogo</button>


    </div>

    <div class="divider"></div>
    <div>
      <label>Log</label>
      <div id="log1" class="log">Listo.</div>
    </div>
  </section>

  <script>
(() => {
  const $ = (q, el=document) => el.querySelector(q);
  let TOKEN = localStorage.getItem("EFX_TOKEN") || null;

  const ui = {
    fam: $("#diff_ecu_family") || $("#ecu_family") || document.querySelector('input[placeholder^="ECU Family"]'),
    pid: $("#diff_patch_id")   || $("#patch_id")   || document.querySelector('input[placeholder^="Patch ID"]'),
    f0:  $("#diff_bin_stock")  || document.querySelectorAll('input[type="file"]')[0],
    f1:  $("#diff_bin_mod")    || document.querySelectorAll('input[type="file"]')[1],
    autoSave: $("#diff_auto")  || document.querySelector('input[type="checkbox"]'),
    btn: $("#diff_go")         || [...document.querySelectorAll("button")].find(b => /Generar YAML/i.test(b.textContent)),
    out: $("#diff_yaml")       || document.querySelector("textarea"),
    log: $("#diff_log")        || document.querySelector(".log")
  };

  const log = (m) => { if(!ui.log) return; ui.log.textContent += (ui.log.textContent ? "\n":"") + m; ui.log.scrollTop = ui.log.scrollHeight; };

  function ensureToken() {
    TOKEN = localStorage.getItem("EFX_TOKEN");
    if (!TOKEN) { alert("Inicia sesión para usar Admin."); throw new Error("Sin token"); }
  }

  async function fileToArrayBuffer(file) {
    return new Uint8Array(await file.arrayBuffer());
  }

  async function handleDiff() {
    try {
      ensureToken();

      const fam = (ui.fam?.value || "").trim();
      let patchId = (ui.pid?.value || "").trim();
      const save = !!ui.autoSave?.checked;

      if (!fam) return alert("ECU Family requerido (ej: MED17, EDC17).");
      if (!patchId) return alert("Patch ID requerido (ej: dpf_off).");
      // normalizar patch id
      patchId = patchId.toLowerCase().replace(/\s+/g, "_").replace(/[^a-z0-9_\-]/g, "");

      const file0 = ui.f0?.files?.[0];
      const file1 = ui.f1?.files?.[0];
      if (!file0 || !file1) return alert("Selecciona BIN stock y BIN mod.");

      // chequeo de tamaños
      const b0 = await fileToArrayBuffer(file0);
      const b1 = await fileToArrayBuffer(file1);
      log(`Stock size: ${b0.length} bytes | Mod size: ${b1.length} bytes`);
      if (b0.length !== b1.length) {
        alert("Los BIN deben tener el MISMO tamaño para este diff simple.");
        return;
      }
      if (b0.length === 0) {
        alert("Archivo vacío.");
        return;
      }

      // armar FormData
      const fd = new FormData();
      fd.append("ecu_family", fam);
      fd.append("patch_id", patchId);
      fd.append("save", String(save));
      fd.append("original_bin", file0, file0.name);
      fd.append("modified_bin", file1, file1.name);

      log("Subiendo a /admin/diff2patch …");
      const r = await fetch("/admin/diff2patch", {
        method: "POST",
        headers: { "Authorization": "Bearer " + TOKEN },
        body: fd
      });

      if (!r.ok) {
        const t = await r.text().catch(()=>"");
        log(`Error ${r.status}: ${t}`);
        alert(`Error generando YAML:\nHTTP ${r.status}\n${t || "(sin detalle)"}`);
        return;
      }

      const data = await r.json();
      const yaml = data.yaml || "";
      if (ui.out) ui.out.value = yaml;
      log(`OK. Bloques diff: ${data.ops_count}. ${data.saved_to ? "Guardado en: "+data.saved_to : "No se guardó (autosave off)"}`);

      // hint visual
      if (data.saved_to) {
        alert("Receta generada y guardada.\n" + data.saved_to);
      } else {
        alert("Receta generada. Revisa el área “YAML generado”.");
      }
    } catch (e) {
      console.error(e);
      log("Excepción: " + (e?.message || e));
    }
  }

  if (ui.btn) ui.btn.onclick = handleDiff;
})();
</script>

/* ===== Estado común ===== */
const $ = (q,el=document)=>el.querySelector(q);
let TOKEN = localStorage.getItem("EFX_TOKEN") || null;
function needAuth(){
  if(!TOKEN){ alert("Inicia sesión en /static/index.html para usar el admin."); location.href="/static/index.html"; return true; }
  return false;
}
function log(el, msg){ const b=$(el); b.textContent += (b.textContent? "\n":"") + msg; b.scrollTop=b.scrollHeight; }

/* ===== Tabs ===== */
const tabs = document.querySelectorAll(".tab");
tabs.forEach(t => t.addEventListener("click", ()=>{
  tabs.forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  const id = t.dataset.tab;
  document.querySelectorAll("section[id^='tab-']").forEach(s => s.classList.add("hide"));
  $("#tab-"+id).classList.remove("hide");
}));

/* ===== Plantilla YAML ===== */
const TEMPLATE = `meta:
  name: <NAME> (<FAMILY>)
  version: 1
  author: <AUTHOR or TEAM>
  notes: "Breve descripción del parche"

ops:
  # Puedes tener múltiples bloques find/replace
  - find:    "00 00 00 64"
    replace: "00 00 00 C8"
    max_hits: 1

  # Ejemplo con wildcard (?? ignora byte)
  # - find:    "12 34 ?? 78 9A"
  #   replace: "12 34 56 78 9A"
  #   max_hits: 2

checksum:
  type: none
  # si necesitas checksum específico, aquí defines el tipo y parámetros
`;
$("#btnPlantilla").onclick = ()=>{
  $("#yaml_text").value = TEMPLATE;
};

/* ===== Validación simple YAML (sintaxis básica) =====
   No traemos parser YAML aquí para mantenerlo 0-deps; validamos mínimo:
   - no vacío
   - contiene 'ops:' y 'meta:'
*/
$("#btnValidar").onclick = ()=>{
  const y = ($("#yaml_text").value || "").trim();
  const ok = y && /(^|\n)\s*ops\s*:/i.test(y) && /(^|\n)\s*meta\s*:/i.test(y);
  if(ok){ alert("El YAML parece válido (validación básica). Prueba final guardando y aplicando."); }
  else { alert("YAML incompleto: asegúrate de incluir 'meta:' y 'ops:'."); }
};

/* ===== Guardar receta + catálogo ===== */
$("#btnGuardar").onclick = async ()=>{
  if(needAuth()) return;
  const ecu_family = $("#ecu_family").value.trim();
  const patch_id   = $("#patch_id").value.trim();
  const label      = $("#label").value.trim() || patch_id;
  const engines    = ($("#engines").value||"").split(",").map(s=>s.trim()).filter(Boolean);
  const compat     = ($("#compat").value||"").split(",").map(s=>s.trim()).filter(Boolean);
  const price_raw  = $("#price").value.trim();
  const price      = price_raw? Number(price_raw) : undefined;
  const yaml_text  = $("#yaml_text").value;

  if(!ecu_family || !patch_id || !yaml_text){ alert("Faltan campos: ECU Family, Patch ID y YAML son obligatorios."); return; }

  const body = {
    ecu_family, patch_id, label,
    engines: engines.length? engines: null,
    compatible_ecu: compat.length? compat: null,
    price: price ?? null,
    save_catalog: $("#save_catalog").checked,
    yaml_text
  };

  $("#btnGuardar").disabled = true;
  log("#log1", "→ POST /admin/save_recipe …");
  try{
    const r = await fetch("/admin/save_recipe",{
      method:"POST",
      headers:{ "Authorization":"Bearer "+TOKEN, "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const t = await r.text();
    if(!r.ok){ log("#log1","ERROR: "+t); alert("No se pudo guardar: "+t); }
    else { log("#log1","OK: "+t); alert("Receta guardada. (Si marcaste catálogo, global.json actualizado)"); }
  }catch(e){
    log("#log1","ERROR de red: "+e.message);
  }finally{
    $("#btnGuardar").disabled = false;
  }
};

/* ===== Guardar solo YAML (sin tocar catálogo) ===== */
$("#btnGuardarYaml").onclick = async ()=>{
  if(needAuth()) return;
  const ecu_family = $("#ecu_family").value.trim();
  const patch_id   = $("#patch_id").value.trim();
  const yaml_text  = $("#yaml_text").value;
  if(!ecu_family || !patch_id || !yaml_text){ alert("Faltan ECU Family, Patch ID y YAML."); return; }

  $("#btnGuardarYaml").disabled = true;
  log("#log1", "→ POST /admin/save_yaml …");
  try{
    const r = await fetch("/admin/save_yaml",{
      method:"POST",
      headers:{ "Authorization":"Bearer "+TOKEN, "Content-Type":"application/json" },
      body: JSON.stringify({ ecu_family, patch_id, yaml_text })
    });
    const t = await r.text();
    if(!r.ok){ log("#log1","ERROR: "+t); alert("No se pudo guardar: "+t); }
    else { log("#log1","OK: "+t); alert("YAML guardado."); }
  }catch(e){
    log("#log1","ERROR de red: "+e.message);
  }finally{
    $("#btnGuardarYaml").disabled = false;
  }
};

/* ===== Diff → YAML ===== */
<script>
(() => {
  const $ = (q, el=document) => el.querySelector(q);
  let TOKEN = localStorage.getItem("EFX_TOKEN") || null;

  const ui = {
    fam: $("#diff_ecu_family") || $("#ecu_family") || document.querySelector('input[placeholder^="ECU Family"]'),
    pid: $("#diff_patch_id")   || $("#patch_id")   || document.querySelector('input[placeholder^="Patch ID"]'),
    f0:  $("#diff_bin_stock")  || document.querySelectorAll('input[type="file"]')[0],
    f1:  $("#diff_bin_mod")    || document.querySelectorAll('input[type="file"]')[1],
    autoSave: $("#diff_auto")  || document.querySelector('input[type="checkbox"]'),
    btn: $("#diff_go")         || [...document.querySelectorAll("button")].find(b => /Generar YAML/i.test(b.textContent)),
    out: $("#diff_yaml")       || document.querySelector("textarea"),
    log: $("#diff_log")        || document.querySelector(".log")
  };

  const log = (m) => { if(!ui.log) return; ui.log.textContent += (ui.log.textContent ? "\n":"") + m; ui.log.scrollTop = ui.log.scrollHeight; };

  function ensureToken() {
    TOKEN = localStorage.getItem("EFX_TOKEN");
    if (!TOKEN) { alert("Inicia sesión para usar Admin."); throw new Error("Sin token"); }
  }

  async function fileToArrayBuffer(file) {
    return new Uint8Array(await file.arrayBuffer());
  }

  async function handleDiff() {
    try {
      ensureToken();

      const fam = (ui.fam?.value || "").trim();
      let patchId = (ui.pid?.value || "").trim();
      const save = !!ui.autoSave?.checked;

      if (!fam) return alert("ECU Family requerido (ej: MED17, EDC17).");
      if (!patchId) return alert("Patch ID requerido (ej: dpf_off).");
      // normalizar patch id
      patchId = patchId.toLowerCase().replace(/\s+/g, "_").replace(/[^a-z0-9_\-]/g, "");

      const file0 = ui.f0?.files?.[0];
      const file1 = ui.f1?.files?.[0];
      if (!file0 || !file1) return alert("Selecciona BIN stock y BIN mod.");

      // chequeo de tamaños
      const b0 = await fileToArrayBuffer(file0);
      const b1 = await fileToArrayBuffer(file1);
      log(`Stock size: ${b0.length} bytes | Mod size: ${b1.length} bytes`);
      if (b0.length !== b1.length) {
        alert("Los BIN deben tener el MISMO tamaño para este diff simple.");
        return;
      }
      if (b0.length === 0) {
        alert("Archivo vacío.");
        return;
      }

      // armar FormData
      const fd = new FormData();
      fd.append("ecu_family", fam);
      fd.append("patch_id", patchId);
      fd.append("save", String(save));
      fd.append("original_bin", file0, file0.name);
      fd.append("modified_bin", file1, file1.name);

      log("Subiendo a /admin/diff2patch …");
      const r = await fetch("/admin/diff2patch", {
        method: "POST",
        headers: { "Authorization": "Bearer " + TOKEN },
        body: fd
      });

      if (!r.ok) {
        const t = await r.text().catch(()=>"");
        log(`Error ${r.status}: ${t}`);
        alert(`Error generando YAML:\nHTTP ${r.status}\n${t || "(sin detalle)"}`);
        return;
      }

      const data = await r.json();
      const yaml = data.yaml || "";
      if (ui.out) ui.out.value = yaml;
      log(`OK. Bloques diff: ${data.ops_count}. ${data.saved_to ? "Guardado en: "+data.saved_to : "No se guardó (autosave off)"}`);

      // hint visual
      if (data.saved_to) {
        alert("Receta generada y guardada.\n" + data.saved_to);
      } else {
        alert("Receta generada. Revisa el área “YAML generado”.");
      }
    } catch (e) {
      console.error(e);
      log("Excepción: " + (e?.message || e));
    }
  }

  if (ui.btn) ui.btn.onclick = handleDiff;
})();
</script>

<script>
(() => {
  const $ = (q, el=document) => el.querySelector(q);
  const log = (m) => { const b=$("#logBox"); if(!b) return; b.textContent += (b.textContent ? "\n" : "") + m; b.scrollTop=b.scrollHeight; };
  const setOut = (t) => { const o=$("#outYaml"); if(o) o.value = t || ""; };

  // Lee archivo como ArrayBuffer (para validar tamaño) y como File (para subir)
  async function readFileBuf(input) {
    const f = input?.files?.[0];
    if (!f) return { file:null, size:0, buf:null };
    const buf = await f.arrayBuffer();
    return { file:f, size:f.size, buf:new Uint8Array(buf) };
  }

  // Obtiene token guardado por el login del sitio
  function getToken() {
    return localStorage.getItem("EFX_TOKEN") || null;
  }

  async function genYaml() {
    setOut(""); $("#logBox").textContent = "";
    const token = getToken();
    if (!token) { log("Error: no hay sesión. Inicia sesión arriba a la derecha."); return; }

    const fam = $("#ecuFamily")?.value?.trim();
    const pid = $("#patchId")?.value?.trim();
    if (!fam || !pid) { log("Completa ECU Family y Patch ID."); return; }

    log("Leyendo archivos…");
    const st = await readFileBuf($("#binOrig"));
    const md = await readFileBuf($("#binMod"));
    if (!st.file || !md.file) { log("Selecciona BIN original y BIN modificado."); return; }

    if (st.size !== md.size) {
      log(`Error: tamaños distintos. stock=${st.size} bytes, mod=${md.size} bytes`);
      log("El diff simple requiere EXACTAMENTE el mismo tamaño.");
      return;
    }

    const fd = new FormData();
    fd.append("ecu_family", fam);
    fd.append("patch_id", pid);
    fd.append("save", "false"); // guardamos aparte si el checkbox está marcado
    fd.append("original_bin", st.file);
    fd.append("modified_bin", md.file);

    log("Enviando a /admin/diff2patch…");
    let r;
    try {
      r = await fetch("/admin/diff2patch", {
        method: "POST",
        headers: { "Authorization": "Bearer " + token },
        body: fd
      });
    } catch (e) {
      log("Error de red llamando a /admin/diff2patch: " + (e?.message || e));
      return;
    }

    if (!r.ok) {
      const t = await r.text().catch(()=>"(sin cuerpo)");
      log(`Error /admin/diff2patch → HTTP ${r.status}`);
      log(t);
      return;
    }

    const d = await r.json();
    setOut(d.yaml || "");
    log(`OK. Ops encontradas: ${d.ops_count}.`);

    // Guardado automático del YAML como receta
    if ($("#autoSave")?.checked) {
      log("Guardando receta en store/recipes…");
      const body = JSON.stringify({ ecu_family: fam, patch_id: pid, yaml_text: d.yaml || "" });
      const rr = await fetch("/admin/save_yaml", {
        method: "POST",
        headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
        body
      });
      if (!rr.ok) {
        const tt = await rr.text().catch(()=>"(sin cuerpo)");
        log(`Error /admin/save_yaml → HTTP ${rr.status}`);
        log(tt);
      } else {
        const jd = await rr.json().catch(()=>({}));
        log("Receta guardada: " + (jd.path || "(ruta no informada)"));
      }
    }
  }

  // Botón principal
  const btn = document.querySelector('button#btnGenYaml') || document.querySelector('button[data-action="gen-yaml"]') || document.querySelector('button:contains("Generar YAML")');
  if (btn) btn.onclick = genYaml;
  // o, más robusto:
  document.addEventListener("click", (e)=>{
    if (e.target && e.target.matches("#btnGenYaml, [data-action='gen-yaml']")) genYaml();
  });

  // Ayuda visual: al cambiar archivos, imprime tamaños
  ["#binOrig","#binMod"].forEach(sel=>{
    const el = $(sel);
    if (!el) return;
    el.addEventListener("change", async ()=>{
      const inf = await readFileBuf(el);
      if (inf.file) log(`${sel} → ${inf.file.name} (${inf.size} bytes)`);
    });
  });
})();
</script>

</body>
</html>






