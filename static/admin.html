<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ECU FORGE X — Admin de Recetas</title>
<style>
  :root{
    --bg:#0b0f19; --card:#0f1629; --ink:#e5e7eb; --muted:#94a3b8; --stroke:#1f2a44;
    --brand:#0b1220; --btn:#2563eb; --btnh:#1d4ed8; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial}
  header{background:var(--brand);color:#fff;display:flex;align-items:center;gap:12px;padding:14px 18px}
  header .grow{flex:1}
  a{color:#93c5fd;text-decoration:none}
  .wrap{padding:18px;display:grid;gap:18px;grid-template-columns:1fr}
  .tabs{display:flex;gap:8px}
  .tab{padding:10px 12px;border:1px solid var(--stroke);border-bottom:none;border-radius:10px 10px 0 0;background:#0e1526;cursor:pointer}
  .tab.active{background:var(--card)}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:16px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  label{font-size:13px;color:var(--muted)}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--stroke);background:#0e1526;color:var(--ink)}
  textarea{min-height:260px;font-family:ui-monospace,Consolas,Menlo}
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .row3{display:grid;gap:12px;grid-template-columns:1fr 1fr 1fr}
  .btn{background:var(--btn);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn:hover{background:var(--btnh)}
  .btn.ghost{background:transparent;border:1px solid var(--stroke)}
  .btn.ok{background:var(--ok);color:#01240c}
  .btn.warn{background:var(--warn);color:#231600}
  .btn.err{background:var(--err)}
  .muted{color:var(--muted);font-size:13px}
  .log{background:#000;color:#00ff72;font-family:ui-monospace,Consolas,Menlo;min-height:140px;border-radius:8px;padding:12px;overflow:auto}
  .hint{font-size:12px;color:var(--muted)}
  .divider{height:1px;background:var(--stroke);margin:10px 0}
  .badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#182038;color:#dbe2ff;font-size:12px}
  .hide{display:none}
  .right{display:flex;gap:10px;justify-content:flex-end}
</style>
</head>
<body>
<header>
  <strong>ECU FORGE X — Admin</strong>
  <span class="badge">Recetas YAML</span>
  <div class="grow"></div>
  <a href="/static/index.html">← Volver</a>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tab active" data-tab="recetas">Editor de recetas</button>
    <button class="tab" data-tab="diff">Diff → YAML</button>
  </div>

  <!-- ======= Editor de Recetas ======= -->
  <section id="tab-recetas" class="card">
    <div class="grid g2">
      <div>
        <label>ECU Family (carpeta)</label>
        <input id="ecu_family" placeholder="Ej: MED17, MG1, EDC17"/>
      </div>
      <div>
        <label>Patch ID (nombre archivo)</label>
        <input id="patch_id" placeholder="Ej: speed_limiter, dpf_off"/>
      </div>
    </div>

    <div class="grid g2">
      <div>
        <label>Label (catálogo)</label>
        <input id="label" placeholder="Ej: Speed Limiter OFF"/>
      </div>
      <div>
        <label>Precio USD (opcional)</label>
        <input id="price" type="number" min="0" step="1" placeholder="Ej: 49"/>
      </div>
    </div>

    <div class="grid g2">
      <div>
        <label>Engines (coma)</label>
        <input id="engines" placeholder="petrol,diesel"/>
      </div>
      <div>
        <label>Compatible ECU (coma)</label>
        <input id="compat" placeholder="MED17,MG1,EDC17,MD1"/>
      </div>
    </div>

    <div>
      <label class="muted"><input type="checkbox" id="save_catalog" checked/> Actualizar catálogo (static/patches/global.json)</label>
    </div>

    <div>
      <label>YAML de la receta</label>
      <textarea id="yaml_text" spellcheck="false" placeholder="Pega/edita tu YAML aquí…"></textarea>
      <div class="hint">Ruta destino: <code>storage/recipes/&lt;ECU Family&gt;/&lt;Patch ID&gt;.yml</code></div>
    </div>

    <div class="right">
      <button class="btn ghost" id="btnPlantilla">Cargar plantilla</button>
      <button class="btn warn" id="btnValidar">Validar YAML</button>
      <button class="btn" id="btnGuardarYaml">Guardar sin catálogo</button>
      <button class="btn ok" id="btnGuardar">Guardar receta + catálogo</button>
    </div>

    <div class="divider"></div>
    <div>
      <label>Log</label>
      <div id="log1" class="log">Listo.</div>
    </div>
  </section>

  <!-- ======= Diff → YAML ======= -->
  <section id="tab-diff" class="card hide">
    <div class="grid g2">
      <div>
        <label>ECU Family</label>
        <input id="df_ecu_family" placeholder="Ej: MED17"/>
      </div>
      <div>
        <label>Patch ID</label>
        <input id="df_patch_id" placeholder="Ej: speed_limiter"/>
      </div>
    </div>

    <div class="grid g2">
      <div>
        <label>BIN original (stock)</label>
        <input id="df_orig" type="file" />
      </div>
      <div>
        <label>BIN modificado</label>
        <input id="df_mod" type="file" />
      </div>
    </div>

    <div>
      <label class="muted"><input type="checkbox" id="df_save"/> Guardar receta automáticamente</label>
    </div>

    <div class="right">
      <button class="btn" id="btnDiff">Generar YAML</button>
    </div>

    <div class="divider"></div>

    <div>
      <label>YAML generado</label>
      <textarea id="df_yaml" spellcheck="false" placeholder="Aquí aparecerá la receta YAML generada…"></textarea>
    </div>

    <div class="divider"></div>
    <div>
      <label>Log</label>
      <div id="log2" class="log">Esperando archivos…</div>
    </div>
  </section>
</div>

<script>
/* ===== Estado común ===== */
const $ = (q,el=document)=>el.querySelector(q);
let TOKEN = localStorage.getItem("EFX_TOKEN") || null;
function needAuth(){
  if(!TOKEN){ alert("Inicia sesión en /static/index.html para usar el admin."); location.href="/static/index.html"; return true; }
  return false;
}
function log(el, msg){ const b=$(el); b.textContent += (b.textContent? "\n":"") + msg; b.scrollTop=b.scrollHeight; }

/* ===== Tabs ===== */
const tabs = document.querySelectorAll(".tab");
tabs.forEach(t => t.addEventListener("click", ()=>{
  tabs.forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  const id = t.dataset.tab;
  document.querySelectorAll("section[id^='tab-']").forEach(s => s.classList.add("hide"));
  $("#tab-"+id).classList.remove("hide");
}));

/* ===== Plantilla YAML ===== */
const TEMPLATE = `meta:
  name: <NAME> (<FAMILY>)
  version: 1
  author: <AUTHOR or TEAM>
  notes: "Breve descripción del parche"

ops:
  # Puedes tener múltiples bloques find/replace
  - find:    "00 00 00 64"
    replace: "00 00 00 C8"
    max_hits: 1

  # Ejemplo con wildcard (?? ignora byte)
  # - find:    "12 34 ?? 78 9A"
  #   replace: "12 34 56 78 9A"
  #   max_hits: 2

checksum:
  type: none
  # si necesitas checksum específico, aquí defines el tipo y parámetros
`;
$("#btnPlantilla").onclick = ()=>{
  $("#yaml_text").value = TEMPLATE;
};

/* ===== Validación simple YAML (sintaxis básica) =====
   No traemos parser YAML aquí para mantenerlo 0-deps; validamos mínimo:
   - no vacío
   - contiene 'ops:' y 'meta:'
*/
$("#btnValidar").onclick = ()=>{
  const y = ($("#yaml_text").value || "").trim();
  const ok = y && /(^|\n)\s*ops\s*:/i.test(y) && /(^|\n)\s*meta\s*:/i.test(y);
  if(ok){ alert("El YAML parece válido (validación básica). Prueba final guardando y aplicando."); }
  else { alert("YAML incompleto: asegúrate de incluir 'meta:' y 'ops:'."); }
};

/* ===== Guardar receta + catálogo ===== */
$("#btnGuardar").onclick = async ()=>{
  if(needAuth()) return;
  const ecu_family = $("#ecu_family").value.trim();
  const patch_id   = $("#patch_id").value.trim();
  const label      = $("#label").value.trim() || patch_id;
  const engines    = ($("#engines").value||"").split(",").map(s=>s.trim()).filter(Boolean);
  const compat     = ($("#compat").value||"").split(",").map(s=>s.trim()).filter(Boolean);
  const price_raw  = $("#price").value.trim();
  const price      = price_raw? Number(price_raw) : undefined;
  const yaml_text  = $("#yaml_text").value;

  if(!ecu_family || !patch_id || !yaml_text){ alert("Faltan campos: ECU Family, Patch ID y YAML son obligatorios."); return; }

  const body = {
    ecu_family, patch_id, label,
    engines: engines.length? engines: null,
    compatible_ecu: compat.length? compat: null,
    price: price ?? null,
    save_catalog: $("#save_catalog").checked,
    yaml_text
  };

  $("#btnGuardar").disabled = true;
  log("#log1", "→ POST /admin/save_recipe …");
  try{
    const r = await fetch("/admin/save_recipe",{
      method:"POST",
      headers:{ "Authorization":"Bearer "+TOKEN, "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const t = await r.text();
    if(!r.ok){ log("#log1","ERROR: "+t); alert("No se pudo guardar: "+t); }
    else { log("#log1","OK: "+t); alert("Receta guardada. (Si marcaste catálogo, global.json actualizado)"); }
  }catch(e){
    log("#log1","ERROR de red: "+e.message);
  }finally{
    $("#btnGuardar").disabled = false;
  }
};

/* ===== Guardar solo YAML (sin tocar catálogo) ===== */
$("#btnGuardarYaml").onclick = async ()=>{
  if(needAuth()) return;
  const ecu_family = $("#ecu_family").value.trim();
  const patch_id   = $("#patch_id").value.trim();
  const yaml_text  = $("#yaml_text").value;
  if(!ecu_family || !patch_id || !yaml_text){ alert("Faltan ECU Family, Patch ID y YAML."); return; }

  $("#btnGuardarYaml").disabled = true;
  log("#log1", "→ POST /admin/save_yaml …");
  try{
    const r = await fetch("/admin/save_yaml",{
      method:"POST",
      headers:{ "Authorization":"Bearer "+TOKEN, "Content-Type":"application/json" },
      body: JSON.stringify({ ecu_family, patch_id, yaml_text })
    });
    const t = await r.text();
    if(!r.ok){ log("#log1","ERROR: "+t); alert("No se pudo guardar: "+t); }
    else { log("#log1","OK: "+t); alert("YAML guardado."); }
  }catch(e){
    log("#log1","ERROR de red: "+e.message);
  }finally{
    $("#btnGuardarYaml").disabled = false;
  }
};

/* ===== Diff → YAML ===== */
$("#btnDiff").onclick = async ()=>{
  if(needAuth()) return;
  const fam = $("#df_ecu_family").value.trim();
  const pid = $("#df_patch_id").value.trim();
  const f1  = $("#df_orig").files[0];
  const f2  = $("#df_mod").files[0];
  const save= $("#df_save").checked;

  if(!fam || !pid || !f1 || !f2){ alert("Completa ECU Family, Patch ID y selecciona ambos BIN."); return; }

  $("#btnDiff").disabled = true;
  log("#log2", "→ POST /admin/diff2patch …");

  const fd = new FormData();
  fd.append("ecu_family", fam);
  fd.append("patch_id",   pid);
  fd.append("save",       String(save));
  fd.append("original_bin", f1);
  fd.append("modified_bin", f2);

  try{
    const r = await fetch("/admin/diff2patch",{
      method:"POST",
      headers:{ "Authorization":"Bearer "+TOKEN },
      body: fd
    });
    const js = await r.json().catch(async()=>({raw: await r.text(), err: true}));
    if(!r.ok){ log("#log2","ERROR: "+(js.raw||JSON.stringify(js))); alert("No se pudo generar: revisa que ambos BIN tengan el mismo tamaño."); }
    else {
      $("#df_yaml").value = js.yaml || "";
      log("#log2", `OK. ops_count=${js.ops_count}. ${js.saved_to? "Guardado en: "+js.saved_to:"(no guardado, solo generado)"}`);
      alert("YAML generado. Revísalo y, si quieres, ajústalo en el editor de recetas.");
    }
  }catch(e){
    log("#log2","ERROR de red: "+e.message);
  }finally{
    $("#btnDiff").disabled = false;
  }
};
</script>
</body>
</html>
