<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ECU FORGE X — Admin de Recetas</title>
<style>
  /* ====== PALETA CON ALTO CONTRASTE ====== */
  :root{
    --bg:#070b14;           /* más oscuro */
    --card:#0c1222;         /* paneles */
    --ink:#f1f5f9;          /* texto principal más claro */
    --muted:#cbd5e1;        /* texto secundario más claro */
    --stroke:#26334f;       /* bordes */
    --brand:#0b1220;
    --btn:#1e40af;          /* azul profundo */
    --btnh:#1d4ed8;         /* hover */
    --ok:#16a34a;           /* verde alto contraste */
    --warn:#f59e0b;         /* ámbar */
    --err:#ef4444;          /* rojo */
    --focus:#93c5fd;        /* anillo de enfoque */
    --ink-strong:#ffffff;   /* blanco puro para headers/badges */
  }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial}
  a{color:#a5b4fc;text-decoration:none}
  header{background:var(--brand);color:var(--ink-strong);display:flex;align-items:center;gap:12px;padding:14px 18px}
  header .grow{flex:1}

  .wrap{padding:18px;display:grid;gap:18px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:10px 12px;border:1px solid var(--stroke);border-bottom:none;border-radius:10px 10px 0 0;background:#0b1429;cursor:pointer;color:var(--ink)}
  .tab.active{background:var(--card);font-weight:700;color:var(--ink-strong)}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:16px}

  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  label{font-size:13px;color:var(--muted)}
  input,select,textarea,button{font:inherit}
  input,select,textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--stroke);
    background:#0b1429;color:var(--ink)
  }
  input:focus,select:focus,textarea:focus,.btn:focus{
    outline:2px solid var(--focus); outline-offset:2px;
  }
  textarea{min-height:260px;font-family:ui-monospace,Consolas,Menlo}

  .right{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
  .divider{height:1px;background:var(--stroke);margin:10px 0}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#182038;color:#eaf0ff;font-size:12px;border:1px solid #2a3b67}
  .hide{display:none}

  /* ====== BOTONES ALTO CONTRASTE ====== */
  .btn{
    background:var(--btn);color:#fff;border:0;border-radius:12px;padding:12px 18px;cursor:pointer;
    letter-spacing:.3px;font-weight:700;box-shadow:0 0 0 1px #122a7a, 0 6px 16px rgba(0,0,0,.4);
    transition:transform .05s ease, filter .12s ease, box-shadow .12s ease
  }
  .btn:hover{filter:brightness(1.12)}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#475569;box-shadow:0 0 0 1px #374151,0 6px 16px rgba(0,0,0,.4)}
  .btn.success{background:var(--ok);box-shadow:0 0 0 1px #166534,0 6px 16px rgba(0,0,0,.4);color:#00150a}
  .btn.warning{background:var(--warn);box-shadow:0 0 0 1px #b45309,0 6px 16px rgba(0,0,0,.4);color:#111827}
  .btn.ghost{background:transparent;border:1px solid var(--stroke)}
  .btn.small{padding:10px 14px;border-radius:10px}

  .muted{color:var(--muted);font-size:13px}
  .log{
    background:#000;color:#e6fffa;font-family:ui-monospace,Menlo,Consolas;min-height:140px;
    border-radius:10px;padding:12px;overflow:auto;border:1px solid #0b2830
  }
</style>
</head>
<body>
<header>
  <strong>ECU FORGE X — Admin</strong>
  <span class="badge">Recetas YAML</span>
  <div class="grow"></div>
  <a href="/static/index.html">← Volver</a>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tab active" data-tab="recetas">Editor de recetas</button>
    <button class="tab" data-tab="diff">Diff → YAML</button>
  </div>

  <!-- ======= Editor de Recetas ======= -->
  <section id="tab-recetas" class="card">
    <div class="grid g2">
      <div>
        <label>ECU Family (carpeta)</label>
        <input id="ecu_family" placeholder="Ej: EDC17CP45, MED17, MG1, MD1"/>
      </div>
      <div>
        <label>Patch ID (nombre archivo)</label>
        <input id="patch_id" placeholder="Ej: speed_limiter, dpf_off"/>
      </div>
    </div>

    <div class="grid g2">
      <div>
        <label>Label (catálogo)</label>
        <input id="label" placeholder="Ej: Speed Limiter OFF"/>
      </div>
      <div>
        <label>Precio USD (opcional)</label>
        <input id="price" type="number" min="0" step="1" placeholder="Ej: 49"/>
      </div>
    </div>

    <div class="grid g2">
      <div>
        <label>Engines (coma)</label>
        <input id="engines" placeholder="petrol,diesel"/>
      </div>
      <div>
        <label>Compatible ECU (coma)</label>
        <input id="compat" placeholder="MED17,MG1,EDC17,MD1"/>
      </div>
    </div>

    <div>
      <label class="muted"><input type="checkbox" id="save_catalog" checked/> Actualizar catálogo (static/patches/global.json)</label>
    </div>

    <div>
      <label>YAML de la receta</label>
      <textarea id="yaml_text" spellcheck="false" placeholder="Pega/edita tu YAML aquí…"></textarea>
      <div class="hint muted">Ruta destino: <code>storage/recipes/&lt;ECU Family&gt;/&lt;Patch ID&gt;.yml</code></div>
    </div>

    <div class="right">
      <button class="btn" id="btnPlantilla">Cargar plantilla</button>
      <button class="btn secondary" id="btnPlantilla2">Cargar plantilla</button>
      <button class="btn warning" id="btnValidar">Validar YAML</button>
      <button class="btn" id="btnGuardarYaml">Guardar sin catálogo</button>
      <button class="btn success" id="btnGuardar">Guardar receta + catálogo</button>
    </div>

    <!-- inputs de archivo ocultos -->
    <input type="file" id="tplFile1" class="tpl-input" accept=".yml,.yaml,.json,.txt" style="display:none"/>
    <input type="file" id="tplFile2" class="tpl-input" accept=".yml,.yaml,.json,.txt" style="display:none"/>

    <div class="divider"></div>
    <div>
      <label>Log</label>
      <div id="log1" class="log">Listo.</div>
    </div>
  </section>

  <!-- ======= Diff → YAML ======= -->
  <section id="tab-diff" class="card hide">
    <div class="grid g2">
      <div>
        <label>ECU Family (validación)</label>
        <input id="diff_ecu_family" placeholder="Ej: EDC17CP45, MEVD17, MD1CS004"/>
      </div>
      <div>
        <label>Patch ID</label>
        <input id="diff_patch_id" placeholder="Ej: dpf_off"/>
      </div>
    </div>

    <div class="grid g2">
      <div>
        <label>BIN Stock</label>
        <input id="diff_bin_stock" type="file" />
      </div>
      <div>
        <label>BIN Modificado</label>
        <input id="diff_bin_mod" type="file" />
      </div>
    </div>

    <div class="grid g2">
      <label class="muted"><input type="checkbox" id="diff_auto" /> Guardar automáticamente en /storage/recipes</label>
      <div class="right"><button id="diff_go" class="btn small">Generar YAML</button></div>
    </div>

    <div class="divider"></div>
    <div>
      <label>YAML generado</label>
      <textarea id="diff_yaml" spellcheck="false" placeholder="Aquí aparecerá el YAML generado…"></textarea>
    </div>

    <div class="divider"></div>
    <div>
      <label>Log</label>
      <div id="diff_log" class="log"></div>
    </div>
  </section>
</div>

<script>
/* ===== Helpers / Estado común ===== */
const $ = (q,el=document)=>el.querySelector(q);
let TOKEN = localStorage.getItem("EFX_TOKEN") || null;

function needAuth(){
  if(!TOKEN){
    alert("Inicia sesión en /static/index.html para usar el admin.");
    return true;
  }
  return false;
}
function elog(el, msg){
  const box=$(el); if(!box) return;
  box.textContent += (box.textContent? "\n":"") + msg;
  box.scrollTop = box.scrollHeight;
}

/* ===== Tabs ===== */
document.querySelectorAll(".tab").forEach(t => t.addEventListener("click", ()=>{
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  const id = t.dataset.tab;
  document.querySelectorAll("section[id^='tab-']").forEach(s => s.classList.add("hide"));
  $("#tab-"+id)?.classList.remove("hide");
}));

/* ===== Plantilla YAML (rápida) ===== */
const TEMPLATE = `meta:
  name: <NAME> (<FAMILY>)
  version: 1
  author: <AUTHOR or TEAM>
  notes: "Breve descripción del parche"

ops:
  - find:    "00 00 00 64"
    replace: "00 00 00 C8"
    max_hits: 1

checksum:
  type: none
`;
$("#btnPlantilla").onclick = ()=>{ $("#yaml_text").value = TEMPLATE; };

/* ===== Cargar plantilla desde archivo (ambos botones) ===== */
function wireTemplateButton(btnSel, fileSel){
  const btn=$(btnSel), fin=$(fileSel); if(!btn||!fin) return;
  btn.addEventListener("click", e => { e.preventDefault(); fin.click(); });
  fin.addEventListener("change", async () => {
    const f = fin.files?.[0]; if(!f) return;
    const txt = await f.text().catch(()=> "");
    $("#yaml_text").value = txt;
  });
}
wireTemplateButton("#btnPlantilla2", "#tplFile2"); // segundo botón (el primero pega la demo)

/* ===== Validación simple YAML ===== */
$("#btnValidar").onclick = ()=>{
  const y = ($("#yaml_text").value || "").trim();
  const ok = y && /(^|\n)\s*ops\s*:/i.test(y) && /(^|\n)\s*meta\s*:/i.test(y);
  alert(ok ? "El YAML parece válido (básico)." : "YAML incompleto: falta 'meta:' u 'ops:'.");
};

/* ===== Guardar receta + catálogo ===== */
$("#btnGuardar").onclick = async ()=>{
  if(needAuth()) return;
  const ecu_family = $("#ecu_family").value.trim();
  const patch_id   = $("#patch_id").value.trim();
  const label      = $("#label").value.trim() || patch_id;
  const engines    = ($("#engines").value||"").split(",").map(s=>s.trim()).filter(Boolean);
  const compat     = ($("#compat").value||"").split(",").map(s=>s.trim()).filter(Boolean);
  const price_raw  = $("#price").value.trim();
  const price      = price_raw? Number(price_raw) : undefined;
  const yaml_text  = $("#yaml_text").value;

  if(!ecu_family || !patch_id || !yaml_text){
    alert("Faltan ECU Family, Patch ID o YAML."); return;
  }

  const body = {
    ecu_family, patch_id, label,
    engines: engines.length? engines: null,
    compatible_ecu: compat.length? compat: null,
    price: price ?? null,
    save_catalog: $("#save_catalog").checked,
    yaml_text
  };

  $("#btnGuardar").disabled = true;
  elog("#log1", "→ POST /admin/save_recipe …");
  try{
    const r = await fetch("/admin/save_recipe",{
      method:"POST",
      headers:{ "Authorization":"Bearer "+TOKEN, "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const t = await r.text();
    if(!r.ok){ elog("#log1","ERROR: "+t); alert("No se pudo guardar: "+t); }
    else { elog("#log1","OK: "+t); alert("Receta guardada (catálogo actualizado si marcaste la casilla)."); }
  }catch(e){
    elog("#log1","ERROR de red: "+(e?.message||e));
  }finally{
    $("#btnGuardar").disabled = false;
  }
};

/* ===== Guardar solo YAML ===== */
$("#btnGuardarYaml").onclick = async ()=>{
  if(needAuth()) return;
  const ecu_family = $("#ecu_family").value.trim();
  const patch_id   = $("#patch_id").value.trim();
  const yaml_text  = $("#yaml_text").value;
  if(!ecu_family || !patch_id || !yaml_text){
    alert("Faltan ECU Family, Patch ID y/o YAML."); return;
  }

  $("#btnGuardarYaml").disabled = true;
  elog("#log1", "→ POST /admin/save_yaml …");
  try{
    const r = await fetch("/admin/save_yaml",{
      method:"POST",
      headers:{ "Authorization":"Bearer "+TOKEN, "Content-Type":"application/json" },
      body: JSON.stringify({ ecu_family, patch_id, yaml_text })
    });
    const t = await r.text();
    if(!r.ok){ elog("#log1","ERROR: "+t); alert("No se pudo guardar: "+t); }
    else { elog("#log1","OK: "+t); alert("YAML guardado."); }
  }catch(e){
    elog("#log1","ERROR de red: "+(e?.message||e));
  }finally{
    $("#btnGuardarYaml").disabled = false;
  }
};

/* ===== Diff → YAML (completo) ===== */
(function(){
  const ui = {
    fam: $("#diff_ecu_family"),
    pid: $("#diff_patch_id"),
    f0:  $("#diff_bin_stock"),
    f1:  $("#diff_bin_mod"),
    autoSave: $("#diff_auto"),
    btn: $("#diff_go"),
    out: $("#diff_yaml"),
    log: $("#diff_log")
  };

  const log = (m) => { if(!ui.log) return; ui.log.textContent += (ui.log.textContent ? "\n":"") + m; ui.log.scrollTop = ui.log.scrollHeight; };

  function ensureToken() {
    TOKEN = localStorage.getItem("EFX_TOKEN");
    if (!TOKEN) { alert("Inicia sesión para usar Admin."); throw new Error("Sin token"); }
  }
  const fileToArr = async (f)=> new Uint8Array(await f.arrayBuffer());

  // Normalizador/validador de familia ECU
  function normalizeFamily(raw){
    const fam = (raw || "").trim().toUpperCase();
    const ok = /(MEVD?17|MED17|EDC17|MD1|MG1)/.test(fam);
    return {fam, ok};
  }

  let working=false;
  async function handleDiff(ev){
    try{
      ev?.preventDefault?.();
      if(working) return;
      working=true; ui.btn.disabled=true;

      ensureToken();

      const {fam, ok} = normalizeFamily(ui.fam?.value);
      let patchId = (ui.pid?.value || "").trim();
      const save = !!ui.autoSave?.checked;

      if(!fam){ alert("ECU Family requerido (ej: EDC17CP45, MEVD17, MD1, MG1)."); return; }
      if(!ok){ alert("ECU Family debe contener MEVD17 / MED17 / EDC17 / MD1 / MG1."); return; }
      if(!patchId){ alert("Patch ID requerido (ej: dpf_off)."); return; }
      patchId = patchId.toLowerCase().replace(/\s+/g, "_").replace(/[^a-z0-9_\-]/g, "");

      const file0 = ui.f0?.files?.[0];
      const file1 = ui.f1?.files?.[0];
      if(!file0 || !file1){ alert("Selecciona BIN stock y BIN mod."); return; }

      const b0 = await fileToArr(file0);
      const b1 = await fileToArr(file1);
      log(`Stock size: ${b0.length} bytes | Mod size: ${b1.length} bytes`);
      if(b0.length !== b1.length){ alert("Los BIN deben tener el MISMO tamaño."); return; }
      if(b0.length === 0){ alert("Archivo vacío."); return; }

      const fd = new FormData();
      fd.append("ecu_family", fam);
      fd.append("patch_id", patchId);
      fd.append("save", String(save));
      fd.append("original_bin", file0, file0.name);
      fd.append("modified_bin", file1, file1.name);

      log("POST /admin/diff2patch …");
      const r = await fetch("/admin/diff2patch", {
        method: "POST",
        headers: { "Authorization": "Bearer " + TOKEN },
        body: fd
      });

      const text = await r.text().catch(()=> "");
      if(!r.ok){
        log(`HTTP ${r.status}: ${text || "(sin detalle)"}`);
        alert(`Error generando YAML:\nHTTP ${r.status}\n${text || "(sin detalle)"}`);
        return;
      }

      let data={};
      try{ data = text ? JSON.parse(text) : {}; }catch{ data={}; }
      const yaml = data.yaml || "";
      if(ui.out) ui.out.value = yaml;

      log(`OK. Bloques diff: ${data.ops_count ?? "?"}. ${data.saved_to ? "Guardado en: "+data.saved_to : "No se guardó (autosave off)"}`);
      alert(data.saved_to ? `Receta generada y guardada:\n${data.saved_to}`
                          : "Receta generada. Revisa el área “YAML generado”.");
    }catch(e){
      console.error(e);
      log("Excepción: " + (e?.message || e));
      alert("Excepción en el cliente: " + (e?.message || e));
    }finally{
      working=false; ui.btn.disabled=false;
    }
  }

  ui.btn?.addEventListener("click", handleDiff);
})();
</script>
</body>
</html>
