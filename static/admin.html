<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ECU FORGE X ‚Äî Admin de Recetas</title>
<style>
  :root{
    --bg:#070b14; --card:#0c1222; --ink:#f1f5f9; --muted:#cbd5e1;
    --stroke:#26334f; --brand:#0b1220; --btn:#1e40af; --btnh:#1d4ed8;
    --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --focus:#93c5fd; --ink-strong:#ffffff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial}
  a{color:#a5b4fc;text-decoration:none}
  header{background:var(--brand);color:var(--ink-strong);display:flex;align-items:center;gap:12px;padding:14px 18px}
  header .grow{flex:1}

  .wrap{padding:18px;display:grid;gap:18px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab{padding:10px 12px;border:1px solid var(--stroke);border-bottom:none;border-radius:10px 10px 0 0;background:#0b1429;cursor:pointer;color:var(--ink)}
  .tab.active{background:var(--card);font-weight:700;color:var(--ink-strong)}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:16px}

  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  label{font-size:13px;color:var(--muted)}
  input,select,textarea,button{font:inherit}
  input,select,textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid var(--stroke);
    background:#0b1429;color:var(--ink)
  }
  input:focus,select:focus,textarea:focus,.btn:focus{outline:2px solid var(--focus); outline-offset:2px;}
  textarea{min-height:260px;font-family:ui-monospace,Consolas,Menlo}

  .right{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
  .divider{height:1px;background:var(--stroke);margin:10px 0}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#182038;color:#eaf0ff;font-size:12px;border:1px solid #2a3b67}
  .hide{display:none}

  .btn{
    background:var(--btn);color:#fff;border:0;border-radius:12px;padding:12px 18px;cursor:pointer;
    letter-spacing:.3px;font-weight:700;box-shadow:0 0 0 1px #122a7a, 0 6px 16px rgba(0,0,0,.4);
    transition:transform .05s ease, filter .12s ease, box-shadow .12s ease
  }
  .btn:hover{filter:brightness(1.12)}
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#475569;box-shadow:0 0 0 1px #374151,0 6px 16px rgba(0,0,0,.4)}
  .btn.success{background:var(--ok);box-shadow:0 0 0 1px #166534,0 6px 16px rgba(0,0,0,.4);color:#00150a}
  .btn.warning{background:var(--warn);box-shadow:0 0 0 1px #b45309,0 6px 16px rgba(0,0,0,.4);color:#111827}
  .btn.ghost{background:transparent;border:1px solid var(--stroke)}
  .btn.small{padding:10px 14px;border-radius:10px}

  .muted{color:var(--muted);font-size:13px}
  .log{
    background:#000;color:#e6fffa;font-family:ui-monospace,Menlo,Consolas;min-height:140px;
    border-radius:10px;padding:12px;overflow:auto;border:1px solid #0b2830
  }
</style>
</head>
<body>
<header>
  <strong>ECU FORGE X ‚Äî Admin</strong>
  <span class="badge">Recetas YAML</span>
  <div class="grow"></div>
  <a href="/static/index.html">‚Üê Volver</a>
</header>

<div class="wrap">
  <div class="tabs">
    <button class="tab active" data-tab="recetas">Editor de recetas</button>
    <button class="tab" data-tab="diff">Diff ‚Üí YAML</button>
  </div>

  <!-- ======= Editor de Recetas ======= -->
  <section id="tab-recetas" class="card">
    <div class="grid g2">
      <div>
        <label>ECU Family (carpeta)</label>
        <input id="ecu_family" placeholder="Ej: EDC17C81, EDC17CP45, MED17, MG1, MD1"/>
      </div>
      <div>
        <label>Patch ID (nombre archivo)</label>
        <input id="patch_id" placeholder="Ej: speed_limiter, dpf_off"/>
      </div>
    </div>

    <div class="grid g2">
      <div>
        <label>Label (cat√°logo)</label>
        <input id="label" placeholder="Ej: Speed Limiter OFF"/>
      </div>
      <div>
        <label>Precio USD (opcional)</label>
        <input id="price" type="number" min="0" step="1" placeholder="Ej: 49"/>
      </div>
    </div>

    <div class="grid g2">
      <div>
        <label>Engines (coma)</label>
        <input id="engines" placeholder="petrol,diesel"/>
      </div>
      <div>
        <label>Compatible ECU (coma)</label>
        <input id="compat" placeholder="MED17,MG1,EDC17,MD1"/>
      </div>
    </div>

    <div>
      <label class="muted"><input type="checkbox" id="save_catalog" checked/> Actualizar cat√°logo (static/patches/global.json)</label>
    </div>

    <div>
      <label>YAML de la receta</label>
      <textarea id="yaml_text" spellcheck="false" placeholder="Pega/edita tu YAML aqu√≠‚Ä¶"></textarea>
      <div class="hint muted">Ruta destino: <code>storage/recipes/&lt;ECU Family&gt;/&lt;Patch ID&gt;.yml</code></div>
    </div>

    <div class="right">
      <button class="btn" id="btnPlantilla">Cargar plantilla</button>
      <button class="btn secondary" id="btnPlantilla2">Cargar plantilla (archivo)</button>
      <button class="btn warning" id="btnValidar">Validar YAML</button>
      <button class="btn" id="btnGuardarYaml">Guardar sin cat√°logo</button>
      <button class="btn success" id="btnGuardar">Guardar receta + cat√°logo</button>
      <button class="btn ghost" id="btnExport">‚¨áÔ∏è Descargar recetas (.zip)</button>
    </div>

    <input type="file" id="tplFile2" accept=".yml,.yaml,.json,.txt" style="display:none"/>

    <div class="divider"></div>
    <div>
      <label>Log</label>
      <div id="log1" class="log">Listo.</div>
    </div>
  </section>

  <!-- ======= Diff ‚Üí YAML ======= -->
  <section id="tab-diff" class="card hide">
    <div class="grid g2">
      <div>
        <label>ECU Family (validaci√≥n)</label>
        <input id="diff_ecu_family" placeholder="Ej: EDC17C81, EDC17CP45, MEVD17, MD1CS004"/>
      </div>
      <div>
        <label>Patch ID</label>
        <input id="diff_patch_id" placeholder="Ej: dpf_off"/>
      </div>
    </div>

    <div class="grid g2">
      <div>
        <label>BIN Stock</label>
        <input id="diff_bin_stock" type="file" />
      </div>
      <div>
        <label>BIN Modificado</label>
        <input id="diff_bin_mod" type="file" />
      </div>
    </div>

    <div class="divider"></div>

    <!-- Fingerprint -->
    <div class="grid g2">
      <div>
        <label>SW number / offset</label>
        <input id="fp_sw" placeholder='Ej: 10SW05263416 / $10001A' />
      </div>
      <div>
        <label>MPC type / offset</label>
        <input id="fp_mpc" placeholder='Ej: BASE_ECU TC1782 / $1000FD' />
      </div>
    </div>

    <div class="grid g2">
      <div>
        <label>ECU type label / offset</label>
        <input id="fp_ecu" placeholder='Ej: BOSCH EDC17C81 / $1000EE' />
      </div>
      <div class="right">
        <button id="fp_calc" class="btn secondary small">üß¨ Calcular huellas (Stock/Mod)</button>
        <button id="fp_copy" class="btn small">üìã Copiar bloque</button>
      </div>
    </div>

    <div>
      <label>Bloque copiable (SHA256 / CVN / Size + Offsets)</label>
      <textarea id="fp_out" spellcheck="false" placeholder="Aqu√≠ aparecer√°n las huellas‚Ä¶"></textarea>
      <div class="muted">Tip: esto te obliga a guardar el SHA-256 exacto del stock base.</div>
    </div>

    <div class="grid g2">
      <label class="muted"><input type="checkbox" id="diff_auto" /> Guardar autom√°ticamente en /storage/recipes</label>
      <div class="right"><button id="diff_go" class="btn small">Generar YAML</button></div>
    </div>

    <div class="divider"></div>
    <div>
      <label>YAML generado</label>
      <textarea id="diff_yaml" spellcheck="false" placeholder="Aqu√≠ aparecer√° el YAML generado‚Ä¶"></textarea>
    </div>

    <div class="divider"></div>
    <div>
      <label>Log</label>
      <div id="diff_log" class="log"></div>
    </div>
  </section>
</div>

<script>
const $ = (q,el=document)=>el.querySelector(q);
let TOKEN = localStorage.getItem("EFX_TOKEN") || null;

function needAuth(){
  if(!TOKEN){
    alert("Inicia sesi√≥n en /static/index.html para usar el admin.");
    return true;
  }
  return false;
}
function elog(sel, msg){
  const box=$(sel); if(!box) return;
  box.textContent += (box.textContent? "\n":"") + msg;
  box.scrollTop = box.scrollHeight;
}
</script>

<script>
/* Tabs */
document.querySelectorAll(".tab").forEach(t => t.addEventListener("click", ()=>{
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  const id = t.dataset.tab;
  document.querySelectorAll("section[id^='tab-']").forEach(s => s.classList.add("hide"));
  $("#tab-"+id)?.classList.remove("hide");
}));

/* Plantilla YAML */
const TEMPLATE = `meta:
  name: <NAME> (<FAMILY>)
  version: 1
  author: <AUTHOR or TEAM>
  notes: "Breve descripci√≥n del parche"

ops:
  - find:    "00 00 00 64"
    replace: "00 00 00 C8"
    max_hits: 1

checksum:
  type: none
`;
$("#btnPlantilla").onclick = ()=>{ $("#yaml_text").value = TEMPLATE; };

$("#btnPlantilla2").onclick = (e)=>{ e.preventDefault(); $("#tplFile2").click(); };
$("#tplFile2").addEventListener("change", async ()=>{
  const f = $("#tplFile2").files?.[0]; if(!f) return;
  $("#yaml_text").value = await f.text().catch(()=> "");
});

$("#btnValidar").onclick = ()=>{
  const y = ($("#yaml_text").value || "").trim();
  const ok = y && /(^|\n)\s*ops\s*:/i.test(y) && /(^|\n)\s*meta\s*:/i.test(y);
  alert(ok ? "El YAML parece v√°lido (b√°sico)." : "YAML incompleto: falta 'meta:' u 'ops:'.");
};

$("#btnGuardar").onclick = async ()=>{
  if(needAuth()) return;

  const ecu_family = $("#ecu_family").value.trim();
  const patch_id   = $("#patch_id").value.trim();
  const label      = $("#label").value.trim() || patch_id;
  const engines    = ($("#engines").value||"").split(",").map(s=>s.trim()).filter(Boolean);
  const compat     = ($("#compat").value||"").split(",").map(s=>s.trim()).filter(Boolean);
  const price_raw  = $("#price").value.trim();
  const price      = price_raw? Number(price_raw) : null;
  const yaml_text  = $("#yaml_text").value;

  if(!ecu_family || !patch_id || !yaml_text){
    alert("Faltan ECU Family, Patch ID o YAML."); return;
  }

  const body = {
    ecu_family, patch_id, label,
    engines: engines.length? engines: null,
    compatible_ecu: compat.length? compat: null,
    price,
    save_catalog: $("#save_catalog").checked,
    yaml_text
  };

  $("#btnGuardar").disabled = true;
  elog("#log1", "‚Üí POST /admin/save_recipe ‚Ä¶");
  try{
    const r = await fetch("/admin/save_recipe",{
      method:"POST",
      headers:{ "Authorization":"Bearer "+TOKEN, "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    const t = await r.text();
    if(!r.ok){ elog("#log1","ERROR: "+t); alert("No se pudo guardar: "+t); }
    else { elog("#log1","OK: "+t); alert("Receta guardada ‚úÖ"); }
  }catch(e){
    elog("#log1","ERROR de red: "+(e?.message||e));
  }finally{
    $("#btnGuardar").disabled = false;
  }
};

$("#btnGuardarYaml").onclick = async ()=>{
  if(needAuth()) return;
  const ecu_family = $("#ecu_family").value.trim();
  const patch_id   = $("#patch_id").value.trim();
  const yaml_text  = $("#yaml_text").value;
  if(!ecu_family || !patch_id || !yaml_text){
    alert("Faltan ECU Family, Patch ID y/o YAML."); return;
  }

  $("#btnGuardarYaml").disabled = true;
  elog("#log1", "‚Üí POST /admin/save_yaml ‚Ä¶");
  try{
    const r = await fetch("/admin/save_yaml",{
      method:"POST",
      headers:{ "Authorization":"Bearer "+TOKEN, "Content-Type":"application/json" },
      body: JSON.stringify({ ecu_family, patch_id, yaml_text })
    });
    const t = await r.text();
    if(!r.ok){ elog("#log1","ERROR: "+t); alert("No se pudo guardar: "+t); }
    else { elog("#log1","OK: "+t); alert("YAML guardado ‚úÖ"); }
  }catch(e){
    elog("#log1","ERROR de red: "+(e?.message||e));
  }finally{
    $("#btnGuardarYaml").disabled = false;
  }
};
</script>

<script>
/* Export ZIP */
document.getElementById("btnExport")?.addEventListener("click", async ()=>{
  if(!TOKEN){ alert("Inicia sesi√≥n para descargar el backup."); return; }
  try{
    const r = await fetch("/admin/export_recipes?include_catalog=true", {
      headers: { "Authorization": "Bearer " + TOKEN }
    });
    if(!r.ok){
      const t = await r.text(); 
      alert("No se pudo generar el ZIP: " + t);
      return;
    }
    const blob = await r.blob();
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement("a");
    a.href = url;
    a.download = "efx_recipes_backup.zip";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }catch(e){
    alert("Error de red descargando ZIP: " + (e?.message || e));
  }
});
</script>

<script>
/* Diff ‚Üí YAML + adjuntar offsets/fingerprint_block SIN hackear fetch */
(function(){
  const ui = {
    fam: $("#diff_ecu_family"),
    pid: $("#diff_patch_id"),
    f0:  $("#diff_bin_stock"),
    f1:  $("#diff_bin_mod"),
    autoSave: $("#diff_auto"),
    btn: $("#diff_go"),
    out: $("#diff_yaml"),
    log: $("#diff_log")
  };

  const log = (m) => { if(!ui.log) return; ui.log.textContent += (ui.log.textContent ? "\n":"") + m; ui.log.scrollTop = ui.log.scrollHeight; };

  function ensureToken() {
    TOKEN = localStorage.getItem("EFX_TOKEN");
    if (!TOKEN) { alert("Inicia sesi√≥n para usar Admin."); throw new Error("Sin token"); }
  }
  const fileToArr = async (f)=> new Uint8Array(await f.arrayBuffer());

  function normalizeFamily(raw){
    const fam = (raw || "").trim().toUpperCase();
    const ok = /(MEVD?17|MED17|EDC17|MD1|MG1)/.test(fam);
    return {fam, ok};
  }

  let working=false;

  async function handleDiff(ev){
    try{
      ev?.preventDefault?.();
      if(working) return;
      working=true; ui.btn.disabled=true;

      ensureToken();

      const {fam, ok} = normalizeFamily(ui.fam?.value);
      let patchId = (ui.pid?.value || "").trim();
      const save = !!ui.autoSave?.checked;

      if(!fam){ alert("ECU Family requerido (ej: EDC17C81, EDC17CP45, MEVD17, MD1, MG1)."); return; }
      if(!ok){ alert("ECU Family debe contener MEVD17 / MED17 / EDC17 / MD1 / MG1."); return; }
      if(!patchId){ alert("Patch ID requerido (ej: dpf_off)."); return; }
      patchId = patchId.toLowerCase().replace(/\s+/g, "_").replace(/[^a-z0-9_\-]/g, "");

      const file0 = ui.f0?.files?.[0];
      const file1 = ui.f1?.files?.[0];
      if(!file0 || !file1){ alert("Selecciona BIN stock y BIN mod."); return; }

      const b0 = await fileToArr(file0);
      const b1 = await fileToArr(file1);
      log(`Stock size: ${b0.length} bytes | Mod size: ${b1.length} bytes`);
      if(b0.length !== b1.length){ alert("Los BIN deben tener el MISMO tama√±o."); return; }
      if(b0.length === 0){ alert("Archivo vac√≠o."); return; }

      const fd = new FormData();
      fd.append("ecu_family", fam);
      fd.append("patch_id", patchId);
      fd.append("save", String(save));
      fd.append("original_bin", file0, file0.name);
      fd.append("modified_bin", file1, file1.name);

      // ‚úÖ Adjuntar hints (si los llenaste)
      const swLine  = ($("#fp_sw")?.value  || "").trim();
      const mpcLine = ($("#fp_mpc")?.value || "").trim();
      const ecuLine = ($("#fp_ecu")?.value || "").trim();
      const fpBlock = ($("#fp_out")?.value || "").trim();
      if(swLine)  fd.append("sw_line", swLine);
      if(mpcLine) fd.append("mpc_line", mpcLine);
      if(ecuLine) fd.append("ecu_line", ecuLine);
      if(fpBlock) fd.append("fingerprint_block", fpBlock);

      log("POST /admin/diff2patch ‚Ä¶");
      const r = await fetch("/admin/diff2patch", {
        method: "POST",
        headers: { "Authorization": "Bearer " + TOKEN },
        body: fd
      });

      const text = await r.text().catch(()=> "");
      if(!r.ok){
        log(`HTTP ${r.status}: ${text || "(sin detalle)"}`);
        alert(`Error generando YAML:\nHTTP ${r.status}\n${text || "(sin detalle)"}`);
        return;
      }

      let data={};
      try{ data = text ? JSON.parse(text) : {}; }catch{ data={}; }
      const yaml = data.yaml || "";
      if(ui.out) ui.out.value = yaml;

      log(`OK. Bloques diff: ${data.ops_count ?? "?"}. ${data.saved_to ? "Guardado en: "+data.saved_to : "No se guard√≥ (autosave off)"}`);
      alert(data.saved_to ? `Receta generada y guardada:\n${data.saved_to}`
                          : "Receta generada. Revisa el √°rea ‚ÄúYAML generado‚Äù.");
    }catch(e){
      console.error(e);
      log("Excepci√≥n: " + (e?.message || e));
      alert("Excepci√≥n en el cliente: " + (e?.message || e));
    }finally{
      working=false; ui.btn.disabled=false;
    }
  }

  ui.btn?.addEventListener("click", handleDiff);
})();
</script>

<script>
/* Fingerprint local (SHA256 + CRC32 + size) */
(function(){
  const $$ = (q,el=document)=>el.querySelector(q);

  function crc32(u8){
    let c = 0xffffffff;
    for (let i=0;i<u8.length;i++){
      c ^= u8[i];
      for (let k=0;k<8;k++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
    }
    return ((c ^ 0xffffffff) >>> 0);
  }
  function hex8(n){ return n.toString(16).toUpperCase().padStart(8,"0"); }

  async function sha256Hex(u8){
    const hash = await crypto.subtle.digest("SHA-256", u8.buffer);
    const b = new Uint8Array(hash);
    return Array.from(b).map(x=>x.toString(16).padStart(2,"0")).join("").toUpperCase();
  }

  async function fileToU8(file){
    return new Uint8Array(await file.arrayBuffer());
  }

  function parseOffsetLine(s){
    const raw = (s||"").trim();
    if(!raw) return { value:null, offset:null };
    const parts = raw.split("/").map(x=>x.trim());
    if(parts.length === 1) return { value: parts[0] || null, offset: null };
    return { value: parts[0] || null, offset: parts[1] || null };
  }

  async function buildFingerprintBlock(){
    const fam = ($$("#diff_ecu_family")?.value || "").trim().toUpperCase();
    const pid = ($$("#diff_patch_id")?.value || "").trim();

    const stockFile = $$("#diff_bin_stock")?.files?.[0] || null;
    const modFile   = $$("#diff_bin_mod")?.files?.[0] || null;

    if(!stockFile || !modFile){
      alert("Selecciona BIN Stock y BIN Modificado primero.");
      return null;
    }

    const sw  = parseOffsetLine($$("#fp_sw")?.value);
    const mpc = parseOffsetLine($$("#fp_mpc")?.value);
    const ecu = parseOffsetLine($$("#fp_ecu")?.value);

    const stockU8 = await fileToU8(stockFile);
    const modU8   = await fileToU8(modFile);

    const stockSHA = await sha256Hex(stockU8);
    const modSHA   = await sha256Hex(modU8);

    const stockCVN = hex8(crc32(stockU8));
    const modCVN   = hex8(crc32(modU8));

    const block =
`ECU_FAMILY=${fam || "‚Äî"}
PATCH_ID=${pid || "‚Äî"}

STOCK_FILE=${stockFile.name}
STOCK_SIZE=${stockU8.length}
STOCK_CVN_CRC32=${stockCVN}
STOCK_SHA256=${stockSHA}

MOD_FILE=${modFile.name}
MOD_SIZE=${modU8.length}
MOD_CVN_CRC32=${modCVN}
MOD_SHA256=${modSHA}

OFFSETS:
  SW_NUMBER=${sw.value || "‚Äî"}
  SW_OFFSET=${sw.offset || "‚Äî"}
  MPC_TYPE=${mpc.value || "‚Äî"}
  MPC_OFFSET=${mpc.offset || "‚Äî"}
  ECU_LABEL=${ecu.value || "‚Äî"}
  ECU_OFFSET=${ecu.offset || "‚Äî"}
`;
    return { block };
  }

  $$("#fp_calc")?.addEventListener("click", async ()=>{
    try{
      const out = await buildFingerprintBlock();
      if(!out) return;
      $$("#fp_out").value = out.block;
      alert("‚úÖ Huellas calculadas.");
    }catch(e){
      alert("Error calculando huellas: " + (e?.message || e));
    }
  });

  $$("#fp_copy")?.addEventListener("click", async ()=>{
    const text = ($$("#fp_out")?.value || "").trim();
    if(!text){ alert("Nada que copiar. Primero calcula huellas."); return; }
    try{
      await navigator.clipboard.writeText(text);
      alert("üìã Copiado.");
    }catch{
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      alert("üìã Copiado.");
    }
  });
})();
</script>

</body>
</html>


