<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ECU FORGE X â€” Checkout</title>

  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/efx.css">

  <script src="/static/js/theme.js"></script>
</head>

<body>
<header class="efx-topbar">
  <div class="brand">ECU FORGE X</div>

  <div class="efx-actions">
    <button class="btn icon" id="btnTheme" type="button" title="Dark / Light">ğŸŒ™ / â˜€ï¸</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h3>Checkout</h3>

    <div id="orderBox" class="muted">Cargando ordenâ€¦</div>

    <div class="actions" style="margin-top:14px">
      <!-- Pay (redirige a checkout_url si existe) -->
      <a id="btnPay" class="btn ok" href="#" style="display:none">ğŸ’³ Pagar</a>

      <!-- Download (solo si estÃ¡ listo) -->
      <a id="btnDownloadMain" class="btn ok" href="#" style="display:none" download>â¬‡ï¸ Descargar .MOD</a>

      <a class="btn gray" href="/static/index.html">â† Volver</a>
    </div>

    <div id="msg" class="muted" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3>Ayuda</h3>
    <ul class="help">
      <li>Si el pago se confirma, la descarga se habilita automÃ¡ticamente.</li>
      <li>Si no aparece el botÃ³n de pago, revisa que la orden tenga <code>checkout_url</code>.</li>
    </ul>
  </div>
</div>

<script>
/* =========================
   Utils
========================= */
const $ = (q, el=document) => el.querySelector(q);
const params = new URLSearchParams(location.search);
const ORDER_ID = params.get("order_id") || params.get("orderId") || "";

function setMsg(t){ $("#msg").textContent = t || ""; }

function fmtMoney(n){
  if (n === null || n === undefined || n === "") return "â€”";
  const num = Number(n);
  if (!Number.isFinite(num)) return String(n);
  return "$" + num.toFixed(2) + " USD";
}

/* =========================
   API (pÃºblico)
   Ajusta estas rutas si tu backend usa otras.
========================= */
async function fetchPublicOrder(){
  const r = await fetch(`/public/order/${encodeURIComponent(ORDER_ID)}`);
  if(!r.ok){
    const t = await r.text().catch(()=>"(sin detalle)");
    throw new Error(`No se pudo cargar la orden (${r.status}): ${t}`);
  }
  return await r.json();
}

/* =========================
   UI render
========================= */
function renderOrder(o){
  const box = $("#orderBox");
  const price = o.price_usd ?? o.amount_usd ?? o.total_usd ?? null;

  box.innerHTML = `
    <div class="row"><div class="muted">ID</div><div>${o.id || "â€”"}</div></div>
    <div class="row"><div class="muted">Estado</div><div>${o.status || "â€”"}</div></div>
    <div class="row"><div class="muted">Pagado</div><div>${o.paid ? "âœ… SÃ­" : "â³ No"}</div></div>
    <div class="row"><div class="muted">Parche(s)</div><div>${o.patch_label || o.patch_option_id || (Array.isArray(o.patches) ? o.patches.join(", ") : "â€”")}</div></div>
    <div class="row"><div class="muted">Monto</div><div>${fmtMoney(price)}</div></div>
    <div class="row"><div class="muted">Creada</div><div>${o.created_at || "â€”"}</div></div>
  `;

  // BotÃ³n pagar (si existe checkout_url y no estÃ¡ pagado)
  const pay = $("#btnPay");
  const hasCheckout = !!o.checkout_url;
  const shouldPay = hasCheckout && !o.paid && (o.status !== "paid" && o.status !== "done");

  if (shouldPay){
    pay.style.display = "inline-flex";
    pay.href = o.checkout_url;
    pay.textContent = "ğŸ’³ Pagar";
  } else {
    pay.style.display = "none";
    pay.removeAttribute("href");
  }

  // BotÃ³n descargar (si download_ready)
  const dl = $("#btnDownloadMain");
  const ready = !!o.download_ready && (o.paid || o.status === "paid" || o.status === "done");

  if (ready){
    dl.style.display = "inline-flex";
    // Preferimos download_url si viene, si no usamos /download/<id>
    dl.href = o.download_url || `/download/${encodeURIComponent(o.id || ORDER_ID)}`;
    dl.setAttribute("download", "");
    dl.textContent = "â¬‡ï¸ Descargar .MOD";
  } else {
    dl.style.display = "none";
    dl.removeAttribute("href");
    dl.removeAttribute("download");
  }
}

/* =========================
   Init
========================= */
async function init(){
  // Theme toggle (si no existe theme.js, no rompe)
  $("#btnTheme").addEventListener("click", () => {
    if (window.EFX && typeof window.EFX.toggleTheme === "function") return window.EFX.toggleTheme();
    document.documentElement.classList.toggle("dark");
  });

  if(!ORDER_ID){
    $("#orderBox").textContent = "Falta order_id en la URL.";
    setMsg("Ejemplo: /static/checkout.html?order_id=ORD_123");
    return;
  }

  try{
    setMsg("");
    const o = await fetchPublicOrder();
    renderOrder(o);

    // Poll simple: refresca estado cada 4s si aÃºn no estÃ¡ listo
    const isReady = !!o.download_ready && (o.paid || o.status === "paid" || o.status === "done");
    if (!isReady){
      setMsg("Esperando confirmaciÃ³n de pago / generaciÃ³nâ€¦");
      setInterval(async ()=>{
        try{
          const o2 = await fetchPublicOrder();
          renderOrder(o2);
          const ok = !!o2.download_ready && (o2.paid || o2.status === "paid" || o2.status === "done");
          if (ok) setMsg("âœ… Listo. Descarga habilitada.");
        }catch(e){}
      }, 4000);
    } else {
      setMsg("âœ… Listo. Descarga habilitada.");
    }
  }catch(e){
    $("#orderBox").textContent = "Error cargando orden.";
    setMsg(e.message || "Error de red.");
  }
}

document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
