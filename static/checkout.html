<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ECU FORGE X</title>

  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/efx.css">

  <script src="/static/js/theme.js"></script>
</head>

<body>
<header class="efx-topbar">
  <div class="brand">ECU FORGE X</div>

  <div class="efx-actions">
    <button class="btn icon" onclick="EFX.toggleTheme()" title="Dark / Light">üåô / ‚òÄÔ∏è</button>
    <button id="btnLogout" class="btn" onclick="EFX.logout()">Cerrar sesi√≥n</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h3>Checkout (DEMO)</h3>
    <div id="orderBox" class="muted">Cargando orden‚Ä¶</div>

    <div class="actions" style="margin-top:14px">
      <button id="btnDemoPay" class="btn" type="button">‚úÖ Confirmar pago DEMO</button>

      <!-- ‚úÖ √öNICO bot√≥n de descarga REAL (body) -->
      <a id="btnDownloadMain" class="btn ok" href="#" style="display:none" download>‚¨áÔ∏è Descargar .MOD</a>

      <a class="btn gray" href="/static/index.html">‚Üê Volver</a>
    </div>

    <div id="msg" class="muted" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3>Ayuda</h3>
    <ul class="help">
      <li>Modo demo: confirmas el pago y se habilita descarga.</li>
      <li>La descarga viene de <code>/download/&lt;order_id&gt;</code>.</li>
    </ul>
  </div>
</div>

<script>
/* =========================================================
   ‚úÖ auth.js INLINE (m√≠nimo REAL) ‚Äî limpio
========================================================= */
(function () {
  const TOKEN_KEYS = ["EFX_TOKEN","token","access_token","jwt"];

  function getToken(){
    for (const k of TOKEN_KEYS){
      const v = localStorage.getItem(k) || sessionStorage.getItem(k);
      if (v && String(v).trim()) return String(v).trim();
    }
    return null;
  }

  function clearToken(){
    for (const k of TOKEN_KEYS){
      localStorage.removeItem(k);
      sessionStorage.removeItem(k);
    }
  }

  function isLoggedIn(){ return !!getToken(); }

  function requireLogin(nextUrl){
    const next = encodeURIComponent(nextUrl || location.href);
    location.href = "/static/usuarios.html#login?next=" + next;
  }

  function logout(){
    clearToken();
    location.href = "/static/index.html";
  }

  window.EFX = window.EFX || {};
  window.EFX.getToken = getToken;
  window.EFX.clearToken = clearToken;
  window.EFX.isLoggedIn = isLoggedIn;
  window.EFX.requireLogin = requireLogin;
  window.EFX.logout = logout;

  if (!window.EFX.toggleTheme){
    window.EFX.toggleTheme = function(){
      document.documentElement.classList.toggle("dark");
    };
  }
})();
</script>

<script>
/* =========================================================
   Checkout l√≥gica (orden + pago demo + descarga)
========================================================= */
const $ = (q,el=document)=>el.querySelector(q);
const params = new URLSearchParams(location.search);
const ORDER_ID = params.get("order_id") || "";

function lockForAuthIfNeeded(){
  const isDemo = true;
  if (!isDemo) return false;

  if (!EFX.isLoggedIn()){
    const payBtn = $("#btnDemoPay");
    const dlBtn  = $("#btnDownloadMain");

    if (payBtn){
      payBtn.disabled = true;
      payBtn.title = "Debes iniciar sesi√≥n para continuar (DEMO)";
      payBtn.addEventListener("click", (e)=>{ e.preventDefault(); EFX.requireLogin(location.href); });
    }

    if (dlBtn){
      dlBtn.style.pointerEvents = "none";
      dlBtn.style.opacity = "0.6";
      dlBtn.title = "Debes iniciar sesi√≥n para descargar (DEMO)";
      dlBtn.addEventListener("click", (e)=>{ e.preventDefault(); EFX.requireLogin(location.href); });
    }

    const box = document.createElement("div");
    box.className = "card";
    box.style.marginTop = "12px";
    box.innerHTML = "<b>üîí DEMO</b><br>Para descargar debes <b>iniciar sesi√≥n</b>.";
    (document.querySelector(".wrap") || document.body).appendChild(box);

    $("#msg").textContent = "Debes iniciar sesi√≥n para continuar.";
    return true;
  }
  return false;
}

async function fetchOrder(){
  const box = $("#orderBox");
  try{
    const r = await fetch(`/orders/${ORDER_ID}`, {
      headers: { "Authorization":"Bearer " + EFX.getToken() }
    });

    if(!r.ok){
      const t = await r.text().catch(()=>"(sin detalle)");
      box.textContent = "No se pudo cargar la orden. " + t;
      return null;
    }

    const o = await r.json();
    const price = (o.price_usd ?? 59);
    const priceTxt = (typeof price === "number") ? price.toFixed(2) : "59.00";

    box.innerHTML = `
      <div class="row"><div class="muted">ID</div><div>${o.id}</div></div>
      <div class="row"><div class="muted">Parche</div><div>${o.patch_option_id}</div></div>
      <div class="row"><div class="muted">Estado</div><div>${o.status}</div></div>
      <div class="row"><div class="muted">Fecha</div><div>${o.created_at || "‚Äî"}</div></div>
      <div class="row"><div class="muted">Monto</div><div>$${priceTxt} <span class="muted">(demo)</span></div></div>
    `;

    const canDownload = (o.status === "paid" || o.status === "done") && !!o.download_ready;
    const dlMain = $("#btnDownloadMain");

    if (canDownload && dlMain){
      const url = `/download/${o.id}`;
      dlMain.style.display = "inline-flex";
      dlMain.href = url;
      dlMain.setAttribute("download", "");
      dlMain.textContent = "‚¨áÔ∏è Descargar .MOD";
    } else if (dlMain){
      dlMain.style.display = "none";
      dlMain.removeAttribute("href");
      dlMain.removeAttribute("download");
    }

    return o;
  }catch(e){
    box.textContent = "Error de red.";
    return null;
  }
}

async function demoPay(){
  $("#msg").textContent = "Procesando pago demo‚Ä¶";

  const r = await fetch(`/orders/${ORDER_ID}/confirm_payment`, {
    method: "POST",
    headers: { "Authorization": "Bearer " + EFX.getToken() }
  });

  if(!r.ok){
    const t = await r.text().catch(()=>"(sin detalle)");
    $("#msg").textContent = "No se pudo confirmar el pago: " + t;
    return;
  }

  const d = await r.json();
  $("#msg").textContent = "Pago confirmado. MOD listo ‚úÖ";

  const dl = $("#btnDownloadMain");
  if (dl){
    dl.style.display = "inline-flex";
    dl.href = d.download_url;
    dl.setAttribute("download", "");
    dl.textContent = "‚¨áÔ∏è Descargar .MOD";
  }

  await fetchOrder();
}

function init(){
  if(!ORDER_ID){
    alert("Falta order_id en la URL");
    $("#orderBox").textContent = "Falta order_id en la URL.";
    return;
  }

  if (lockForAuthIfNeeded()) return;

  $("#btnDemoPay").onclick = demoPay;
  fetchOrder();
}

document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
