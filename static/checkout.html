<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ECU FORGE X</title>

  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/efx.css">

  <script src="/static/js/theme.js"></script>

  <!-- ‚úÖ Ajuste PRO para que los botones del header no queden gigantes -->
  <style>
    .efx-topbar .btn{ width:auto; padding:6px 12px; font-size:13px; }
    .efx-topbar .btn.icon{ padding:6px 10px; }
    .efx-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  </style>
</head>

<body>
<header class="efx-topbar">
  <div class="brand">ECU FORGE X</div>

  <div class="efx-actions">
    <button id="btnLogin" class="btn"
      onclick="location.href='/static/usuarios.html#login?next='+encodeURIComponent(location.href)">
      Iniciar sesi√≥n
    </button>

    <button id="btnRegister" class="btn"
      onclick="location.href='/static/usuarios.html#register?next='+encodeURIComponent(location.href)">
      Registro
    </button>

    <button class="btn icon" onclick="EFX.toggleTheme()" title="Dark / Light">üåô / ‚òÄÔ∏è</button>

    <!-- Estos 2 son ‚Äútop shortcuts‚Äù (opcionales), el real es el de abajo -->
    <button id="btnPayTop" class="btn" type="button">Confirmar pago DEMO</button>
    <a id="btnDownloadTop" class="btn" href="#" style="display:none">Descargar .MOD</a>

    <button id="btnLogout" class="btn" style="display:none" type="button">Cerrar sesi√≥n</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h3>Checkout (DEMO)</h3>
    <div id="orderBox" class="muted">Cargando orden‚Ä¶</div>

    <div class="actions" style="margin-top:14px">
      <button id="btnDemoPay" class="btn" type="button">‚úÖ Confirmar pago DEMO</button>

      <!-- ‚úÖ ESTE ES EL √öNICO btnDownload REAL (antes ten√≠as 2 con el mismo ID) -->
      <a id="btnDownload" class="btn ok" href="#" style="display:none" download>‚¨áÔ∏è Descargar .MOD</a>

      <a class="btn gray" href="/static/index.html">‚Üê Volver</a>
    </div>

    <div id="msg" class="muted" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3>Ayuda</h3>
    <ul class="help">
      <li>Modo demo: confirmas el pago y se habilita descarga.</li>
      <li>La descarga viene de <code>/download/&lt;order_id&gt;</code>.</li>
    </ul>
  </div>
</div>

<script>
/* =========================================================
   ‚úÖ auth.js INLINE (m√≠nimo REAL) ‚Äî NO rompe lo logrado
   - Token en localStorage EFX_TOKEN (y compat keys)
   - applyHeaderAuth(): muestra/oculta botones
   - requireLogin(next): redirige con next
   - logout(): borra tokens
========================================================= */
(function () {
  const TOKEN_KEYS = ["EFX_TOKEN","token","access_token","jwt"];

  function getToken(){
    for (const k of TOKEN_KEYS){
      const v = localStorage.getItem(k) || sessionStorage.getItem(k);
      if (v && String(v).trim()) return String(v).trim();
    }
    return null;
  }

  function setToken(token, persist=true){
    // guardamos en la key oficial
    if (persist) localStorage.setItem("EFX_TOKEN", token);
    else sessionStorage.setItem("EFX_TOKEN", token);
  }

  function clearToken(){
    for (const k of TOKEN_KEYS){
      localStorage.removeItem(k);
      sessionStorage.removeItem(k);
    }
  }

  function isLoggedIn(){
    return !!getToken();
  }

  function requireLogin(nextUrl){
    const next = encodeURIComponent(nextUrl || location.href);
    location.href = "/static/usuarios.html#login?next=" + next;
  }

  function applyHeaderAuth(){
    const btnLogin = document.getElementById("btnLogin");
    const btnReg   = document.getElementById("btnRegister");
    const btnOut   = document.getElementById("btnLogout");

    const logged = isLoggedIn();

    if (btnLogin) btnLogin.style.display = logged ? "none" : "inline-block";
    if (btnReg)   btnReg.style.display   = logged ? "none" : "inline-block";
    if (btnOut)   btnOut.style.display   = logged ? "inline-block" : "none";

    // logout handler
    if (btnOut && !btnOut.dataset.bound){
      btnOut.dataset.bound = "1";
      btnOut.addEventListener("click", () => {
        clearToken();
        // vuelve al index para que se note el estado
        location.href = "/static/index.html";
      });
    }
  }

  // expone API global
  window.EFX = window.EFX || {};
  window.EFX.getToken = getToken;
  window.EFX.setToken = setToken;
  window.EFX.clearToken = clearToken;
  window.EFX.isLoggedIn = isLoggedIn;
  window.EFX.requireLogin = requireLogin;
  window.EFX.applyHeaderAuth = applyHeaderAuth;

  // theme.js puede definir toggleTheme; si no, evitamos crash
  if (!window.EFX.toggleTheme){
    window.EFX.toggleTheme = function(){
      document.documentElement.classList.toggle("dark");
    };
  }
})();
</script>

<script>
/* =========================================================
   Checkout l√≥gica (orden + pago demo + descarga)
========================================================= */
const $ = (q,el=document)=>el.querySelector(q);
const params = new URLSearchParams(location.search);
const ORDER_ID = params.get("order_id") || "";

function lockForAuthIfNeeded(){
  const isDemo = true;
  if (!isDemo) return false;

  if (!EFX.isLoggedIn()){
    // Bloquea botones de pago/descarga
    const payBtns = [$("#btnDemoPay"), $("#btnPayTop")].filter(Boolean);
    for (const b of payBtns){
      b.disabled = true;
      b.title = "Debes iniciar sesi√≥n para continuar (DEMO)";
      b.addEventListener("click", (e)=>{ e.preventDefault(); EFX.requireLogin(location.href); });
    }

    const dls = [$("#btnDownload"), $("#btnDownloadTop")].filter(Boolean);
    for (const a of dls){
      a.style.pointerEvents = "none";
      a.style.opacity = "0.6";
      a.title = "Debes iniciar sesi√≥n para descargar (DEMO)";
      a.addEventListener("click", (e)=>{ e.preventDefault(); EFX.requireLogin(location.href); });
    }

    // Mensaje claro
    const box = document.createElement("div");
    box.className = "card";
    box.style.marginTop = "12px";
    box.innerHTML = "<b>üîí DEMO</b><br>Para descargar debes <b>iniciar sesi√≥n</b>.";
    (document.querySelector(".wrap") || document.body).appendChild(box);

    $("#msg").textContent = "Debes iniciar sesi√≥n para continuar.";
    return true;
  }
  return false;
}

async function fetchOrder(){
  const box = $("#orderBox");
  try{
    const r = await fetch(`/orders/${ORDER_ID}`, {
      headers: { "Authorization":"Bearer " + EFX.getToken() }
    });

    if(!r.ok){
      const t = await r.text().catch(()=>"(sin detalle)");
      box.textContent = "No se pudo cargar la orden. " + t;
      return null;
    }

    const o = await r.json();
    box.innerHTML = `
      <div class="row"><div class="muted">ID</div><div>${o.id}</div></div>
      <div class="row"><div class="muted">Parche</div><div>${o.patch_option_id}</div></div>
      <div class="row"><div class="muted">Estado</div><div>${o.status}</div></div>
      <div class="row"><div class="muted">Fecha</div><div>${o.created_at || "‚Äî"}</div></div>
      <div class="row"><div class="muted">Monto</div><div>$${(o.price_usd ?? 59).toFixed ? (o.price_usd ?? 59).toFixed(2) : "59.00"} <span class="muted">(demo)</span></div></div>
    `;

    // Si ya est√° paid/download_ready, habilita descarga
    const canDownload = (o.status === "paid" || o.status === "done") && !!o.download_ready;

    const dlMain = $("#btnDownload");
    const dlTop  = $("#btnDownloadTop");

    if (canDownload){
      const url = `/download/${o.id}`;
      if (dlMain){
        dlMain.style.display = "inline-block";
        dlMain.href = url;
        dlMain.setAttribute("download", "");
        dlMain.textContent = "‚¨áÔ∏è Descargar .MOD";
      }
      if (dlTop){
        dlTop.style.display = "inline-block";
        dlTop.href = url;
      }
    } else {
      if (dlMain){
        dlMain.style.display = "none";
        dlMain.removeAttribute("href");
        dlMain.removeAttribute("download");
      }
      if (dlTop){
        dlTop.style.display = "none";
        dlTop.removeAttribute("href");
      }
    }

    return o;
  }catch(e){
    box.textContent = "Error de red.";
    return null;
  }
}

async function demoPay(){
  $("#msg").textContent = "Procesando pago demo‚Ä¶";

  const r = await fetch(`/orders/${ORDER_ID}/confirm_payment`, {
    method: "POST",
    headers: { "Authorization": "Bearer " + EFX.getToken() }
  });

  if(!r.ok){
    const t = await r.text().catch(()=>"(sin detalle)");
    $("#msg").textContent = "No se pudo confirmar el pago: " + t;
    return;
  }

  const d = await r.json();
  $("#msg").textContent = "Pago confirmado. MOD listo ‚úÖ";

  // habilita descarga inmediata
  const url = d.download_url || `/download/${ORDER_ID}`;

  const dlMain = $("#btnDownload");
  const dlTop  = $("#btnDownloadTop");

  if (dlMain){
    dlMain.style.display = "inline-block";
    dlMain.href = url;
    dlMain.setAttribute("download", "");
    dlMain.textContent = "‚¨áÔ∏è Descargar .MOD";
  }
  if (dlTop){
    dlTop.style.display = "inline-block";
    dlTop.href = url;
  }

  await fetchOrder();
}

function init(){
  if(!ORDER_ID){
    alert("Falta order_id en la URL");
    $("#orderBox").textContent = "Falta order_id en la URL.";
    return;
  }

  // Ajusta header seg√∫n auth
  EFX.applyHeaderAuth();

  // Si no hay login => bloquea y redirige con next
  if (lockForAuthIfNeeded()) return;

  // Bind botones
  const btnDemo = $("#btnDemoPay");
  const btnTopPay = $("#btnPayTop");

  if (btnDemo) btnDemo.onclick = demoPay;
  if (btnTopPay) btnTopPay.onclick = demoPay;

  fetchOrder();
}

document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
