<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>ECU FORGE X — Checkout</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#f4f6fb;--card:#fff;--ink:#111;--muted:#64748b;--brand:#0b1220;--btn:#0066ff;--btnh:#004bcc;--stroke:#e5e7eb;}
  *{box-sizing:border-box} body{margin:0;font-family:Arial,system-ui;background:var(--bg);color:var(--ink)}
  header{background:var(--brand);color:#fff;padding:14px 18px;display:flex;align-items:center;gap:12px}
  header .grow{flex:1}
  header a{color:#cbd5e1;text-decoration:none} header a:hover{color:#fff}
  .wrap{max-width:920px;margin:18px auto;padding:0 14px}
  .card{background:var(--card);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:18px}
  .muted{color:var(--muted)} h2{margin:0 0 12px}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .col{flex:1 1 280px}
  button{background:var(--btn);border:0;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer}
  button:hover{background:var(--btnh)}
  .badge{display:inline-block;background:#eef;padding:4px 8px;border-radius:999px;font-size:12px;color:#1f2937}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:6px}
  .ok{color:#0a7a2f;font-weight:700}
  .err{color:#b00020;font-weight:700}
  .hint{font-size:13px;color:#64748b}
</style>
</head>
<body>

<header>
  <div style="font-weight:700;font-size:20px">ECU FORGE X</div>
  <div class="grow"></div>
  <a href="/static/index.html">Volver</a>
  <a href="/static/usuarios.html" style="margin-left:12px">Mis órdenes</a>
</header>

<div class="wrap">
  <div class="card">
    <h2>Checkout</h2>
    <div id="status" class="muted">Cargando orden…</div>
    <div id="orderBox" style="margin-top:10px;display:none">
      <div class="row">
        <div class="col">
          <h3>Detalle</h3>
          <div class="kv" id="kv"></div>
        </div>
        <div class="col">
          <h3>Acciones</h3>
          <button id="btnPay">Confirmar pago (demo)</button>
          <div id="payMsg" class="hint" style="margin-top:8px">Simula la aprobación del pago y genera el archivo MOD.</div>
          <div id="doneBox" style="display:none;margin-top:12px">
            <div class="ok">Pago confirmado ✓</div>
            <div style="margin-top:6px"><a id="dlLink" href="#" download>Descargar MOD</a></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Login -->
<div id="modalLogin" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center">
  <div style="background:#fff;padding:18px;border-radius:10px;width:340px;box-shadow:0 8px 30px rgba(0,0,0,.25)">
    <h3>Iniciar sesión</h3>
    <input id="login_email" placeholder="Email" style="width:100%;padding:10px;border:1px solid var(--stroke);border-radius:8px;margin:6px 0"/>
    <input id="login_pass" type="password" placeholder="Contraseña" style="width:100%;padding:10px;border:1px solid var(--stroke);border-radius:8px;margin:6px 0"/>
    <button id="btnLogin">Ingresar</button>
  </div>
</div>

<script>
const $=(q,el=document)=>el.querySelector(q);
const qs = new URLSearchParams(location.search);
const ORDER_ID = parseInt(qs.get("order_id")||"0",10);
let TOKEN = localStorage.getItem("EFX_TOKEN") || null;
const statusEl = $("#status"), orderBox=$("#orderBox"), kv=$("#kv"), doneBox=$("#doneBox"), dlLink=$("#dlLink");

function ensureAuth(){
  if(!TOKEN){ $("#modalLogin").style.display="flex"; return false; }
  return true;
}
$("#btnLogin").onclick = async ()=>{
  const fd = new FormData();
  fd.append("username", $("#login_email").value);
  fd.append("password", $("#login_pass").value);
  const r = await fetch("/auth/login",{method:"POST",body:fd});
  if(!r.ok){ alert("Credenciales inválidas"); return; }
  const d = await r.json(); TOKEN=d.access_token; localStorage.setItem("EFX_TOKEN", TOKEN);
  $("#modalLogin").style.display="none";
  init();
};

async function loadMine(){
  const r = await fetch("/orders/mine",{headers:{Authorization:"Bearer "+TOKEN}});
  if(!r.ok) throw new Error("no-orders");
  return r.json();
}
function renderKV(o){
  kv.innerHTML = "";
  const row = (k,v)=> kv.insertAdjacentHTML("beforeend", `<div class="muted">${k}</div><div>${v??"—"}</div>`);
  row("ID orden", o.id);
  row("Estado", `<span class="badge">${o.status}</span>`);
  row("Parche", o.patch_option_id);
  row("Archivo original", o.original_filename || "—");
  row("Creada", o.created_at);
  row("Descarga lista", o.download_ready ? "Sí" : "No");
}

async function confirmPay(){
  if(!ensureAuth()) return;
  const r = await fetch(`/orders/${ORDER_ID}/confirm_payment`, {method:"POST", headers:{Authorization:"Bearer "+TOKEN}});
  if(!r.ok){ alert("Error confirmando pago"); return; }
  const d = await r.json();
  doneBox.style.display = "block";
  dlLink.href = d.download_url; // /orders/{id}/download
}

$("#btnPay").onclick = confirmPay;

async function init(){
  if(!ORDER_ID){ statusEl.innerHTML = '<span class="err">Falta parámetro order_id</span>'; return; }
  if(!ensureAuth()) return;
  statusEl.textContent = "Cargando orden…";
  try{
    const mine = await loadMine();
    const o = (mine.orders||[]).find(x=>x.id===ORDER_ID);
    if(!o){ statusEl.innerHTML = '<span class="err">Orden no encontrada</span>'; return; }
    renderKV(o);
    orderBox.style.display = "block";
    statusEl.textContent = "";
    if(o.download_ready){
      doneBox.style.display = "block";
      dlLink.href = `/orders/${o.id}/download`;
    }
  }catch(e){
    statusEl.innerHTML = '<span class="err">No se pudo cargar la orden</span>';
  }
}
init();
</script>
</body>
</html>
