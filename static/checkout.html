<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ECU FORGE X</title>

  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/efx.css">

  <script src="/static/js/theme.js"></script>
</head>

<body>
<header class="efx-topbar">
  <div class="brand">ECU FORGE X</div>

  <div class="efx-actions">
<button id="btnLogin" class="btn" onclick="location.href='/static/usuarios.html#login?next='+encodeURIComponent(location.href)">Iniciar sesi√≥n</button>
<button id="btnRegister" class="btn" onclick="location.href='/static/usuarios.html#register?next='+encodeURIComponent(location.href)">Registro</button>
<button class="btn icon" onclick="EFX.toggleTheme()" title="Dark / Light">üåô / ‚òÄÔ∏è</button><button id="btnPay" class="btn">Confirmar pago DEMO</button>
<a id="btnDownload" class="btn" href="#">Descargar .MOD</a>
<button id="btnLogout" class="btn" style="display:none" onclick="EFX.logout()">Cerrar sesi√≥n</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h3>Checkout (DEMO)</h3>
    <div id="orderBox" class="muted">Cargando orden‚Ä¶</div>

    <div class="actions" style="margin-top:14px">
      <button id="btnDemoPay" class="btn">‚úÖ Confirmar pago DEMO</button>
      <a id="btnDownload" class="btn ok" style="display:none" download>‚¨áÔ∏è Descargar .MOD</a>
      <a class="btn gray" href="/static/index.html">‚Üê Volver</a>
    </div>

    <div id="msg" class="muted" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3>Ayuda</h3>
    <ul class="help">
      <li>Modo demo: confirmas el pago y se habilita descarga.</li>
      <li>La descarga viene de <code>/download/&lt;order_id&gt;</code>.</li>
    </ul>
  </div>
</div>

<script>
const $ = (q,el=document)=>el.querySelector(q);
const params = new URLSearchParams(location.search);
const ORDER_ID = params.get("order_id") || "";

const TOKEN_KEY = "EFX_TOKEN";
let TOKEN = localStorage.getItem(TOKEN_KEY) || null;

function needAuth(){
  if(!TOKEN){
    $("#msg").textContent = "Debes iniciar sesi√≥n en la p√°gina principal.";
    alert("Debes iniciar sesi√≥n (demo) primero.");
    location.href = "/static/index.html";
    return true;
  }
  return false;
}

async function fetchOrder(){
  const box = $("#orderBox");
  try{
    const r = await fetch(`/orders/${ORDER_ID}`, {
      headers: { "Authorization":"Bearer " + TOKEN }
    });
    if(!r.ok){
      const t = await r.text().catch(()=>"(sin detalle)");
      box.textContent = "No se pudo cargar la orden. " + t;
      return null;
    }

    const o = await r.json();
    box.innerHTML = `
      <div class="row"><div class="muted">ID</div><div>${o.id}</div></div>
      <div class="row"><div class="muted">Parche</div><div>${o.patch_option_id}</div></div>
      <div class="row"><div class="muted">Estado</div><div>${o.status}</div></div>
      <div class="row"><div class="muted">Fecha</div><div>${o.created_at || "‚Äî"}</div></div>
      <div class="row"><div class="muted">Monto</div><div>$59.00 <span class="muted">(demo)</span></div></div>
    `;

    const dl = $("#btnDownload");
    if (o.status === "done" && o.download_ready){
      dl.style.display = "inline-block";
      dl.href = `/download/${o.id}`;
      dl.setAttribute("download", "");
      dl.textContent = "‚¨áÔ∏è Descargar .MOD";
    } else {
      dl.style.display = "none";
      dl.removeAttribute("href");
      dl.removeAttribute("download");
    }

    return o;
  }catch(e){
    box.textContent = "Error de red.";
    return null;
  }
}

async function demoPay(){
  $("#msg").textContent = "Procesando pago demo‚Ä¶";

  const r = await fetch(`/orders/${ORDER_ID}/confirm_payment`, {
    method: "POST",
    headers: { "Authorization": "Bearer " + TOKEN }
  });

  if(!r.ok){
    const t = await r.text().catch(()=>"(sin detalle)");
    $("#msg").textContent = "No se pudo confirmar el pago: " + t;
    return;
  }

  const d = await r.json();
  $("#msg").textContent = "Pago confirmado. MOD listo ‚úÖ";

  const dl = $("#btnDownload");
  dl.style.display = "inline-block";
  dl.href = d.download_url; // /download/{order_id}
  dl.setAttribute("download", "");
  dl.textContent = "‚¨áÔ∏è Descargar .MOD";

  await fetchOrder();
}

function init(){
  if(!ORDER_ID){
    alert("Falta order_id en la URL");
    $("#orderBox").textContent = "Falta order_id en la URL.";
    return;
  }
  if(needAuth()) return;

  $("#btnDemoPay").onclick = demoPay;
  fetchOrder();
}

document.addEventListener("DOMContentLoaded", init);
</script>
<script>
  (function () {
    // intenta pillar botones por texto o por ids comunes
    const payBtn =
      document.querySelector("#btnPay") ||
      document.querySelector("#payBtn") ||
      Array.from(document.querySelectorAll("button")).find(b => b.textContent.toLowerCase().includes("confirmar pago"));

    const dlBtn =
      document.querySelector("#btnDownload") ||
      document.querySelector("#downloadBtn") ||
      Array.from(document.querySelectorAll("a,button")).find(b => b.textContent.toLowerCase().includes("descargar"));

    const isDemo = true; // en tu checkout dice DEMO, as√≠ que lo dejamos fijo por ahora

    function lockIfNeeded() {
      if (!isDemo) return;

      if (!window.EFX || !EFX.isLoggedIn || !EFX.isLoggedIn()) {
        if (payBtn) {
          payBtn.disabled = true;
          payBtn.title = "Debes iniciar sesi√≥n para continuar (DEMO)";
        }
        if (dlBtn) {
          // si es <a> lo deshabilitamos ‚Äúa mano‚Äù
          dlBtn.style.pointerEvents = "none";
          dlBtn.style.opacity = "0.6";
          dlBtn.title = "Debes iniciar sesi√≥n para descargar (DEMO)";
        }

        // mensaje claro
        const box = document.createElement("div");
        box.className = "card";
        box.style.marginTop = "12px";
        box.innerHTML = "<b>üîí DEMO</b><br>Para descargar debes <b>iniciar sesi√≥n</b>.";
        const target = document.querySelector(".container") || document.body;
        target.appendChild(box);

        // si hacen click igual, mandamos a login
        if (payBtn) payBtn.addEventListener("click", (e) => { e.preventDefault(); EFX.requireLogin(location.href); });
        if (dlBtn) dlBtn.addEventListener("click", (e) => { e.preventDefault(); EFX.requireLogin(location.href); });
      }
    }

    lockIfNeeded();
  })();
</script>
<script>
  (function () {
    const payBtn = document.getElementById("btnPay");
    const dlBtn  = document.getElementById("btnDownload");

    // DEMO = true por ahora
    const isDemo = true;

    if (!isDemo) return;

    const isLogged =
      (localStorage.getItem("token") ||
       localStorage.getItem("access_token") ||
       localStorage.getItem("jwt") ||
       sessionStorage.getItem("token") ||
       sessionStorage.getItem("access_token"));

    if (!isLogged) {
      if (payBtn) {
        payBtn.disabled = true;
        payBtn.title = "Debes iniciar sesi√≥n para continuar (DEMO)";
      }
      if (dlBtn) {
        dlBtn.style.pointerEvents = "none";
        dlBtn.style.opacity = "0.6";
        dlBtn.title = "Debes iniciar sesi√≥n para descargar (DEMO)";
      }

      const box = document.createElement("div");
      box.className = "card";
      box.style.marginTop = "12px";
      box.innerHTML = "<b>üîí DEMO</b><br>Para descargar debes <b>iniciar sesi√≥n</b>.";
      (document.querySelector(".container") || document.body).appendChild(box);

      const goLogin = () => location.href = "/static/usuarios.html#login?next=" + encodeURIComponent(location.href);
      if (payBtn) payBtn.addEventListener("click", (e)=>{ e.preventDefault(); goLogin(); });
      if (dlBtn)  dlBtn.addEventListener("click", (e)=>{ e.preventDefault(); goLogin(); });
    }
  })();
</script>
</body>
</html>


