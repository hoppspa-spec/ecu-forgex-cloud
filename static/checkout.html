<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ECU FORGE X ‚Äî Checkout</title>

  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/efx.css">
</head>

<body>
<header class="efx-topbar">
  <div class="brand">ECU FORGE X</div>
</header>

<div class="wrap">

  <!-- 1) Customer form -->
  <div class="card" id="customerCard">
    <h3>Customer details</h3>
    <div class="muted">Required to proceed to payment.</div>

    <div class="grid" style="margin-top:12px; gap:10px;">
      <div>
        <label class="muted">Company / Full name *</label>
        <input id="c_name" class="input" type="text" placeholder="e.g. ACME Ltd. / John Smith" />
      </div>

      <div>
        <label class="muted">Email *</label>
        <input id="c_email" class="input" type="email" placeholder="name@domain.com" />
      </div>

      <div>
        <label class="muted">Confirm email *</label>
        <input id="c_email2" class="input" type="email" placeholder="repeat email" />
      </div>

      <div>
        <label class="muted">Phone *</label>
        <input id="c_phone" class="input" type="tel" placeholder="+1 555 123 4567" />
      </div>

      <div>
        <label class="muted">Address *</label>
        <input id="c_address" class="input" type="text" placeholder="Street + number" />
      </div>

      <div>
        <label class="muted">City / Comuna *</label>
        <input id="c_city" class="input" type="text" placeholder="e.g. Las Condes" />
      </div>

      <div>
        <label class="muted">Country *</label>
        <input id="c_country" class="input" type="text" placeholder="e.g. Chile / USA" />
      </div>
    </div>

    <div class="actions" style="margin-top:14px">
      <button id="btnContinue" class="btn ok" type="button">Continue to payment</button>
      <a class="btn gray" href="https://www.hopp.cl/efxv1">‚Üê Back</a>
    </div>

    <div id="formMsg" class="muted" style="margin-top:10px"></div>
  </div>

  <!-- 2) Order / summary -->
  <div class="card" id="summaryCard" style="display:none;">
    <h3>Order summary</h3>
    <div id="summaryBox" class="muted">Loading‚Ä¶</div>

    <div class="actions" style="margin-top:14px">
      <a id="btnPay" class="btn ok" href="#" style="display:none">üí≥ Pay</a>
      <a id="btnDownload" class="btn ok" href="#" style="display:none" download>‚¨áÔ∏è Download .MOD</a>
      <a class="btn gray" href="/static/index.html">‚Üê Home</a>
    </div>

    <div id="orderMsg" class="muted" style="margin-top:10px"></div>
  </div>

</div>

<script>
/* =========================
   Utils / storage
========================= */
const $ = (q, el=document) => el.querySelector(q);
const params = new URLSearchParams(location.search);
const ORDER_ID = params.get("order_id") || params.get("orderId") || "";

const LS_KEY = "EFX_CUSTOMER_V1";

function setMsg(id, t){ const el = $(id); if (el) el.textContent = t || ""; }
function show(id){ const el = $(id); if (el) el.style.display = ""; }
function hide(id){ const el = $(id); if (el) el.style.display = "none"; }

function loadSavedCustomer(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function saveCustomer(c){
  localStorage.setItem(LS_KEY, JSON.stringify(c));
}

function isValidEmail(email){
  const e = String(email || "").trim();
  // suficiente para V1 (sin sobre-validar)
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
}

function getCustomerFromForm(){
  return {
    name: $("#c_name").value.trim(),
    email: $("#c_email").value.trim(),
    email2: $("#c_email2").value.trim(),
    phone: $("#c_phone").value.trim(),
    address: $("#c_address").value.trim(),
    city: $("#c_city").value.trim(),
    country: $("#c_country").value.trim(),
  };
}

function validateCustomer(c){
  if (!c.name) return "Company / Full name is required.";
  if (!c.email) return "Email is required.";
  if (!isValidEmail(c.email)) return "Email format is invalid.";
  if (!c.email2) return "Please confirm your email.";
  if (c.email.toLowerCase() !== c.email2.toLowerCase()) return "Emails do not match.";
  if (!c.phone || c.phone.replace(/\D/g,"").length < 7) return "Phone is required (min 7 digits).";
  if (!c.address) return "Address is required.";
  if (!c.city) return "City / Comuna is required.";
  if (!c.country) return "Country is required.";
  return null;
}

/* =========================
   Step 2 placeholder:
   This will be wired in next step to your backend:
   POST /public/checkout
   body: { order_id(optional), customer, vehicle, patches }
   resp: { order_id, checkout_url }
========================= */
async function createCheckout(customer){
  const r = await fetch(`/public/checkout`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      customer: {
        name: customer.name,
        email: customer.email,
        phone: customer.phone,
        address: customer.address,
        city: customer.city,
        country: customer.country,
      },
      // üî• para Step 2: en V1 m√≠nimo manda patches desde Wix/session o URL
      // aqu√≠ puedes mandar desde query params o luego lo conectamos directo con Wix
      vehicle: window.__EFX_VEHICLE__ || null,
      patches: window.__EFX_PATCHES__ || [],
    })
  });

  if(!r.ok){
    const t = await r.text().catch(()=>"(sin detalle)");
    throw new Error(`Checkout failed (${r.status}): ${t}`);
  }

  return await r.json(); // { order_id, checkout_url }
}

/* =========================
   Init
========================= */
function prefill(){
  const c = loadSavedCustomer();
  if (!c) return;
  $("#c_name").value = c.name || "";
  $("#c_email").value = c.email || "";
  $("#c_email2").value = c.email || "";
  $("#c_phone").value = c.phone || "";
  $("#c_address").value = c.address || "";
  $("#c_city").value = c.city || "";
  $("#c_country").value = c.country || "";
}

async function onContinue(){
  setMsg("#formMsg", "");
  const c = getCustomerFromForm();
  const err = validateCustomer(c);
  if (err){
    setMsg("#formMsg", "‚ùå " + err);
    return;
  }

  // Save customer (without email2)
  saveCustomer({
    name: c.name,
    email: c.email,
    phone: c.phone,
    address: c.address,
    city: c.city,
    country: c.country,
  });

  $("#btnContinue").disabled = true;
  $("#btnContinue").textContent = "Saving‚Ä¶";

  try{
    const data = await createCheckout(c);
    if (data.checkout_url){
  location.href = data.checkout_url; // üî• pay now
  return;
  }


    // V1: mostramos summaryCard aunque checkout_url a√∫n no exista (se conecta en Step 2)
    hide("#customerCard");
    show("#summaryCard");

    const lines = [];
    lines.push("Customer saved ‚úÖ");
    lines.push("");
    lines.push(`Order: ${data.order_id || "-"}`);
    lines.push("Next: connect PayPal checkout (Step 2).");

    $("#summaryBox").textContent = lines.join("\n");
    setMsg("#orderMsg", "Waiting backend checkout_url‚Ä¶");

    // si existiera checkout_url (Step 2), mostramos bot√≥n pagar
    if (data.checkout_url){
      const pay = $("#btnPay");
      pay.style.display = "inline-flex";
      pay.href = data.checkout_url;
    }

  }catch(e){
    console.error(e);
    setMsg("#formMsg", "‚ùå Error: " + (e.message || "Unknown"));
  }finally{
    $("#btnContinue").disabled = false;
    $("#btnContinue").textContent = "Continue to payment";
  }
}

document.addEventListener("DOMContentLoaded", () => {
  prefill();
  $("#btnContinue").addEventListener("click", onContinue);
});
</script>

</body>
</html>
