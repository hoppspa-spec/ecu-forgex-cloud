<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ECU FORGE X ‚Äî Checkout</title>
<style>
  :root{--bg:#0b0f19;--card:#0f1629;--ink:#e5e7eb;--muted:#94a3b8;--stroke:#1f2a44;--btn:#2563eb;--btnh:#1d4ed8;--ok:#22c55e;}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial}
  header{background:#0b1220;color:#fff;padding:14px 18px;display:flex;gap:12px;align-items:center}
  header .grow{flex:1}
  a{color:#93c5fd;text-decoration:none}
  .wrap{padding:18px;display:grid;gap:18px;grid-template-columns:1fr 320px}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:16px}
  .row{display:grid;grid-template-columns:160px 1fr;gap:8px;margin:10px 0}
  .muted{color:var(--muted)}
  .btn{background:var(--btn);border:0;color:#fff;padding:12px 16px;border-radius:10px;cursor:pointer}
  .btn:hover{background:var(--btnh)}
  .btn.gray{background:#374151}
  .btn.ok{background:var(--ok);color:#00150a}
  .actions{display:flex;flex-direction:column;gap:12px}
  .help li{margin:6px 0}
</style>
</head>
<body>
<header>
  <strong>ECU FORGE X</strong>
  <div class="grow"></div>
  <a href="/static/index.html">Subir BIN</a>
  <a href="/static/usuarios.html">Mis √≥rdenes</a>
</header>

<div class="wrap">
  <div class="card">
    <h3>Checkout</h3>
    <div id="orderBox" class="muted">Cargando orden‚Ä¶</div>
    <div class="actions" style="margin-top:14px">
      <button id="btnPaypal" class="btn">Pagar con PayPal</button>
      <button id="btnCard" class="btn gray">Tarjeta de d√©bito o cr√©dito</button>
      <button id="btnDemo" class="btn ok">üí≥ Pago DEMO (confirmar sin PayPal)</button>
      <a id="btnDownload" class="btn" style="display:none" download>‚¨áÔ∏è Descargar .MOD</a>
    </div>
    <div id="msg" class="muted" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3>Ayuda</h3>
    <ul class="help">
      <li>Si PayPal no carga en tu navegador, usa <b>Pago DEMO</b>.</li>
      <li>La descarga requiere sesi√≥n iniciada.</li>
    </ul>
  </div>
</div>

<script>
const $ = (q,el=document)=>el.querySelector(q);
const params = new URLSearchParams(location.search);
const ORDER_ID = Number(params.get("order_id") || "0");
let TOKEN = localStorage.getItem("EFX_TOKEN") || null;

function needAuth(){
  if(!TOKEN){
    $("#msg").textContent = "Inicia sesi√≥n en la p√°gina principal para continuar.";
    alert("Debes iniciar sesi√≥n para ver el checkout.");
    location.href = "/static/index.html";
    return true;
  }
  return false;
}

async function fetchOrder(){
  const box = $("#orderBox");
  try{
    const r = await fetch(`/orders/${ORDER_ID}`, { headers: { "Authorization":"Bearer "+TOKEN }});
    if(!r.ok){ box.textContent = "No se pudo cargar la orden."; return null; }
    const o = await r.json();
    box.innerHTML = `
      <div class="row"><div class="muted">ID</div><div>${o.id}</div></div>
      <div class="row"><div class="muted">Parche</div><div>${o.patch_option_id}</div></div>
      <div class="row"><div class="muted">Estado</div><div>${o.status}</div></div>
      <div class="row"><div class="muted">Archivo</div><div>${o.original_filename || "‚Äî"}</div></div>
      <div class="row"><div class="muted">Monto</div><div>$10.00 <span class="muted">(demo)</span></div></div>
    `;
    // si ya est√° listo, muestra descarga
    if (o.status === "done" && o.mod_file_path){
  const a = document.getElementById("btnDownload");
  a.style.display = "inline-block";
  a.href = `/orders/${o.id}/download?access_token=${encodeURIComponent(TOKEN)}`;
  a.setAttribute("download", "");
}


    }
    return o;
  }catch(e){
    box.textContent = "Error de red.";
    return null;
  }
}

async function demoPay(){
  $("#msg").textContent = "Procesando pago demo‚Ä¶";

  const r = await fetch(`/orders/${ORDER_ID}/confirm_payment`, {
    method: "POST",
    headers: { "Authorization": "Bearer " + TOKEN }
  });

  if(!r.ok){
    const t = await r.text();
    $("#msg").textContent = "No se pudo confirmar el pago: " + t;
    return;
  }

  const d = await r.json();
  $("#msg").textContent = "Pago confirmado. MOD generado.";

  // ACTIVAR BOT√ìN DESCARGA
  const a = document.getElementById("btnDownload");
  a.style.display = "inline-block";

  // LINK DE DESCARGA con token incrustado
  a.href = d.download_url + `?access_token=${encodeURIComponent(TOKEN)}`;
  a.setAttribute("download", "");

  await fetchOrder();
}


function wire(){
  if(needAuth()) return;
  if(!ORDER_ID){ alert("order_id faltante en la URL"); return; }
  fetchOrder();
  $("#btnDemo").onclick = demoPay;
  // botones reales (col√≥cale tu integraci√≥n cuando la tengas):
  $("#btnPaypal").onclick = ()=> alert("Integra PayPal aqu√≠. Por ahora usa Pago DEMO.");
  $("#btnCard").onclick   = ()=> alert("Integra tarjeta aqu√≠. Por ahora usa Pago DEMO.");
}
document.addEventListener("DOMContentLoaded", wire);
</script>
</body>
</html>
