<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>ECU FORGE X â€” Checkout</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{margin:0;font-family:Arial,system-ui,Segoe UI;background:#f6f7fb;color:#111}
  header{background:#0b1220;color:#fff;padding:14px 18px;display:flex;gap:10px;align-items:center}
  header .grow{flex:1}
  header .btn{background:#1e293b;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  header .btn.alt{background:#0ea5e9}
  .wrap{max-width:900px;margin:22px auto;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:18px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{border:1px solid #eee;border-radius:10px;padding:14px}
  button{padding:12px 14px;border-radius:10px;border:0;background:#0066ff;color:#fff;cursor:pointer}
  button:hover{background:#004bcc}
  .muted{color:#64748b}
  .tag{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef;color:#1f2937}
  .hidden{display:none}
</style>
</head>
<body>
<header>
  <div style="font-weight:700;font-size:20px">ECU FORGE X â€” Checkout</div>
  <div class="grow"></div>
  <button class="btn" id="btnOpenLogin">Iniciar sesiÃ³n</button>
  <button class="btn alt" id="btnOpenRegister">Crear cuenta</button>
  <button class="btn" id="btnLogout" style="display:none">Cerrar sesiÃ³n</button>
</header>

<div class="wrap">
  <div class="row">
    <div class="card">
      <h3>Resumen</h3>
      <div id="resumen" class="muted">Cargandoâ€¦</div>
    </div>
    <div class="card">
      <h3>Pago</h3>
      <p class="muted">Demo: al confirmar, generamos el archivo <b>.mod</b> y queda listo para descargar.</p>
      <div>
        <button id="btnPagar">Confirmar pago</button>
        <a id="btnDescargar" class="hidden" download>
          <button style="margin-left:8px;background:#28a745">Descargar archivo</button>
        </a>
      </div>
    </div>
  </div>
  <div style="margin-top:16px;display:flex;gap:10px">
    <a href="/static/usuarios.html"><button style="background:#555">Ir a mis Ã³rdenes</button></a>
    <a href="/static/index.html"><button style="background:#777">Volver</button></a>
  </div>
</div>

<!-- MODAL LOGIN -->
<div id="modalLogin" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center">
  <div style="background:#fff;padding:18px;border-radius:12px;width:340px;box-shadow:0 8px 30px rgba(0,0,0,.25)">
    <h3>Iniciar sesiÃ³n</h3>
    <input id="login_email" placeholder="Email" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px" />
    <input id="login_pass" type="password" placeholder="ContraseÃ±a" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px" />
    <button id="btnLogin">Ingresar</button>
  </div>
</div>

<!-- MODAL REGISTRO -->
<div id="modalRegister" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center">
  <div style="background:#fff;padding:18px;border-radius:12px;width:340px;box-shadow:0 8px 30px rgba(0,0,0,.25)">
    <h3>Crear cuenta</h3>
    <input id="reg_name" placeholder="Nombre (opcional)" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px" />
    <input id="reg_email" placeholder="Email" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px" />
    <input id="reg_pass" type="password" placeholder="ContraseÃ±a (min 6)" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px" />
    <button id="btnRegister">Registrarme</button>
  </div>
</div>

<script>
let TOKEN=null, ORDER_ID=null, CURRENT=null;
const $=(q,el=document)=>el.querySelector(q);
const getParam=(k)=>new URLSearchParams(location.search).get(k);

function setAuthUi(on){ $("#btnOpenLogin").style.display=on?"none":"inline-block";
                         $("#btnOpenRegister").style.display=on?"none":"inline-block";
                         $("#btnLogout").style.display=on?"inline-block":"none"; }

$("#btnOpenLogin").onclick = ()=>$("#modalLogin").style.display="flex";
$("#btnOpenRegister").onclick = ()=>$("#modalRegister").style.display="flex";
$("#btnLogout").onclick = ()=>{ TOKEN=null; setAuthUi(false); };

$("#btnLogin").onclick = async ()=>{
  const fd=new FormData();
  fd.append("username", $("#login_email").value);
  fd.append("password", $("#login_pass").value);
  const r=await fetch("/auth/login",{method:"POST",body:fd});
  if(!r.ok){ alert("Credenciales invÃ¡lidas"); return; }
  TOKEN=(await r.json()).access_token; $("#modalLogin").style.display="none"; setAuthUi(true); load();
};

$("#btnRegister").onclick = async ()=>{
  const payload={email:$("#reg_email").value,password:$("#reg_pass").value,full_name:$("#reg_name").value||null};
  const r=await fetch("/auth/register",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  if(!r.ok){ alert("No se pudo crear la cuenta"); return; }
  // auto login
  const fd=new FormData(); fd.append("username", payload.email); fd.append("password", payload.password);
  const lr=await fetch("/auth/login",{method:"POST",body:fd});
  if(lr.ok){ TOKEN=(await lr.json()).access_token; setAuthUi(true); $("#modalRegister").style.display="none"; load(); }
  else { $("#modalRegister").style.display="none"; alert("Cuenta creada. Inicia sesiÃ³n."); }
};

async function ensureAuth(){ if(TOKEN) return true; $("#modalLogin").style.display="flex"; return false; }

async function load(){
  ORDER_ID=parseInt(getParam("order_id")||"0",10);
  if(!(await ensureAuth())) return;
  const r=await fetch("/orders/mine",{headers:{Authorization:"Bearer "+TOKEN}});
  if(!r.ok){ $("#resumen").textContent="Error cargando Ã³rdenes"; return; }
  const j=await r.json();
  CURRENT=(j.orders||[]).find(o=>o.id===ORDER_ID);
  if(!CURRENT){ $("#resumen").textContent="Orden no encontrada"; return; }
  $("#resumen").innerHTML = `
    <div><b>Orden:</b> #${CURRENT.id}</div>
    <div><b>Parche:</b> <span class="tag">${CURRENT.patch_option_id}</span></div>
    <div><b>Estado:</b> ${CURRENT.status}</div>
    <div><b>Archivo:</b> ${CURRENT.original_filename||'â€”'}</div>
  `;
  if(CURRENT.download_ready){
    $("#btnDescargar").classList.remove("hidden");
    $("#btnDescargar").href="/orders/"+CURRENT.id+"/download";
  }
}

$("#btnPagar").onclick = async ()=>{
  if(!(await ensureAuth())) return;
  const r=await fetch(`/orders/${ORDER_ID}/confirm_payment`,{method:"POST",headers:{Authorization:"Bearer "+TOKEN}});
  if(!r.ok){ alert("No se pudo confirmar el pago"); return; }
  const d=await r.json();
  $("#btnDescargar").classList.remove("hidden");
  $("#btnDescargar").href=d.download_url;
  alert("Pago confirmado. Archivo generado ðŸ‘Œ");
  load();
};

load();
</script>
</body>
</html>
