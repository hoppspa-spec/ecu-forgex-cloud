<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ECU FORGE X ‚Äî Checkout</title>

  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/efx.css">
</head>

<body>
<header class="efx-topbar">
  <div class="brand">ECU FORGE X</div>
</header>

<div class="wrap">

  <!-- 1) Customer form -->
  <div class="card" id="customerCard">
    <h3>Customer details</h3>
    <div class="muted">Required to proceed to payment.</div>

    <div class="grid" style="margin-top:12px; gap:10px;">
      <div>
        <label class="muted">Company / Full name *</label>
        <input id="c_name" class="input" type="text" placeholder="e.g. ACME Ltd. / John Smith" />
      </div>

      <div>
        <label class="muted">Email *</label>
        <input id="c_email" class="input" type="email" placeholder="name@domain.com" />
      </div>

      <div>
        <label class="muted">Confirm email *</label>
        <input id="c_email2" class="input" type="email" placeholder="repeat email" />
      </div>

      <div>
        <label class="muted">Phone *</label>
        <input id="c_phone" class="input" type="tel" placeholder="+1 555 123 4567" />
      </div>

      <div>
        <label class="muted">Address *</label>
        <input id="c_address" class="input" type="text" placeholder="Street + number" />
      </div>

      <div>
        <label class="muted">City / Comuna *</label>
        <input id="c_city" class="input" type="text" placeholder="e.g. Las Condes" />
      </div>

      <div>
        <label class="muted">Country *</label>
        <input id="c_country" class="input" type="text" placeholder="e.g. Chile / USA" />
      </div>
    </div>

    <div class="actions" style="margin-top:14px">
      <button id="btnContinue" class="btn ok" type="button">Continue to payment</button>
      <a class="btn gray" href="https://www.hopp.cl/efxv1">‚Üê Back</a>
    </div>

    <div id="formMsg" class="muted" style="margin-top:10px"></div>
  </div>

  <!-- 2) Order / summary -->
  <div class="card" id="summaryCard" style="display:none;">
    <h3>Order summary</h3>
    <div id="summaryBox" class="muted">Loading‚Ä¶</div>

    <div class="actions" style="margin-top:14px">
      <a id="btnPay" class="btn ok" href="#" style="display:none">üí≥ Pay</a>
      <a id="btnDownload" class="btn ok" href="#" style="display:none" download>‚¨áÔ∏è Download .MOD</a>
      <a class="btn gray" href="/static/index.html">‚Üê Home</a>
    </div>

    <div id="orderMsg" class="muted" style="margin-top:10px"></div>
  </div>

</div>

<script>
/* =========================
   Utils
========================= */
const $ = (q, el=document) => el.querySelector(q);
const params = new URLSearchParams(location.search);
const ORDER_ID = params.get("order_id") || params.get("orderId") || "";

function setMsg(sel, t){ const el = $(sel); if (el) el.textContent = t || ""; }
function show(sel){ const el = $(sel); if (el) el.style.display = ""; }
function hide(sel){ const el = $(sel); if (el) el.style.display = "none"; }

function moneyUSD(n){
  const v = Number(n || 0);
  return `$${v.toFixed(2)} USD`;
}

/* =========================
   Public API
========================= */
async function fetchPublicOrder(orderId){
  const r = await fetch(`/public/order/${encodeURIComponent(orderId)}`);
  if(!r.ok){
    const t = await r.text().catch(()=>"(sin detalle)");
    throw new Error(`Order fetch failed (${r.status}): ${t}`);
  }
  return await r.json();
}

async function demoConfirmPayment(orderId){
  const r = await fetch(`/public/demo/confirm_payment/${encodeURIComponent(orderId)}`, {
    method: "POST"
  });
  if(!r.ok){
    const t = await r.text().catch(()=>"(sin detalle)");
    throw new Error(`Confirm payment failed (${r.status}): ${t}`);
  }
  return await r.json(); // { ok, order_id, download_url }
}

/* =========================
   UI render
========================= */
function renderOrder(o){
  const patches = o.selected_patches || o.patches || [];
  const patchTxt = Array.isArray(patches) ? patches.join(", ") : String(patches || "-");

  const lines = [];
  lines.push(`Order: ${o.id || "-"}`);
  lines.push(`Status: ${o.status || "-"}`);
  lines.push(`Total: ${moneyUSD(o.price_usd ?? o.total_usd ?? 0)}`);
  lines.push(`Patches: ${patchTxt}`);

  // si viene vehicle
  if (o.vehicle){
    const v = o.vehicle;
    lines.push("");
    lines.push(`Vehicle: ${v.brand || "-"} ${v.model || "-"} ${v.serie || ""}`.trim());
    lines.push(`Year: ${v.year || "-"}`);
    lines.push(`Fuel: ${v.fuelDb || v.fuel || "-"}`);
    lines.push(`ECU: ${v.ecu || "-"}`);
  }

  $("#summaryBox").textContent = lines.join("\n");

  // Download button
  const dlBtn = $("#btnDownload");
  const canDownload = (o.status === "paid" || o.status === "done") && !!o.download_ready;
  if (canDownload && dlBtn){
    dlBtn.style.display = "inline-flex";
    dlBtn.href = o.download_url || `/download/${o.id}`;
    dlBtn.setAttribute("download", "");
  } else if (dlBtn){
    dlBtn.style.display = "none";
    dlBtn.removeAttribute("href");
    dlBtn.removeAttribute("download");
  }
}

/* =========================
   Main init (Wix flow)
========================= */
async function init(){
  setMsg("#formMsg", "");
  setMsg("#orderMsg", "");

  // ‚úÖ Si hay order_id ‚Üí es flujo Wix: SOLO LEER orden
  if (ORDER_ID){
    hide("#customerCard");
    show("#summaryCard");
    $("#summaryBox").textContent = "Loading order‚Ä¶";

    try{
      const o = await fetchPublicOrder(ORDER_ID);
      renderOrder(o);

      // Bot√≥n Pay (DEMO): en V1 lo usamos como "Confirm demo payment"
      const payBtn = $("#btnPay");
      if (payBtn){
        payBtn.style.display = "inline-flex";
        payBtn.textContent = "‚úÖ Confirm payment (DEMO)";
        payBtn.href = "#";
        payBtn.onclick = async (e) => {
          e.preventDefault();
          setMsg("#orderMsg", "Processing demo payment‚Ä¶");
          try{
            await demoConfirmPayment(ORDER_ID);
            const o2 = await fetchPublicOrder(ORDER_ID);
            renderOrder(o2);
            setMsg("#orderMsg", "Paid ‚úÖ Download enabled.");
          }catch(err){
            console.error(err);
            setMsg("#orderMsg", "‚ùå " + (err.message || "Payment error"));
          }
        };
      }

    }catch(e){
      console.error(e);
      $("#summaryBox").textContent = "Error loading order.";
      setMsg("#orderMsg", "‚ùå " + (e.message || "Unknown error"));
    }
    return;
  }

  // ‚ùó Si NO hay order_id, no estamos en el flujo Wix.
  // Puedes mantener tu formulario para un futuro flow ‚Äústandalone‚Äù.
  // Por ahora, dejamos claro el error:
  show("#customerCard");
  hide("#summaryCard");
  setMsg("#formMsg", "‚ùå Missing order_id. This page must be opened from Wix checkout redirect.");
}

document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
