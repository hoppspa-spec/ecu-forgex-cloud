<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ECU FORGE X — Checkout</title>
<style>
  :root{--bg:#0b0f19;--card:#0f1629;--ink:#e5e7eb;--muted:#94a3b8;--stroke:#1f2a44;--btn:#2563eb;--btnh:#1d4ed8;--ok:#22c55e;}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial}
  header{background:#0b1220;color:#fff;padding:14px 18px;display:flex;gap:12px;align-items:center}
  header .grow{flex:1}
  a{color:#93c5fd;text-decoration:none}
  .wrap{padding:18px;display:grid;gap:18px;grid-template-columns:1fr 320px}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:16px}
  .row{display:grid;grid-template-columns:160px 1fr;gap:8px;margin:10px 0}
  .muted{color:var(--muted)}
  .btn{background:var(--btn);border:0;color:#fff;padding:12px 16px;border-radius:10px;cursor:pointer;display:inline-block;text-align:center}
  .btn:hover{background:var(--btnh)}
  .btn.ok{background:var(--ok);color:#00150a}
  .actions{display:flex;flex-direction:column;gap:12px}
  .help li{margin:6px 0}
</style>
</head>
<body>
<header>
  <strong>ECU FORGE X</strong>
  <div class="grow"></div>
  <a href="/static/index.html">Subir BIN</a>
</header>

<div class="wrap">
  <div class="card">
    <h3>Checkout (DEMO)</h3>
    <div id="orderBox" class="muted">Cargando orden…</div>

    <div class="actions" style="margin-top:14px">
      <a id="btnDownload" class="btn ok" style="display:none" download>⬇️ Descargar .MOD</a>
      <a class="btn" href="/static/index.html">← Volver</a>
    </div>

    <div id="msg" class="muted" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3>Ayuda</h3>
    <ul class="help">
      <li>Modo demo: la orden queda <b>paid</b> al tiro.</li>
      <li>La descarga se hace desde <code>/download/&lt;order_id&gt;</code>.</li>
    </ul>
  </div>
</div>

<script>
const $ = (q,el=document)=>el.querySelector(q);
const params = new URLSearchParams(location.search);
const ORDER_ID = (params.get("order_id") || "").trim(); // UUID string

async function fetchOrder(){
  const box = $("#orderBox");
  const msg = $("#msg");
  if(!ORDER_ID){
    box.textContent = "Falta order_id en la URL.";
    return null;
  }

  try{
    const r = await fetch(`/orders/${encodeURIComponent(ORDER_ID)}`, { cache:"no-store" });
    if(!r.ok){
      const t = await r.text().catch(()=>"(sin detalle)");
      box.textContent = "No se pudo cargar la orden: " + t;
      return null;
    }
    const o = await r.json();

    box.innerHTML = `
      <div class="row"><div class="muted">ID</div><div>${o.id}</div></div>
      <div class="row"><div class="muted">Parche</div><div>${o.patch_option_id}</div></div>
      <div class="row"><div class="muted">Estado</div><div>${o.status}</div></div>
      <div class="row"><div class="muted">Analysis ID</div><div>${o.analysis_id}</div></div>
    `;

    // Demo: si está paid, habilitamos descarga inmediata
    const dl = $("#btnDownload");
    if(o.status === "paid"){
      dl.style.display = "inline-block";
      dl.href = `/download/${encodeURIComponent(o.id)}`;
      dl.setAttribute("download","");
      msg.textContent = "Pago demo OK. Descarga disponible.";
    }else{
      dl.style.display = "none";
      dl.removeAttribute("href");
      msg.textContent = "Orden aún no pagada.";
    }

    return o;
  }catch(e){
    box.textContent = "Error de red.";
    return null;
  }
}

document.addEventListener("DOMContentLoaded", fetchOrder);
</script>
</body>
</html>
