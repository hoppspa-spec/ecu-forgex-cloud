<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ECU FORGE X</title>

  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/efx.css">

  <script src="/static/js/theme.js"></script>
</head>

<body>
<header class="efx-topbar">
  <div class="efx-title">ECU FORGE X</div>

  <div class="efx-actions">
    <button class="btn" onclick="location.href='/static/login.html'">
      Iniciar sesi√≥n
    </button>

    <button class="btn" onclick="location.href='/static/register.html'">
      Registro
    </button>

    <button class="btn" onclick="EFX.toggleTheme()" title="Dark / Light">
      üåô / ‚òÄÔ∏è
    </button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h3>Checkout (DEMO)</h3>
    <div id="orderBox" class="muted">Cargando orden‚Ä¶</div>

    <div class="actions" style="margin-top:14px">
      <button id="btnDemoPay" class="btn">‚úÖ Confirmar pago DEMO</button>
      <a id="btnDownload" class="btn ok" style="display:none" download>‚¨áÔ∏è Descargar .MOD</a>
      <a class="btn gray" href="/static/index.html">‚Üê Volver</a>
    </div>

    <div id="msg" class="muted" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <h3>Ayuda</h3>
    <ul class="help">
      <li>Modo demo: confirmas el pago y se habilita descarga.</li>
      <li>La descarga viene de <code>/download/&lt;order_id&gt;</code>.</li>
    </ul>
  </div>
</div>

<script>
const $ = (q,el=document)=>el.querySelector(q);
const params = new URLSearchParams(location.search);
const ORDER_ID = params.get("order_id") || "";

const TOKEN_KEY = "EFX_TOKEN";
let TOKEN = localStorage.getItem(TOKEN_KEY) || null;

function needAuth(){
  if(!TOKEN){
    $("#msg").textContent = "Debes iniciar sesi√≥n en la p√°gina principal.";
    alert("Debes iniciar sesi√≥n (demo) primero.");
    location.href = "/static/index.html";
    return true;
  }
  return false;
}

async function fetchOrder(){
  const box = $("#orderBox");
  try{
    const r = await fetch(`/orders/${ORDER_ID}`, {
      headers: { "Authorization":"Bearer " + TOKEN }
    });
    if(!r.ok){
      const t = await r.text().catch(()=>"(sin detalle)");
      box.textContent = "No se pudo cargar la orden. " + t;
      return null;
    }

    const o = await r.json();
    box.innerHTML = `
      <div class="row"><div class="muted">ID</div><div>${o.id}</div></div>
      <div class="row"><div class="muted">Parche</div><div>${o.patch_option_id}</div></div>
      <div class="row"><div class="muted">Estado</div><div>${o.status}</div></div>
      <div class="row"><div class="muted">Fecha</div><div>${o.created_at || "‚Äî"}</div></div>
      <div class="row"><div class="muted">Monto</div><div>$59.00 <span class="muted">(demo)</span></div></div>
    `;

    const dl = $("#btnDownload");
    if (o.status === "done" && o.download_ready){
      dl.style.display = "inline-block";
      dl.href = `/download/${o.id}`;
      dl.setAttribute("download", "");
      dl.textContent = "‚¨áÔ∏è Descargar .MOD";
    } else {
      dl.style.display = "none";
      dl.removeAttribute("href");
      dl.removeAttribute("download");
    }

    return o;
  }catch(e){
    box.textContent = "Error de red.";
    return null;
  }
}

async function demoPay(){
  $("#msg").textContent = "Procesando pago demo‚Ä¶";

  const r = await fetch(`/orders/${ORDER_ID}/confirm_payment`, {
    method: "POST",
    headers: { "Authorization": "Bearer " + TOKEN }
  });

  if(!r.ok){
    const t = await r.text().catch(()=>"(sin detalle)");
    $("#msg").textContent = "No se pudo confirmar el pago: " + t;
    return;
  }

  const d = await r.json();
  $("#msg").textContent = "Pago confirmado. MOD listo ‚úÖ";

  const dl = $("#btnDownload");
  dl.style.display = "inline-block";
  dl.href = d.download_url; // /download/{order_id}
  dl.setAttribute("download", "");
  dl.textContent = "‚¨áÔ∏è Descargar .MOD";

  await fetchOrder();
}

function init(){
  if(!ORDER_ID){
    alert("Falta order_id en la URL");
    $("#orderBox").textContent = "Falta order_id en la URL.";
    return;
  }
  if(needAuth()) return;

  $("#btnDemoPay").onclick = demoPay;
  fetchOrder();
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>


