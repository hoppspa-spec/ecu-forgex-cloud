<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>ECU FORGE X — Mis Órdenes</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{margin:0;font-family:Arial,system-ui,Segoe UI;background:#f6f7fb;color:#111}
  header{background:#0b1220;color:#fff;padding:14px 18px;display:flex;gap:10px;align-items:center}
  header .grow{flex:1}
  header .btn{background:#1e293b;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  header .btn.alt{background:#0ea5e9}
  .wrap{max-width:1000px;margin:22px auto;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:18px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
  .tag{display:inline-block;padding:3px 8px;border-radius:999px;background:#eef;color:#1f2937}
  button{padding:8px 12px;border-radius:10px;border:0;background:#0066ff;color:#fff;cursor:pointer}
  button:hover{background:#004bcc}
</style>
</head>
<body>
<header>
  <div style="font-weight:700;font-size:20px">ECU FORGE X — Mis Órdenes</div>
  <div class="grow"></div>
  <a href="/static/index.html"><button class="btn">Volver</button></a>
  <button class="btn" id="btnOpenLogin">Iniciar sesión</button>
  <button class="btn alt" id="btnOpenRegister">Crear cuenta</button>
  <button class="btn" id="btnLogout" style="display:none">Cerrar sesión</button>
</header>

<div class="wrap">
  <table id="tbl">
    <thead>
      <tr>
        <th>ID</th>
        <th>Archivo</th>
        <th>Parche</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody><tr><td colspan="5">Cargando…</td></tr></tbody>
  </table>
</div>

<!-- MODAL LOGIN -->
<div id="modalLogin" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center">
  <div style="background:#fff;padding:18px;border-radius:12px;width:340px;box-shadow:0 8px 30px rgba(0,0,0,.25)">
    <h3>Iniciar sesión</h3>
    <input id="login_email" placeholder="Email" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px" />
    <input id="login_pass" type="password" placeholder="Contraseña" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px" />
    <button id="btnLogin">Ingresar</button>
  </div>
</div>

<!-- MODAL REGISTRO -->
<div id="modalRegister" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center">
  <div style="background:#fff;padding:18px;border-radius:12px;width:340px;box-shadow:0 8px 30px rgba(0,0,0,.25)">
    <h3>Crear cuenta</h3>
    <input id="reg_name" placeholder="Nombre (opcional)" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px" />
    <input id="reg_email" placeholder="Email" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px" />
    <input id="reg_pass" type="password" placeholder="Contraseña (min 6)" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px" />
    <button id="btnRegister">Registrarme</button>
  </div>
</div>

<script>
let TOKEN=null;
const $=(q,el=document)=>el.querySelector(q);

function setAuthUi(on){ $("#btnOpenLogin").style.display=on?"none":"inline-block";
                         $("#btnOpenRegister").style.display=on?"none":"inline-block";
                         $("#btnLogout").style.display=on?"inline-block":"none"; }
$("#btnOpenLogin").onclick=()=>$("#modalLogin").style.display="flex";
$("#btnOpenRegister").onclick=()=>$("#modalRegister").style.display="flex";
$("#btnLogout").onclick=()=>{ TOKEN=null; setAuthUi(false); load(); };

$("#btnLogin").onclick = async ()=>{
  const fd=new FormData();
  fd.append("username", $("#login_email").value);
  fd.append("password", $("#login_pass").value);
  const r=await fetch("/auth/login",{method:"POST",body:fd});
  if(!r.ok){ alert("Credenciales inválidas"); return; }
  TOKEN=(await r.json()).access_token; $("#modalLogin").style.display="none"; setAuthUi(true); load();
};

$("#btnRegister").onclick = async ()=>{
  const payload={email:$("#reg_email").value,password:$("#reg_pass").value,full_name:$("#reg_name").value||null};
  const r=await fetch("/auth/register",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  if(!r.ok){ alert("No se pudo crear la cuenta"); return; }
  const fd=new FormData(); fd.append("username", payload.email); fd.append("password", payload.password);
  const lr=await fetch("/auth/login",{method:"POST",body:fd});
  if(lr.ok){ TOKEN=(await lr.json()).access_token; setAuthUi(true); $("#modalRegister").style.display="none"; load(); }
  else { $("#modalRegister").style.display="none"; alert("Cuenta creada. Inicia sesión."); }
};

async function ensureAuth(){ if(TOKEN) return true; $("#modalLogin").style.display="flex"; return false; }

async function load(){
  const tbody=$("#tbl tbody"); tbody.innerHTML=`<tr><td colspan="5">Cargando…</td></tr>`;
  if(!(await ensureAuth())) return;
  const r=await fetch("/orders/mine",{headers:{Authorization:"Bearer "+TOKEN}});
  if(!r.ok){ tbody.innerHTML=`<tr><td colspan="5">Error cargando órdenes</td></tr>`; return; }
  const j=await r.json();
  const rows=(j.orders||[]).map(o=>{
    const dBtn=o.download_ready
      ? `<a href="/orders/${o.id}/download"><button style="background:#28a745">Descargar</button></a>`
      : `<span class="tag">Pendiente</span>`;
    return `<tr>
      <td>#${o.id}</td>
      <td>${o.original_filename||"—"}</td>
      <td><span class="tag">${o.patch_option_id}</span></td>
      <td>${o.status}</td>
      <td>${dBtn}</td>
    </tr>`;
  }).join("") || `<tr><td colspan="5">Sin órdenes</td></tr>`;
  tbody.innerHTML=rows;
}

load();
</script>
</body>
</html>
