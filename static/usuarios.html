<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>ECU FORGE X — Mis órdenes</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#f4f6fb;--card:#fff;--ink:#111;--muted:#64748b;--brand:#0b1220;--btn:#0066ff;--btnh:#004bcc;--stroke:#e5e7eb;}
  *{box-sizing:border-box} body{margin:0;font-family:Arial,system-ui;background:var(--bg);color:var(--ink)}
  header{background:var(--brand);color:#fff;padding:14px 18px;display:flex;align-items:center;gap:12px}
  header .grow{flex:1}
  header a{color:#cbd5e1;text-decoration:none} header a:hover{color:#fff}
  .wrap{max-width:1040px;margin:18px auto;padding:0 14px}
  .card{background:var(--card);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:18px}
  h2{margin:0 0 12px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px 12px;border-bottom:1px solid var(--stroke);text-align:left;font-size:14px}
  .badge{display:inline-block;background:#eef;padding:4px 8px;border-radius:999px;font-size:12px;color:#1f2937}
  .muted{color:var(--muted)}
  .actions a, .actions button{margin-right:8px}
  button, a.btn{background:var(--btn);color:#fff;border:0;border-radius:8px;padding:8px 12px;text-decoration:none;cursor:pointer}
  button:hover, a.btn:hover{background:var(--btnh)}
</style>
</head>
<body>

<header>
  <div style="font-weight:700;font-size:20px">ECU FORGE X</div>
  <div class="grow"></div>
  <a href="/static/index.html">Inicio</a>
</header>

<div class="wrap">
  <div class="card">
    <h2>Mis órdenes</h2>
    <div id="status" class="muted">Cargando…</div>
    <div style="overflow:auto">
      <table id="tbl" style="display:none">
        <thead>
          <tr>
            <th>ID</th>
            <th>Estado</th>
            <th>Parche</th>
            <th>Archivo</th>
            <th>Fecha</th>
            <th>Descarga</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal Login -->
<div id="modalLogin" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center">
  <div style="background:#fff;padding:18px;border-radius:10px;width:340px;box-shadow:0 8px 30px rgba(0,0,0,.25)">
    <h3>Iniciar sesión</h3>
    <input id="login_email" placeholder="Email" style="width:100%;padding:10px;border:1px solid var(--stroke);border-radius:8px;margin:6px 0"/>
    <input id="login_pass" type="password" placeholder="Contraseña" style="width:100%;padding:10px;border:1px solid var(--stroke);border-radius:8px;margin:6px 0"/>
    <button id="btnLogin">Ingresar</button>
  </div>
</div>

<script>
const $=(q,el=document)=>el.querySelector(q);
let TOKEN = localStorage.getItem("EFX_TOKEN") || null;

function ensureAuth(){
  if(!TOKEN){ $("#modalLogin").style.display="flex"; return false; }
  return true;
}
$("#btnLogin").onclick = async ()=>{
  const fd = new FormData();
  fd.append("username", $("#login_email").value);
  fd.append("password", $("#login_pass").value);
  const r = await fetch("/auth/login",{method:"POST",body:fd});
  if(!r.ok){ alert("Credenciales inválidas"); return; }
  const d = await r.json(); TOKEN=d.access_token; localStorage.setItem("EFX_TOKEN", TOKEN);
  $("#modalLogin").style.display="none";
  init();
};

function row(o){
  const dl = o.download_ready ? `<a class="btn" href="/orders/${o.id}/download">Descargar</a>` : '<span class="muted">No disponible</span>';
  const ck = o.status==='pending_payment'
    ? `<a class="btn" href="/static/checkout.html?order_id=${o.id}">Ir a pagar</a>`
    : '';
  return `<tr>
    <td>${o.id}</td>
    <td><span class="badge">${o.status}</span></td>
    <td>${o.patch_option_id}</td>
    <td>${o.original_filename || '—'}</td>
    <td>${o.created_at}</td>
    <td>${dl}</td>
    <td class="actions">${ck}</td>
  </tr>`;
}

async function init(){
  if(!ensureAuth()) return;
  $("#status").textContent = "Cargando…";
  try{
    const r = await fetch("/orders/mine",{headers:{Authorization:"Bearer "+TOKEN}});
    if(!r.ok){ $("#status").textContent="No se pudieron cargar las órdenes"; return; }
    const d = await r.json();
    const tb = $("#tbody"); tb.innerHTML = "";
    (d.orders||[]).forEach(o => tb.insertAdjacentHTML("beforeend", row(o)));
    $("#tbl").style.display = "";
    $("#status").textContent = (d.orders||[]).length ? "" : "No tienes órdenes aún.";
  }catch(e){
    $("#status").textContent="Error cargando.";
  }
}
init();
</script>
</body>
</html>
