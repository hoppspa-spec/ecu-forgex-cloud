<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ECU FORGE X ‚Äî Usuarios</title>

  <link rel="stylesheet" href="/static/css/base.css">
  <link rel="stylesheet" href="/static/css/efx.css">
  <script src="/static/js/theme.js"></script>

  <style>
    /* Botones header chicos y pro (igual que checkout) */
    .efx-topbar .btn{ width:auto; padding:6px 12px; font-size:13px; }
    .efx-topbar .btn.icon{ padding:6px 10px; }
    .efx-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .page{ max-width:1100px; margin:16px auto; padding:0 16px; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }
    .hidden{ display:none !important; }

    .card h2{ margin:0 0 10px; }
    .muted{ opacity:.8; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    /* Formularios */
    label{ display:block; font-size:13px; margin-top:10px; opacity:.8; }
    input{ width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background: rgba(255,255,255,.06); color: inherit; }
    .help{ margin:10px 0 0; padding-left:18px; }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.18); font-size:12px; opacity:.9; }

    /* Tabla √≥rdenes */
    table{ width:100%; border-collapse: collapse; margin-top:10px; }
    th,td{ border-bottom:1px solid rgba(255,255,255,.12); padding:8px; text-align:left; font-size:14px; }
    code{ font-family: ui-monospace, Menlo, Consolas, monospace; font-size: 12px; }
  </style>
</head>

<body>
<header class="efx-topbar">
  <div class="brand">ECU FORGE X</div>

  <div class="efx-actions">
    <button id="btnLogin" class="btn" type="button"
      onclick="location.href='/static/usuarios.html#login?next='+encodeURIComponent(location.search?location.href:location.href)">
      Iniciar sesi√≥n
    </button>

    <button id="btnRegister" class="btn" type="button"
      onclick="location.href='/static/usuarios.html#register?next='+encodeURIComponent(location.href)">
      Registro
    </button>

    <button class="btn icon" type="button" onclick="EFX.toggleTheme()" title="Dark / Light">üåô / ‚òÄÔ∏è</button>

    <button id="btnLogout" class="btn" type="button" style="display:none">Cerrar sesi√≥n</button>

    <a class="btn" href="/static/index.html" style="text-decoration:none">Subir BIN</a>
    <a class="btn" href="/static/catalogo.html" style="text-decoration:none">Cat√°logo</a>
  </div>
</header>

<div class="page">

  <!-- ===== LOGIN ===== -->
  <div id="viewLogin" class="card hidden">
    <h2>Iniciar sesi√≥n</h2>
    <div class="muted">Login m√≠nimo real v√≠a <code>POST /token</code> (FastAPI OAuth2).</div>

    <label>Email</label>
    <input id="loginEmail" type="email" placeholder="tu@correo.com" autocomplete="email"/>

    <label>Contrase√±a</label>
    <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/>

    <div class="row" style="margin-top:14px">
      <button id="btnDoLogin" class="btn" type="button">Entrar</button>
      <button class="btn" type="button" onclick="location.href='#register'">Crear cuenta</button>
      <span id="loginMsg" class="muted"></span>
    </div>

    <ul class="help">
      <li>Si ven√≠as desde checkout, te devuelve autom√°ticamente con <span class="pill">next</span>.</li>
    </ul>
  </div>

  <!-- ===== REGISTER ===== -->
  <div id="viewRegister" class="card hidden">
    <h2>Registro</h2>
    <div class="muted">
      Intento de registro v√≠a <code>POST /auth/register</code>.  
      Si tu backend a√∫n no lo tiene, no rompe nada: te avisa.
    </div>

    <label>Email</label>
    <input id="regEmail" type="email" placeholder="tu@correo.com" autocomplete="email"/>

    <label>Contrase√±a</label>
    <input id="regPass" type="password" placeholder="m√≠n. 6-8 caracteres" autocomplete="new-password"/>

    <div class="row" style="margin-top:14px">
      <button id="btnDoRegister" class="btn" type="button">Crear cuenta</button>
      <button class="btn" type="button" onclick="location.href='#login'">Ya tengo cuenta</button>
      <span id="regMsg" class="muted"></span>
    </div>

    <ul class="help">
      <li>Para V1: registro + login directo (sin email confirm) suele convertir mejor.</li>
    </ul>
  </div>

  <!-- ===== √ìRDENES ===== -->
  <div id="viewOrders" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">Mis √≥rdenes</h2>
      <div class="row">
        <button class="btn" id="flt_all" type="button">Todas</button>
        <button class="btn" id="flt_pending" type="button">Pendientes</button>
        <button class="btn" id="flt_done" type="button">Completadas</button>
      </div>
    </div>

    <div id="ordersStatus" class="muted" style="margin-top:10px">Cargando‚Ä¶</div>

    <div style="overflow:auto">
      <table id="tbl" class="hidden">
        <thead>
          <tr>
            <th>ID</th><th>Estado</th><th>Parche</th><th>Archivo</th><th>Fecha</th><th>Descarga</th><th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="muted" style="margin-top:10px">
      Endpoint esperado: <code>GET /orders/mine</code> (Bearer token).
    </div>
  </div>

</div>

<script>
/* =========================================================
   ‚úÖ AUTH INLINE (igual filosof√≠a que checkout)
========================================================= */
(function () {
  const TOKEN_KEYS = ["EFX_TOKEN","token","access_token","jwt"];

  function getToken(){
    for (const k of TOKEN_KEYS){
      const v = localStorage.getItem(k) || sessionStorage.getItem(k);
      if (v && String(v).trim()) return String(v).trim();
    }
    return null;
  }
  function setToken(token, persist=true){
    if (persist) localStorage.setItem("EFX_TOKEN", token);
    else sessionStorage.setItem("EFX_TOKEN", token);
  }
  function clearToken(){
    for (const k of TOKEN_KEYS){
      localStorage.removeItem(k);
      sessionStorage.removeItem(k);
    }
  }
  function isLoggedIn(){ return !!getToken(); }

  function parseNextFromHash(){
    // soporta #login?next=... y #register?next=...
    const h = location.hash || "";
    const qPos = h.indexOf("?");
    if (qPos === -1) return null;
    const qs = h.slice(qPos+1);
    try{
      const p = new URLSearchParams(qs);
      return p.get("next");
    }catch{return null;}
  }

  function requireLogin(nextUrl){
    const next = encodeURIComponent(nextUrl || location.href);
    location.href = "/static/usuarios.html#login?next=" + next;
  }

  function applyHeaderAuth(){
    const btnLogin = document.getElementById("btnLogin");
    const btnReg   = document.getElementById("btnRegister");
    const btnOut   = document.getElementById("btnLogout");

    const logged = isLoggedIn();
    if (btnLogin) btnLogin.style.display = logged ? "none" : "inline-block";
    if (btnReg)   btnReg.style.display   = logged ? "none" : "inline-block";
    if (btnOut)   btnOut.style.display   = logged ? "inline-block" : "none";

    if (btnOut && !btnOut.dataset.bound){
      btnOut.dataset.bound = "1";
      btnOut.addEventListener("click", () => {
        clearToken();
        route(); // refresca vista
      });
    }
  }

  window.EFX = window.EFX || {};
  window.EFX.getToken = getToken;
  window.EFX.setToken = setToken;
  window.EFX.clearToken = clearToken;
  window.EFX.isLoggedIn = isLoggedIn;
  window.EFX.requireLogin = requireLogin;
  window.EFX.applyHeaderAuth = applyHeaderAuth;
  if (!window.EFX.toggleTheme){
    window.EFX.toggleTheme = function(){ document.documentElement.classList.toggle("dark"); };
  }
})();
</script>

<script>
/* =========================================================
   Router simple por hash + √≥rdenes
========================================================= */
const $ = (q,el=document)=>el.querySelector(q);
const nf = new Intl.DateTimeFormat('es-CL',{dateStyle:'short',timeStyle:'short'});
let ORDERS_CACHE = [];

function show(id){
  ["viewLogin","viewRegister","viewOrders"].forEach(v=>{
    const el = document.getElementById(v);
    if(!el) return;
    el.classList.toggle("hidden", v !== id);
  });
}

function hashBase(){
  const h = (location.hash || "#orders").replace("#","");
  return h.split("?")[0].toLowerCase();
}

function row(o){
  const st = (o.status || "").toLowerCase();

  const canDownload = !!o.download_ready && (st==="paid" || st==="done");
  const dl = canDownload ? `<a class="btn" href="/download/${o.id}" style="text-decoration:none">Descargar</a>` : "‚Äî";

  const goPay = (st==="pending_payment" || st==="pending") ? `<a class="btn" href="/static/checkout.html?order_id=${o.id}" style="text-decoration:none">Ir a pagar</a>` : "‚Äî";

  const when = o.created_at ? nf.format(new Date(o.created_at)) : "‚Äî";

  return `<tr>
    <td>${o.id}</td>
    <td>${o.status || "‚Äî"}</td>
    <td>${o.patch_option_id || "‚Äî"}</td>
    <td>${o.original_filename || "‚Äî"}</td>
    <td>${when}</td>
    <td>${dl}</td>
    <td>${goPay}</td>
  </tr>`;
}

function applyFilter(kind){
  const tb=$("#tbody"); tb.innerHTML="";
  const list = ORDERS_CACHE.filter(o=>{
    const st=(o.status||"").toLowerCase();
    if(kind==="pending") return (st==="pending_payment" || st==="pending");
    if(kind==="done") return (st==="paid" || st==="done");
    return true;
  });
  list.forEach(o=>tb.insertAdjacentHTML("beforeend", row(o)));
  $("#ordersStatus").textContent = list.length ? "" : "Sin resultados.";
}

async function loadOrders(){
  $("#ordersStatus").textContent = "Cargando‚Ä¶";
  $("#tbl").classList.add("hidden");

  if(!EFX.isLoggedIn()){
    $("#ordersStatus").textContent = "Debes iniciar sesi√≥n para ver tus √≥rdenes.";
    return;
  }

  try{
    const r = await fetch("/orders/mine", {
      headers: { "Authorization": "Bearer " + EFX.getToken() }
    });

    if(!r.ok){
      const t = await r.text().catch(()=>"(sin detalle)");
      $("#ordersStatus").textContent =
        "No se pudieron cargar las √≥rdenes. " +
        (r.status===404 ? "Endpoint /orders/mine no existe a√∫n." : t);
      return;
    }

    const d = await r.json();
    ORDERS_CACHE = d.orders || [];
    $("#tbl").classList.remove("hidden");
    applyFilter("all");
  }catch{
    $("#ordersStatus").textContent = "Error de red cargando √≥rdenes.";
  }
}

async function doLogin(){
  const email = ($("#loginEmail").value || "").trim();
  const pass  = ($("#loginPass").value || "").trim();
  const msg = $("#loginMsg");
  msg.textContent = "";

  if(!email || !pass){
    msg.textContent = "Completa email y contrase√±a.";
    return;
  }

  msg.textContent = "Ingresando‚Ä¶";

  try{
    // FastAPI OAuth2PasswordRequestForm => x-www-form-urlencoded
    const body = new URLSearchParams();
    body.set("username", email);
    body.set("password", pass);

    const r = await fetch("/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body
    });

    if(!r.ok){
      const t = await r.text().catch(()=>"(sin detalle)");
      msg.textContent = "Login fall√≥: " + t;
      return;
    }

    const d = await r.json();
    const token = d.access_token || d.token || d.jwt;
    if(!token){
      msg.textContent = "Login OK, pero no lleg√≥ access_token.";
      return;
    }

    EFX.setToken(token, true);
    EFX.applyHeaderAuth();

    // vuelve a next si existe
    const next = (function(){
      const h = location.hash || "";
      const qPos = h.indexOf("?");
      if(qPos === -1) return null;
      const p = new URLSearchParams(h.slice(qPos+1));
      return p.get("next");
    })();

    if(next){
      location.href = next;
      return;
    }

    location.hash = "#orders";
    route();
  }catch{
    msg.textContent = "Error de red en login.";
  }
}

async function doRegister(){
  const email = ($("#regEmail").value || "").trim();
  const pass  = ($("#regPass").value || "").trim();
  const msg = $("#regMsg");
  msg.textContent = "";

  if(!email || !pass){
    msg.textContent = "Completa email y contrase√±a.";
    return;
  }

  msg.textContent = "Creando cuenta‚Ä¶";

  try{
    const r = await fetch("/auth/register", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ email, password: pass })
    });

    if(!r.ok){
      const t = await r.text().catch(()=>"(sin detalle)");
      msg.textContent = (r.status===404)
        ? "Backend a√∫n no tiene /auth/register. (Lo implementamos en 5 min cuando quieras)."
        : ("Registro fall√≥: " + t);
      return;
    }

    msg.textContent = "Cuenta creada ‚úÖ Ahora inicia sesi√≥n.";
    location.hash = "#login";
    route();
  }catch{
    msg.textContent = "Error de red en registro.";
  }
}

function route(){
  EFX.applyHeaderAuth();

  const h = hashBase();

  if(h === "register"){
    show("viewRegister");
    return;
  }

  if(h === "login"){
    show("viewLogin");
    return;
  }

  // default: orders
  show("viewOrders");
  loadOrders();
}

document.addEventListener("DOMContentLoaded", () => {
  $("#btnDoLogin").onclick = doLogin;
  $("#btnDoRegister").onclick = doRegister;

  $("#flt_all").onclick = ()=>applyFilter("all");
  $("#flt_pending").onclick = ()=>applyFilter("pending");
  $("#flt_done").onclick = ()=>applyFilter("done");

  window.addEventListener("hashchange", route);
  route();
});
</script>
</body>
</html>
